<style>
	.security-notice__view::-webkit-scrollbar {
		width: 6px;
		background-color: #eee;
	}
	 
	.security-notice__view::-webkit-scrollbar-thumb {
		background-color: #c1c1c1;
	}
	 
	.security-notice__view {
		scrollbar-width: thin;
		scrollbar-color: #c1c1c1 #eee;
	}
	.security-notice__view{
			height: 600px;
	}
	
	.security-notice__view .bt_table .btswitch+.btswitch-btn{
			width: 2.8rem;
			height: 1.75rem;
	}
	#sn-site__log--table .divtable .table thead th,
	.security-notice__view .divtable .table thead th{
			font-size: 14px;
			padding: 10px;
	}
	
	#sn-site__log--table .table>tbody>tr>td,
	.security-notice__view .table>tbody>tr>td{
			font-size: 12px;
			padding: 10px;
	}
	
	#sn-site__log--table .bt_table > .divtable,
	.security-notice__view .bt_table > .divtable{
			border: 0.5px solid #efefef;
	}
	.sn-menu__header{
			height: 600px;
			width: 120px;
			background: #f8f8f8;
			float: left;
	}
	.sn-menu__header li{
			height: 50px;
			line-height: 50px;
			cursor: pointer;
			padding-left: 15px;
	}
	.sn-menu__header li.active{
			background: #F1F9F3;
			position: relative;
	}
	.sn-menu__header li.active::after{
			content: "";
			position: absolute;
			top: 0;
			left: 0;
			width: 2px;
			height: 100%;
			border-left: 2px solid #20a53a;
	}
	.sn-menu__header li p{
			color: #666;
			display: inline-block
	}
	.sn-menu__header li.active p{
			color: #20a53a;
			font-weight: bold;
	}
	.sn-menu__header i {
			background-image: url(/security_notice/static/img/nav-icon-default.svg);
			display: inline-block;
			width: 20px;
			height: 20px;
			vertical-align: sub;
			margin-right: 3px;
	}
	.sn-menu__header li:nth-child(2) i{background-position: 0 -40px;}
	.sn-menu__header li:nth-child(3) i{background-position: 0 -84px;}
	.sn-menu__header li:nth-child(4) i{background-position: 0 -20px;}
	.sn-menu__header li:nth-child(5) i{background-position: 0 -63px;}
	.sn-menu__header li:nth-child(6) i{background-position: 0 -105px;}
	
	.sn-menu__header li.active i{
			background-image: url(/security_notice/static/img/nav-icon-green.svg);
	}
	
	.sn-menu__header li.active:nth-child(2) i{background-position: 0 -40px;}
	.sn-menu__header li.active:nth-child(3) i{background-position: 0 -84px;}
	.sn-menu__header li.active:nth-child(4) i{background-position: 0 -20px;}
	.sn-menu__header li.active:nth-child(5) i{background-position: 0 -63px;}
	.sn-menu__header li.active:nth-child(6) i{background-position: 0 -105px;}
	
	.sn-body__content{
			padding: 26px;
			margin-left: 120px;
			height:100%;
			position: relative;
	}
	.sn-panel{
			display: none;
	}
	.sn-panel.is-active{
			display: block;
	}
	.security-notice__view .mtb10,
	#sn-site__log--table .mtb10{margin:0}
	
	#sn-site__log--table .mtb10,#sn-table--alarmList .mtb10{margin-bottom:10px}
	.mt20 {
			margin-top: 20px;
	}
	.divpre {
			overflow: auto;
			padding: 9.5px;
			max-height: 75pt;
			border: 1px solid #ddd;
			border-radius: 4px;
			background-color: #f6f6f6;
			color: #333;
			word-wrap: break-word;
			font-size: 13px;
			line-height: 1.42857143;
			word-break: break-all;
	}
	.security-notice__view .sn-input--style{
			height: 30px;
			border: 1px solid #e8e8e8;
			padding-left: 10px;
			border-radius: 2px;
	}
	.security-notice__view .sn-footer,.sn-site__config .sn-footer{
			position: absolute;
			bottom: 15px;
	}
	.sn-test--line .sn-test--title{
			font-size: 14px;
			margin-bottom: 10px;
	}
	/* 首页 */
	.sn-home--switch{
			position: relative;
			font-size: 14px;
			height: 42px;
			line-height: 42px;
			margin-bottom: 10px;
	}
	.sn-home-risk--list{
			height: 296px;
			overflow: auto;
			border: 1px solid #EFEFEF;
			border-radius: 4px;
	}
	.sn-home-risk--item .sn-home-risk--type span {
			padding: 5px 10px;
			display: inline-block;
			border-radius: 2px;
			height: 25px;
			line-height: 15px;
			margin-top: 8px;
	}
	
	/* 首页未开启 */
	.default-font__style{
			color:#999
	}
	
	.sn-home--overview {
			border-radius: 4px;
			border: 1px solid #EFEFEF;
			padding: 15px;
			margin-bottom: 25px;
			height: 140px;
	}
	.sn-home--overview-title {
			font-size: 14px;
			color: #666;
	}
	.sn-home--overview-item {
			display: inline-block;
			padding-top: 20px;
			width: 135px;
			text-align: center;
			position: relative;
	}
	.sn-home--overview-item--title {
			font-size: 16px;
	}
	.sn-home--overview-item--num {
			font-size: 26px;
			font-weight: bold;
			margin-top: 10px;
	}
	
	.sn-home--overview-item--upNum {
			font-size: 14px;
			font-weight: normal;
			color: #F50606;
	}
	.sn-home--overview-item--upNum::before{
			content:'↑';
			color: #F50606;
	}
	
	.sn-home--overview-item:nth-child(1) .sn-home--overview-item--num{
			color: #F50606;
	}
	.sn-home--overview-item:nth-child(2) .sn-home--overview-item--num{
			color: #FF9900;
	}
	.sn-home--overview-item:nth-child(3) .sn-home--overview-item--num{
			color: #DDC400;
	} 
	.sn-home--overview-item.line-border::after{
			content: '';
			border-right: 1px solid #DCDCDC;
			position: absolute;
			right: 0;
			top: 30px;
			height: 48px;
	}
	.sn-home--overview.sn-home--overview-red{
			background: linear-gradient(to bottom,rgba(255, 229, 224, 0.60),rgba(254, 234, 230, 0.12));
	}
	.sn-home--overview.sn-home--overview-yellow{
			background: linear-gradient(to bottom,rgba(255, 237, 211, 0.60),rgba(254, 249, 246, 0.77));
	}
	.sn-home--overview.sn-home--overview-green{
			background: linear-gradient(to bottom,rgba(233, 253, 238, 0.60),rgba(252, 254, 253, 1.00));
	}
	
	.sn-home-risk--item {
			display: flex;
			justify-content: space-between;
			height: 42px;
			line-height: 42px;
			color:#999;
			padding: 0 10px;
			border-bottom: 1px solid #EFEFEF;
	}
	.sn-home-risk--item.risk-active,
	.sn-home-risk--item :hover{
			background-color: #f5f5f5;
	}
	.sn-home-risk--type {
			width: 115px;
	}
	.sn-home-risk--site,
	.sn-home-risk--name {
			width: 160px;
	}
	.sn-home-risk--item.risk--item-high .sn-home-risk--type span{
			background: #FEF5F3;
			color:#EA2C2C
	}
	.sn-home-risk--item.risk--item-mod .sn-home-risk--type span{
			background: #FEF6EF;
			color:#FF9900
	}
	.sn-home-risk--item.risk--item-low .sn-home-risk--type span{
			background: #F7FEF9;
			color:#20A53A
	}
	.sn-home--important-note  {
			border: 1px solid #20a53a;
			border-radius: 8px;
			cursor: help;
			display: inline-block;
			font-family: arial;
			font-size: 11px;
			font-style: normal;
			height: 16px;
			line-height: 16px;
			margin-right: 5px;
			text-align: center;
			width: 16px;
	}
	.sn-home-risk--item.risk--item-mod .sn-home-risk--type i{
			border: 1px solid #FF9900;
	}
	.sn-home-risk--item.risk--item-high .sn-home-risk--type i{
			border: 1px solid #EA2C2C;
	}
	.sn-home-risk--numtips {
			color: #C1C1C1;
			margin-top: 10px;
	}
	.sn-home--open-condition {
			display: inline-block;
			color: #E6A23C;
			background: #FDF6EC;
			width: 608px;
			height: 30px;
			line-height: 30px;
			padding: 0 10px;
			border-radius: 2px;
			position: absolute;
			top: 4px;
			left: 120px;
	}
	.sn-home--open-condition i{border-color:#E6A23C}
	.sn-home--open-condition span{
			text-decoration: underline;
			cursor: pointer;
			color: #EA2C2C;
	}
	
	.sn-home-risk--dialog{
			position: fixed;
			padding: 10px 10px 5px 10px;
			box-shadow: 0 0 5px 2px #ececec;
			background-color: #fff;
			color:#999;
			width: 260px;
			display: none;
	}
	.sn-home-dialog--title {
			margin-bottom: 10px;
	}
	.sn-home-risk--dialog span{
			color:#666
	}
	.sn-home-dialog--content {
			padding-left: 5px;
			line-height: 22px;
	}
	.sn-dialog-content::-webkit-scrollbar {
		width: 6px;
		background-color: #eee;
	}
	 
	.sn-dialog-content::-webkit-scrollbar-thumb {
		background-color: #c1c1c1;
	}
	 
	.sn-dialog-content {
		scrollbar-width: thin;
		scrollbar-color: #c1c1c1 #eee;
	}
	.sn-dialog-content{
			max-height: 100px;
			overflow: auto;
			word-break: break-all;
	}
	
	.sn-risk--no-data {
			display: flex;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			color: #666;
			height: 250px;
	}
	.sn-risk--no-data img{
			width: 160px;
			height: 160px;
	}
	/* 首页 end */
	
	/* 白名单 */
	.sn-white--tabs .sn-white--tabs__ul{
			font-size: 0;
			border-bottom: 1px solid #E8E8E8;
			margin-bottom: 25px;
	}
	.sn-white--tabs .sn-white--tabs__ul li{
			height: 36px;
			line-height: 36px;
			padding: 0 18px;
			color: #666;
			display: inline-block;
			cursor: pointer;
			position: relative;
			bottom: -1px;
			border: 1px solid transparent;
			font-size: 14px;
	}
	.sn-white--tabs .sn-white--tabs__ul li.sn-white--tab--active{
			color: #20a53a;
			border: 1px solid #E8E8E8;
			border-bottom: 1px solid #fff;
			border-top-left-radius: 4px;
			border-top-right-radius: 4px;
			position: relative;
	}
	.sn-white__view{
			width: 100%;
			display: none;
	}
	/* 白名单 end */
	
	/* 告警设置 */
	.sn-test--list,
	.sn-alarm--list{
			display:none;
			position: absolute;
			background: #fff;
			z-index: 10;
			transition: all 500ms;
			top: 30px;
			left: 60px;
			box-shadow: 0 1px 5px rgb(0 0 0 / 50%);
			border-radius: 1px;
			width: 140px;
	}
	.sn-test--list{
			max-height: 140px;
			overflow: auto;
	}
	.sn-test--list li,
	.sn-alarm--list li {
			height: 28px;
			line-height: 24px;
			padding: 2px 10px;
			white-space: nowrap;
	}
	.sn-test--list li:hover,
	.sn-alarm--list li:hover {
			background-color: #f2f2f2;
	}
	.sn-test--list li.active,
	.sn-alarm--list li.active {
			color: #fff;
			background-color: #20a53a;
	}
	.sn-test--content,
	.sn-alarm--setting{
			font-size: 12px;
			color: #666;
			margin-bottom: 25px;
			position: relative;
	}
	.sn-alarm--setting{
			margin-bottom: 16px;
	}
	.sn-test--selectBox,
	.sn-alarm--selectBox{
			display: inline-block;
			cursor: pointer;
	}
	.sn-test--selectBox .sn-test--channel,
	.sn-alarm--setting .sn-alarm--channel{
			border:1px solid #EFEFEF;
			border-radius: 2px;
			color: #999999;
			width: 140px;
			display: inline-block;
			padding:5px 5px 5px 10px;
			margin-left:4px
	}
	.sn-test--selectIcon,
	.sn-alram--selectIcon{
			color: #999;
			position: absolute;
			top: 8px;
			left: 175px;
	}
	.bt-form-new.inline {
		align-items: center;
		flex: 1;
		justify-content: flex-start;
	}
	.form-item .form-label{
		padding-right: 8px;
	}
	.bt-form-new.inline .form-item{
		margin-left: 0 !important;
		margin-right: 14px;
	}
	.sn-alarm--mode {
		display: flex;
		align-items: baseline;
		margin-bottom: 25px;
	}
	.sn-alarm--mode .bterror {
		color: #f50606;
	}
	/* 告警设置 end */ 
	</style>
	
	<div class="security-notice__view">
			<div class="sn-menu__header">
					<ul>
							<li class="active"><i></i><p>首页</p></li>
							<li><i></i><p>网站管理</p></li>
							<li><i></i><p>木马隔离箱</p></li>
							<li><i></i><p>白名单</p></li>
							<li><i></i><p>PHP模块</p></li>
							<li><i></i><p>告警设置</p></li>
					</ul>
			</div>
			<div class="sn-body__content">
					<div class="sn-panel is-active">
							<!-- 监控开关 -->
							<div class="sn-home--switch">
									<span>监控开关</span>
									<div style="display: inline-block;vertical-align: middle;margin-left:5px;">
											<input type="checkbox" class="btswitch btswitch-ios" id="serviceStatus">
											<label class="btswitch-btn serviceStatus" for="serviceStatus"></label>
									</div>
									<div class="sn-home--open-condition hide"></div>
									<button type="button" class="btn btn-success btn-sm pull-right testAttack hide">模拟攻击</button>
							</div>
							<div class="sn-home--overview">
									<div class="sn-home--overview-title">风险等级概览</div>
									<div class="sn-home--overview-content">
											<div class="sn-home--overview-item line-border">
													<div class="sn-home--overview-item--title">高风险</div>
													<div class="sn-home--overview-item--num">
															<span class="sn-home--overview-total">0</span>
															<span class="sn-home--overview-item--upNum hide"></span>
													</div>
											</div>
											<div class="sn-home--overview-item line-border">
													<div class="sn-home--overview-item--title">中危</div>
													<div class="sn-home--overview-item--num">
															<span class="sn-home--overview-total">0</span>
															<span class="sn-home--overview-item--upNum hide"></span>
													</div>
											</div>
											<div class="sn-home--overview-item line-border">
													<div class="sn-home--overview-item--title">低危</div>
													<div class="sn-home--overview-item--num">
															<span class="sn-home--overview-total">0</span>
															<span class="sn-home--overview-item--upNum hide"></span>
													</div>
											</div>
											<div class="sn-home--overview-item">
													<div class="sn-home--overview-item--title">网站数量</div>
													<div class="sn-home--overview-item--num">0</div>
											</div>
											<div class="sn-home--overview-item">
													<div class="sn-home--overview-item--title">告警次数</div>
													<div class="sn-home--overview-item--num">0</div>
											</div>
									</div>
							</div> 
							<!-- 风险列表 -->
							<div class="sn-home-risk">
									<div class="sn-home-risk--list"></div>
									<p class="sn-home-risk--numtips">以上仅提供最新的前100条风险数据</p>
									<div class="sn-home-risk--dialog"></div>
							</div>
					</div>
					<div class="sn-panel">
							<!-- 网站列表 -->
							<div id="sn-table--siteList"></div>
							<div class="sn-footer">
								<ul class="help-info-text c7">
										<li>安全告警默认会监视当前网站访问非当前网站文件的行为(例：你的站点A.com访问了站点B.com的文件或者目录)，通过添加监视器路径，当路径被访问时发送告警</li>
								</ul>
							</div>
					</div>
					<div class="sn-panel">
							<!-- 木马隔离箱列表 -->
							<div id="sn-table--isolationList"></div>
							<div class="sn-footer">
									<!-- 功能说明 -->
									<ul class="help-info-text c7">
											<li>隔离箱是指将被感染的文件隔离到隔离箱中，隔离箱中的文件不会影响网站正常运行。</li>
											<li>隔离箱中的文件可以通过隔离箱管理功能进行查看、删除、恢复等操作。</li>
									</ul>
							</div>
					</div>
					<div class="sn-panel">
							<div class="sn-white--tabs">
									<!-- 白名单Tabs -->
									<ul class="sn-white--tabs__ul">
											<li class="sn-white--tab--active">URL白名单</li>
											<li>IP白名单</li>
									</ul>
									<!-- 白名单内容 -->
									<div class="sn-white--tab--content">
											<!-- URL白名单 -->
											<div class="sn-white__view sn-white--url show">
													<!-- URL白名单操作 -->
													<div class="sn-white--url--operate" style="margin-bottom: 25px;">
															<div class="sn-white--url--add">
																	<input type="text" class="sn-input--style" placeholder="URL地址，例如：/admin/update" style="width:300px">
																	<button type="button" class="btn btn-success btn-sm mr5 add_white">添加</button>
															</div>
													</div>
													<!-- URL白名单列表 -->
													<div id="sn-table--urlList"></div>
													<div class="sn-footer">
															<button type="button" class="btn btn-default btn-sm mt10 empty_white">清空</button>
															<!-- 功能说明 -->
															<ul class="help-info-text c7" style="font-size: 12px;">
																	<li>例子1: bt.cn/admin/admin.php?system=abc 添加地址: ^/admin/admin.php</li>
																	<li>例子2: bt.cn/admin/1 1 为可变 1-99 添加地址为: ^/admin/[1-99]</li>
															</ul>
													</div>
											</div>
											<!-- IP白名单 -->
											<div class="sn-white__view sn-white--ip">
													<!-- IP白名单操作 -->
													<div class="sn-white--ip--operate" style="margin-bottom: 25px;">
															<div class="sn-white--ip--add">
																	<input type="text" class="sn-input--style" placeholder="起始IP地址" style="width:250px">
																	<input type="text" class="sn-input--style" placeholder="结束IP地址" style="width:250px">
																	<button type="button" class="btn btn-success btn-sm mr5 add_white">添加</button>
															</div>
													</div>
													<!-- IP白名单列表 -->
													<div id="sn-table--ipList"></div>
													<div class="sn-footer">
															<button type="button" class="btn btn-default btn-sm mt10 empty_white">清空</button>
															<!-- IP白名单说明 -->
															<ul class="help-info-text c7" style="font-size: 12px;">
																	<li>添加某个IP：起始IP为192.168.10.6 结束IP为192.168.10.6</li>
																	<li>添加IP段：起始IP为192.168.1.1 结束IP为192.168.1.254</li>
															</ul>
													</div>
											</div>
									</div>
							</div>
					</div>
					<div class="sn-panel">
							<!-- php模块列表 -->
							<div id="sn-table--phpList"></div>
					</div> 
					<div class="sn-panel">
							<div class="sn-alarm--setting">
									<span>告警方式</span>
									<div class="sn-alarm--selectBox">
											<span class="sn-alarm--channel">请选择告警方式</span>   
											<i class="sn-alram--selectIcon glyphicon glyphicon-menu-down"></i>
											<ul class="sn-alarm--list"></ul> 
									</div>
							</div>
							<!-- <div class="sn-alarm--mode">
								<span class="mr10">告警方式：</span>
								<div class="bt-form-new inline"></div>
							</div> -->
							<!-- 告警列表 -->
							<div id="sn-table--alarmList"></div>
					</div>
			</div>
	</div>
	
	<script>
	var securityNotice = {
			plugin_name:'security_notice',
			// 全局变量、状态
			data:{
					menuActive:0,   //菜单选中项、内容区域
					tabsWhiteActive:0,  //白名单Tabs选中项
					homeRiskList:[],    //首页风险列表
					serviceStatus:false,    //监控开关状态
					phpStatus:false,    //php模块状态
					sendStatus:false,   //告警通道状态
			},
			ajaxList:{
					'start_service':'设置监控状态',
					'get_notice':'检测高危风险',
					'get_send_config':'获取告警通道',
					'set_send':'设置告警通道',
					'get_send_logs':'获取告警记录',
					'set_php_status':'设置php模块状态',
					'start_site':'开启网站安全告警',
					'stop_site':'关闭网站安全告警',
					'get_domain_logs':'获取网站安全告警记录',
					'add_ip_white':'添加IP白名单',
					'add_url_white':'添加URL白名单',
					'Re_Recycle_bin':'恢复隔离箱文件',
					'Del_Recycle_bin':'删除隔离箱文件',
					'get_overall_info':'获取白名单列表',
					'remove_ip_white':'删除IP白名单',
					'remove_url_white':'删除URL白名单',
					'wubao_url_white':'添加URL误报',
					'set_ignore':'设置已处理',
					'empty_info':'清空白名单',
					'attack':'模拟攻击,预计等待一分钟'
			},
			// 事件
			event: function(){
					var _this = this;
					// 菜单切换
					$('.sn-menu__header li').on('click',function(){
							var index = $(this).index();
							_this.data.menuActive = index;
							$('.sn-body__content').removeAttr('style')
							$(this).addClass('active').siblings().removeClass('active')
							$('.sn-panel').eq(index).addClass('is-active').siblings().removeClass('is-active')
							switch(index){
									case 0: //首页
											//获取服务状态
											_this.http({
													tips: '正在获取监控状态,请稍侯...',
													method: 'get_status',
													check: true,
													success: function (res) {
															_this.data.serviceStatus = res.php_status && res.send ? res.status : false;
															_this.data.phpStatus = res.php_status;
															_this.data.sendStatus = res.send;
	
															$('#serviceStatus').prop('checked',_this.data.serviceStatus)
															// 概览样式判断
															if(!_this.data.serviceStatus){
																$('.sn-home--overview').addClass('default-font__style')
																$('.testAttack').addClass('hide')
															}else{
																$('.testAttack').removeClass('hide')
																if(!res.php_status || !res.send) $('.testAttack').addClass('hide')
															}
															if(!res.php_status || !res.send){
																$('.sn-home--open-condition').removeClass('hide').html('<i class="sn-home--important-note">!</i>无法使用php安全告警，请开启'+ (res.php_status ? '' : '<span data-index="4">PHP模块</span>')+ (!res.php_status && !res.send ? '、' : '') + (res.send ? '' : '<span data-index="5">设置告警</span>' ))
															}else{
																$('.sn-home--open-condition').addClass('hide')
															}
													},
											});
											_this.getHomeData();
											$('.sn-body__content').css('padding-top','10px')
											break;
									case 1: //网站管理
											_this.getSiteList();
											break;
									case 2: //木马隔离箱
											_this.getIsolationList();
											break;
									case 3: //白名单
											_this.getWhiteList();
											break;
									case 4: //php模块
											_this.getPhpList();
											break;
									case 5: //告警设置
											_this.getAlarmSetting();
											_this.getAlarmList();
											break;
							}
					})
					// 监控开关
					$('#serviceStatus').on('change',function(){
							var _status = $(this).prop('checked');
							if(!_this.data.serviceStatus && (!_this.data.phpStatus || !_this.data.sendStatus)) {
								layer.tips('请先开启'+ (!_this.data.phpStatus ? 'PHP模块' : '') + (!_this.data.phpStatus && !_this.data.sendStatus ? '和' : '') + (!_this.data.sendStatus ? '设置告警' : '') +'！', '.serviceStatus', {tips: [3, '#ff0000'],time: 3000})
								return $(this).prop('checked',false);
							}
							_this.ajaxTask('start_service',{status:_status?'start':'stop'},function(res){
									if(res.status && _status){
											$('.sn-home--overview').removeClass('default-font__style')
											$('.testAttack').removeClass('hide')
									}else{
											$('.testAttack').addClass('hide')
									}
									layer.msg(res.msg,{icon:res.status?1:2})
							})
					})
					// 模拟攻击
					$('.testAttack').on('click',function(){
							layer.open({
									type: 1,
									title: "模拟攻击",
									area: '420px',
									closeBtn: 2,
									shadeClose: false,
									content:'<div class="pd20">\
											<div class="sn-test--line">\
													<div class="sn-test--title">1.选择一个PHP版本进行模拟攻击（预计一分钟）</div>\
													<div class="sn-test--content">\
															<span>PHP版本</span>\
															<div class="sn-test--selectBox">\
																	<span class="sn-test--channel">请选择PHP版本</span>\
																	<i class="sn-test--selectIcon glyphicon glyphicon-menu-down"></i>\
																	<ul class="sn-test--list"></ul>\
															</div>\
															<button type="button" class="btn btn-success btn-sm goTestAttack">模拟攻击</button>\
													</div>\
											</div>\
											<div class="sn-test--line hide">\
													<div class="sn-test--title">2.手动模拟攻击:复制命令在终端中进行测试<span style="color:#666">（修改命令中的81可切换PHP版本）</span></div>\
													<div class="sn-test--content" style="margin-bottom: 0;">\
															<pre></pre>\
															<button type="button" class="btn btn-default btn-sm handCopy" data-clipboard-text="">复制</button>\
													</div>\
											</div>\
											<ul class="help-info-text c7"><li>模拟攻击不会影响业务的正常运行</li></ul>\
											</div>',
									success: function(layero, index){
										$(layero).find('.layui-layer-content').css('overflow','initial')
											var command = '/www/server/php/81/bin/php -d \'extension=security_notice.so\' -r "gethostbyname(\'test.www.dnslog.cn\');sleep(60);"'
											$('.sn-test--content pre').html(command);
											$('.handCopy').attr('data-clipboard-text', command);
	
											var clipboard = new ClipboardJS('.handCopy');
											clipboard.on('success', function (e) {
													bt.msg({status: true,msg: '复制成功！'});
													e.clearSelection();
											});
											clipboard.on('error', function (e) {
													bt.msg({status: false,msg: '复制失败，请手动复制地址'});
											});
	
											_this.ajaxTask('get_index',{},function(res){
													var _html = '';
													if(res.php_versions.length == 0){
															$('.sn-test--channel').html('没有安装PHP模块')
															$('.goTestAttack').removeClass('btn-success').addClass('btn-default').attr('disabled',true)
													}else{
															for(var i=0;i<res.php_versions.length;i++){
																	var item = res.php_versions[i];
																	_html += '<li class="sn-test--item" data-version="'+item.v+'">'+item.version+'</li>'
															}
													}
													
													$('.sn-test--list').html(_html);
													$('.sn-test--list li').on('click',function(){
															var _version = $(this).html();
															$(this).addClass('active').siblings().removeClass('active');
															$('.sn-test--channel').html(_version);
															$('.sn-test--list').hide();
													})
											})
											// 模拟攻击-开始
											$('.goTestAttack').on('click',function(){
													var _version = $('.sn-test--item.active').data('version');
													if($('.sn-test--item.active').length == 0){
															layer.msg('请选择PHP版本',{icon:2})
															return;
													}
													_this.ajaxTask('attack',{version:_version},function(res){
															if(res.status){
																	layer.close(index);
																	$(".sn-menu__header li").eq(0).click()
															}
															layer.msg(res.msg,{icon:res.status?1:2,time: 0,shade: [0.3, '#000'],closeBtn:1})
													})
											})
											// 告警方式选择
											$('.sn-test--selectBox').on('click',function(e){
													var _ul = $(this).find('.sn-test--list');
													if(_ul.hasClass('show')){
															_ul.removeClass('show');
													}else{
															_ul.addClass('show');
													}
													$(document).one('click',function(){
															_ul.removeClass('show');
													})
													e.stopPropagation();
											})
									}
							})
					})
					// 白名单Tabs切换
					$('.sn-white--tabs .sn-white--tabs__ul li').on('click',function(){
							var index = $(this).index();
							$(this).addClass('sn-white--tab--active').siblings().removeClass('sn-white--tab--active');
							$('.sn-white--tab--content .sn-white__view').eq(index).addClass('show').siblings().removeClass('show');
							_this.data.tabsWhiteActive = index;
							_this.getWhiteList();  //切换时重新获取数据
					})
					// 添加白名单[URL/IP]
					$('.sn-white__view .add_white').on('click',function(){
							var _api = 'add_url_white',_param = {}
							if(_this.data.tabsWhiteActive == 0){
									var _url = $('.sn-white--url--add input').val();
									if(_url == ''){
											layer.msg('URL地址不能为空',{icon:2});
											return false;
									}
									_param = {url_rule:_url}
							}else{
									_api = 'add_ip_white'
									var _ipStart = $('.sn-white--ip--add input').eq(0).val(),
											_ipEnd = $('.sn-white--ip--add input').eq(1).val();
									if(!bt.check_ip(_ipStart) || !bt.check_ip(_ipEnd)){
											layer.msg('IP地址格式不正确',{icon:2});
											return false;
									}
									_param = {start_ip:_ipStart,end_ip:_ipEnd}
							}
							_this.ajaxTask(_api,_param,function(res){
									layer.msg(res.msg,{icon:res.status?1:2});
									if(res.status) {
											_this.getWhiteList();
											$('.sn-white--ip--add,.sn-white--url--add').find('input').val('');   //清空输入框
									}
							})
					})
					
					// 清空白名单[URL/IP]
					$('.sn-white__view .empty_white').on('click',function(){
							layer.confirm('是否清空白名单列表？', { title: '清空'+(_this.data.tabsWhiteActive == 0 ?'URL':'IP')+'白名单', closeBtn: 2,icon:0}, function () {
									_this.ajaxTask('empty_info',{type:_this.data.tabsWhiteActive == 0?'url_white':'ip_white'},function(res){
											if(res.status) $('.sn-white--tab--active').click()   //刷新
											layer.msg(res.msg,{icon:res.status?1:2});
									});
							});
					})
					// 开启服务判断跳转
					$('.sn-home--open-condition').on('click','span',function(){
							var index = $(this).data('index')
							$(".sn-menu__header li").eq(index).click()
					})
					
					// 风险鼠标经过事件
					$('.sn-home-risk--list').on('mouseover','.sn-home-risk--item',function(e){
							var index = $(this).index(),dialog = $('.sn-home-risk--dialog'),tData = _this.data.homeRiskList[index];
							$(this).addClass('risk-active').siblings().removeClass('risk-active');
	
							//解决方案分割
							var solution = tData['solution'].split('|split|');
							var solutionHtml = '';
							for(var i=0;i<solution.length;i++){
									solutionHtml += '<p class="sn-dialog--mark sn-dialog-content">'+solution[i]+'</p>'
							}
	
							var filterXssUrl = $('<div></div>').text(tData['url'])   //过滤XSS
							dialog.html('<div class="sn-home-dialog--title">【'+tData['domain']+'】</div>'
													+'<div class="sn-home-dialog--content" data-index="'+index+'">'
															+'<p class="sn-dialog--mark">检测类型： <span class="sn-dialog--mark" style="color:'+(tData['risk'] == 3 ?'#F50606':(tData['risk'] == 2?'#FF9900':'#DDC400'))+'">'+tData['intercept']+'</span></p>'
															+'<p class="sn-dialog--mark">路径： <span class="sn-dialog--mark" style="word-break: break-all;">'+filterXssUrl.html()+'</span></p>'
															+'<p class="sn-dialog--mark">解决方案： <span class="sn-dialog--mark">'+solutionHtml+'</span></p>'
															+'<p class="sn-home-dialog--btn" style="text-align: right;"><a href="javascript:;" class="btlink sn-dialog--mark">误报</a>  | <a href="javascript:;" class="btlink sn-dialog--mark">已处理</a> </p>'
													+'</div>'
							).css({'top':e.clientY +5 + 'px','left':e.clientX - 30 + 'px','display':'block'})
					}).on('mouseout','.sn-home-risk--item',function(e){
							if(e.toElement.className.indexOf('-dialog') == -1){
									$('.sn-home-risk--item').removeClass('risk-active');
									$('.sn-home-risk--dialog').html('').removeAttr('style');
							}
					})
					// 风险弹窗关闭
					$('.sn-home-risk--dialog').on('mouseout',function(e){
							if(e.relatedTarget.className.indexOf('-dialog') == -1){
									$('.sn-home-risk--item').removeClass('risk-active');
									$('.sn-home-risk--dialog').html('').removeAttr('style');
							}
					})
					// 风险弹窗按钮
					$('.sn-home-risk--dialog').on('click','.sn-home-dialog--btn a',function(){
							var index = $(this).index(),_thData = _this.data.homeRiskList[$('.sn-home-dialog--content').data('index')];
							switch(index){
									case 0:
											_this.ajaxTask('wubao_url_white',{url_rule:_thData.url},function(res){
													layer.msg(res.msg, {icon:res.status?1:2});
											});
											break;
									case 1:
											_this.ajaxTask('set_ignore',{operation:1,id:_thData.id},function(res){
													if(res.status) $(".sn-menu__header li").eq(0).click()
													layer.msg(res.msg, {icon:res.status?1:2});
											});
											break;
							}
					})
	
					// 告警方式选择
					$('.sn-alarm--selectBox').on('click',function(e){
							var _ul = $(this).find('.sn-alarm--list');
							if(_ul.hasClass('show')){
									_ul.removeClass('show');
							}else{
									_ul.addClass('show');
							}
							$(document).one('click',function(){
									_ul.removeClass('show');
							})
							e.stopPropagation();
					})
	
					// 告警方式选择
					$('.sn-alarm--list').on('click','li',function(){
							var name = $(this).attr('name'),that = this;
							_this.ajaxTask('set_send',{type:name},function(res){
									if(res.status){
											$('.sn-alarm--list li').removeClass('active')
											$(that).addClass('active')
											$('.sn-alarm--channel').text($(that).text())
											$('.sn-alarm--list').hide();
									}
									if(res.msg) layer.msg(res.msg,{icon:res.status?1:2});
							})
					})
					// 设置告警通知
					$('.sn-alarm--mode .bt-form-new').on('change', 'input[type="checkbox"]', function () {
						var $this = $(this);
						var name = $this.attr('name');
						var checked = $this.is(':checked');
						_this.ajaxTask('set_send',{type: checked ? name : 'error'},function(res){
							if(res.status){
								if (checked) {
									$('.sn-alarm--mode .bt-form-new input[type="checkbox"]').prop('checked', false);
									$this.prop('checked', true);
								}
							}
							if(res.msg) layer.msg(res.msg,{icon:res.status?1:2});
							setTimeout(function () {
								_this.getAlarmSetting();
							}, 1000);
						})
					});
			},
			/**
					* 获取首页高危风险数据
			*/
			getHomeData:function(){
					var that = this;
					that.ajaxTask('get_notice',function(res){
							that.data.homeRiskList = res.logs  //风险数据
							var html = '',bgClassName = 'sn-home--overview-green'
							for(var i=0;i<res.logs.length;i++){
									var item = res.logs[i],siteZip = item['domain'],txtControl = item['intercept'];
									if(siteZip.length > 20){
											siteZip = siteZip.substring(0,12) + '...' + siteZip.substring(siteZip.length-5,siteZip.length)
									}
									
									if(item['intercept'].length > 6){
											txtControl = item['intercept'].substring(0,6)+'...'
									}
									html += '<div class="sn-home-risk--item risk--item-'+(item.risk == 3 ?'high':(item.risk == 2 ?'mod':'low'))+'">'
													+'<span class="sn-home-risk--type"><span><i class="sn-home--important-note">!</i>'+txtControl+'</span></span>'
													+'<span class="sn-home-risk--name">攻击者IP: <span>'+item['address']+'</span></span>'
													+'<span class="sn-home-risk--site">网站: <span>'+siteZip+'</span></span>'
													+'<span class="sn-home-risk--time">触发时间: <span>'+bt.format_data(item['addtime'])+'</span></span>'
											+'</div>'
							}
							if(res.logs.length == 0){
									$('.sn-home-risk--numtips').addClass('hide')
									// 空状态
									html = '<div class="sn-risk--no-data">'
															+'<img src="security_notice/static/img/no-data.png" alt="">'
															+'<p>风险项为空~</p>'
													+'</div>'
							}
							$('.sn-home-risk--list').html(html);
	
							// 风险概览数据
							$('.sn-home--overview-item--num').eq(0).find('.sn-home--overview-total').text(res.risk_high);  //高危
							$('.sn-home--overview-item--num').eq(1).find('.sn-home--overview-total').text(res.risk_mod);    //中危
							$('.sn-home--overview-item--num').eq(2).find('.sn-home--overview-total').text(res.risk_low);     //低危
							$('.sn-home--overview-item--num').eq(3).text(res.site_count);   //网站数
							$('.sn-home--overview-item--num').eq(4).text(res.risk_count);   //告警数
	
							// 今日新增
							if(res.today_risk_high > 0)$('.sn-home--overview-item').eq(0).find('.sn-home--overview-item--upNum').removeClass('hide').text(res.today_risk_high);
							if(res.today_risk_mod > 0)$('.sn-home--overview-item').eq(1).find('.sn-home--overview-item--upNum').removeClass('hide').text(res.today_risk_mod);
							if(res.today_risk_low > 0)$('.sn-home--overview-item').eq(2).find('.sn-home--overview-item--upNum').removeClass('hide').text(res.today_risk_low);
	
							// 渐变判断
							if(res.risk_high > 0) bgClassName = 'sn-home--overview-red'   //有高危数据
							if(res.risk_mod > 0 && res.risk_high == 0) bgClassName = 'sn-home--overview-yellow'  //有中危没有高危
							$('.sn-home--overview').addClass(bgClassName)
					})
			},
			/**
					* 获取网站列表
			*/
			getSiteList:function(){
					var that = this;
					var siteTbale = bt_tools.table({
							el:'#sn-table--siteList',
							default:'暂无网站',
							height: '480px',
							url:'/plugin?action=a&name=security_notice&s=get_sites',
							dataFilter: function (data) {
									return {data:data.sites};
							},
							column:[
									{fid:'site_name',title:'网站名称',type:'text'},
									{fid:'open',title:'防护状态',type: 'switch',event: function (row, index, ev, cname) {
											var _status = row.open
											if(row.version.indexOf('暂不兼容') != -1){
													$('.'+cname).eq(index).prop('checked', false);
													return layer.msg('当前版本不兼容安全防护功能',{icon:2})
											} 
											bt.confirm({
													title: (_status?'关闭':'开启')+'【'+row.site_name+'】站点安全告警',
													msg: _status?'关闭后，该网站将不再接收安全告警，是否继续？':'开启后，检测到安全问题时将会发送告警通知，是否继续？',
													cancel: function () {
															$(ev.currentTarget).prop('checked', row['open']?true:false);
													}
													}, function () {
															that.ajaxTask(_status?'stop_site':'start_site',{siteName:row.site_name},function(rdata){
																	if(rdata.status) siteTbale.$refresh_table_list();
																	bt_tools.msg(rdata);
															})
													}, function () {
															$(ev.currentTarget).prop('checked', row['open']?true:false);
											})
									}},
									{title:'今日触发',type:'text',template:function (row){
											return '<span>'+row.total.day_total+'</span>'
									}},
									{title:'触发总数',type:'text',template:function (row){
											return '<span>'+row.total.total+'</span>'
									}},
									{fid:'version',title:'PHP版本',type:'text'},
									{
											title: '操作',
											type: 'group',
											width: 120,
											align: 'right',
											group: [{
												title: '监视器',
												event: function (row) {
													// bt_tools.send({url: '/plugin?action=a&name=security_notice&s=add_site_config',data:{domain: '192.168.1.72',type: 'dir',path: '/www/wwwroot/192.168.1.72/192.168.1.210',actions: '1,1,1,1'}},function (rdata){
	
													// })
													bt_tools.open({
														type: 1,
														title: '【'+row.site_name+'】监视器',
														area: ['930px', '580px'],
														btn: false,
														closeBtn: 2,
														content: '<div class="sn-site__config pd15"><div id="sn-site__config--table"></div>\
															<div class="sn-footer">\
																	<ul class="help-info-text c7">\
																		<li>告警频率：60秒某一个告警行为只会发送一次告警</li>\
																		<li><a class="btlink" href="https://www.bt.cn/bbs/thread-112442-1-1.html" target="_blank">使用教程</a></li>\
																	</ul>\
															</div>\
														</div>',
														success:function(){
															//监视器
															site_config_table(row.config.file_info)
															function site_config_table(file_info) {
																var table_data = []
																var file_info = file_info
																$.each(file_info,function (index,item){
																	table_data.push({
																		path: index,
																		...item
																	})
																})
																bt_tools.table({
																	el: '#sn-site__config--table',
																	default: '暂无数据',
																	data: table_data,
																	height: '400',
																	column: [
																		{
																			fid: 'path',
																			title: '路径',
																			width: 580,
																			tips: '打开目录',
																			type: 'link',
																			event: function (items, index, ev) {
																				if(items.type === 'dir') {
																					openPath(items.path);
																				}else {
																					bt.pub.on_edit_file(0,items.path)
																				}
																			},
																		},
																		{
																			fid: 'type',
																			title: '类型',
																			width: 70,
																			template: function (items) {
																				return '<span>' + (items.type === 'dir' ? '文件夹' : '文件') + '</span>'
																			}
																		},
																		{
																			title: '告警操作',
																			width: 160,
																			template: function (items) {
																				var arr_actions = []
																				if(parseInt(items.read)) arr_actions.push('读取')
																				if(parseInt(items.del)) arr_actions.push('删除')
																				if(parseInt(items.reit)) {
																					arr_actions.push('修改')
																					arr_actions.push('增加')
																				}
																				return '<span>' + arr_actions.join(' / ') + '</span>'
																			}
																		},
																		{
																			title: '操作',
																			width: 100,
																			type: 'group',
																			align: 'right',
																			group: [{
																				title: '编辑',
																				event: function (items) {
																					edit_file_monitor(items)
																				}
																			},{
																				title: '删除',
																				event: function (items) {
																					bt_tools.send({url: '/plugin?action=a&name=security_notice&s=del_site_config',data:{domain:row.site_name,type: items.type,path: items.path}},function (rdata) {
																						bt_tools.msg(rdata)
																						if(rdata.status) {
																							siteTbale.$refresh_table_list();
																							delete file_info[items.path]
																							site_config_table(file_info)
																						}
																					})
																				}
																			}]
																		}
																	],
																	tootls:[
																		{
																			type: 'group',
																			positon: ['left', 'top'],
																			list: [{
																				title: '添加监视器',
																				active: true,
																				event: function (ev) {
																					edit_file_monitor()
																				}
																			}]
																		}
																	]
																})
																function edit_file_monitor(rowdata) {
																	var _type = 'dir'
																	bt_tools.open({
																		type: 1,
																		title: (rowdata ? '编辑' : '添加') + '监视器',
																		area: '470px',
																		btn: ['提交' , '取消'],
																		closeBtn: 2,
																		content: {
																			'class':'pd20',
																			form:[
																				{
																					label: '监测路径',
																					group: {
																						type: 'text',
																						width: '260px',
																						name: 'path',
																						disabled: rowdata ? true : false,
																						value: rowdata ? rowdata.path : '',
																						icon: {
																							type: 'glyphicon-folder-open',
																							select: 'all',
																																													defaultPath: row.path,
																							event: function (ev) {},
																							callback: function (path,list,type) {
																								_type = type === 'dir' ? 'dir' : 'file'
																							}
																						},
																						placeholder: '请选择文件目录'
																					}
																				},{
																					label: '告警操作',
																					group: [
																						{
																							type: 'checkbox',
																							style: 'margin-right:20px;',
																							name: 'read',
																							value: rowdata ? parseInt(rowdata.read) : 0,
																							title: '读取',
																						},
																						{
																							type: 'checkbox',
																							style: 'margin-right:20px;',
																							name: 'del',
																							value: rowdata ? parseInt(rowdata.del) : 0,
																							title: '删除',
																						},
																						{
																							type: 'checkbox',
																							style: 'margin-right:20px;',
																							name: 'reit',
																							value: rowdata ? parseInt(rowdata.reit) : 0,
																							title: '修改/增加',
																						}]
																				},{
																					group: {
																						type: 'help',
																						style: 'margin-left:30px;',
																						list: ['目录暂时只支持读取告警操作']
																					}
																				}
																			]
																		},
																		yes:function (form,layers,indexs){
																			if(form.path == '') return layer.msg('监测路径不能为空！')
																			var actions = []
																			$.each(form,function (index,item){
																				if(index !== 'path') {
																					actions.push(item ? '1' : '0')
																				}
																			})
																			if(actions.join(',') === '0,0,0') return layer.msg('最少选择一个告警操作！')
																			//actions: 1,1,1,1 读取 删除 修改 增加 
																			bt_tools.send({url: '/plugin?action=a&name=security_notice&s='+ (rowdata ? 'edit_site_config' : 'add_site_config'),data: {
																				domain: row.site_name,
																				path: form.path,
																				type: rowdata ? rowdata.type : _type,
																				actions: actions.join(',') + ',0'
																			}},function (rdata) {
																				bt_tools.msg(rdata)
																				if(rdata.status) {
																					siteTbale.$refresh_table_list();
																					bt_tools.send({ url: '/plugin?action=a&name=security_notice&s=get_sites',data:{}},function (site_res) {
																						var site_filter1 = site_res.sites.filter(function (a) {
																							return a.path === web.path && a.site_name === web.name
																						})
																						if(site_filter1.length  > 0) {
																							site_config_table(site_filter1[0].config.file_info)
																						}
																					})
																				}
																				layer.close(layers)
																			},'添加监视器')
																		}
																	})
																}
															}
														}
													})
												}
											},{
													title: '日志',
													event: function (row) {
															that.ajaxTask('get_domain_logs',{siteName:row.site_name},function(res){
																	if(res.data.length == 0){
																			layer.msg('暂无日志',{icon:6})
																			return;
																	}
																	bt_tools.open({
																			type: 1,
																			title: '【'+row.site_name+'】网站安全日志',
																			area: ['930px', '580px'],
																			btn: false,
																			closeBtn: 2,
																			content: '<div class="sn-site__log pd15"><div id="sn-site__log--table"></div>\
																					<div class="sn-site__log--page"></div>\
																			</div>',
																			success:function(){
																					that.renderLogTable(row.site_name)
																			}
																	})
															})
													}
											}]
									}
							],
					})
			},
			/** 
					* 获取木马隔离箱列表
			*/
			getIsolationList:function(){
					var that = this;
					var isolationList = bt_tools.table({
							el:'#sn-table--isolationList',
							default:'暂无木马文件',
							height: '476px',
							url:'/plugin?action=a&name=security_notice&s=Get_Recycle_bin',
							column:[
									{title:'文件名',type:'text',template:function (row){
											var name = row['name']
											if(name.length > 30){
													name = name.substring(0,15)+'...'+name.substring(name.length-7,name.length)
											}
											return '<span title="'+row['name']+'">'+name+'</span>'
									}},
									{title:'原路径',type: 'text',template:function (row){
											var dpath = row['dname']
											if(dpath.length > 25){
													dpath = dpath.substring(0,15)+'...'+dpath.substring(dpath.length-10,dpath.length)
											}
											return '<span title="'+row['dname']+'" class="btlink">'+dpath+'</span>'
									},event:function(row){
											bt.pub.on_edit_file(0,'/www/server/panel/plugin/security_notice/Recycle_bin/'+row['rname'])
									}},
									{title:'被隔离时间',type:'text', width:150,template:function (row){
											return '<span>'+bt.format_data(row['time'])+'</span>'
									}},
									{
											title: '操作',
											type: 'group',
											align: 'right',
											group: [{
													title: '恢复',
													event: function (row, index) {
															layer.confirm('从木马隔离箱中恢复[' + row['name'] + ']文件，是否继续？', { title: '恢复文件', closeBtn: 2,icon:0}, function () {
																	that.ajaxTask('Re_Recycle_bin',{path:row['rname']},function(res){
																			layer.msg(res.msg,{icon:res.status?1:2});
																			if(res.status)isolationList.$refresh_table_list(true);
																	});
															});
													}
											},{
													title: '永久删除',
													event: function (row, index) {
															layer.confirm('永久删除[' + row['name'] + ']文件后将无法恢复，是否继续？', { title: '恢复文件', closeBtn: 2,icon:0}, function () {
																	that.ajaxTask('Del_Recycle_bin',{path:row['rname']},function(res){
																			layer.msg(res.msg,{icon:res.status?1:2});
																			if(res.status)isolationList.$refresh_table_list(true);
																	});
															});
													}
											}]
									}
							],
					})
			},
			/** 
					* 获取白名单列表[ip/url]
			*/
			getWhiteList:function(){
					var that = this;
					this.ajaxTask('get_overall_info',function(res){
							var type = that.data.tabsWhiteActive == 1 ? 'ip' : 'url',columnArr = [],_key = 'ip_white';
							if(type == 'ip'){
									columnArr= [
											{ fid:'0',title:'起始IP',type:'text',template:function(row,index){return row[0]} },
											{ fid:'1',title:'结束IP',type: 'text',template:function(row,index){return row[1]} },
											{ title: '操作',type: 'group',width: 70,align: 'right',group: [{
													title: '删除',
													event: function (row,index) {
															that.ajaxTask('remove_ip_white',{index:index},function(res){
																	layer.msg(res.msg,{icon:res.status?1:2});
																	if(res.status)that.getWhiteList();
															})
													}
											}]
									}]
							}else{
									_key = 'url_white'
									columnArr = [
											{ title:'URL',type:'text',template:function (row){
													return '<span title="'+row+'" style="word-break: break-all;">'+row+'</span>'
											} },
											{ title: '操作',type: 'group',width: 110,align: 'right',group: [{
													title: '删除',
													event: function (row, index) {
															that.ajaxTask('remove_url_white',{index:index},function(res){
																	layer.msg(res.msg,{icon:res.status?1:2});
																	if(res.status)that.getWhiteList();
															})
													}
											}]
									}]
							}
							bt_tools.table({
									el:type == 'ip' ?'#sn-table--ipList':'#sn-table--urlList',
									default:'暂无数据',
									height: type == 'ip'?'325px':'338px',
									data:res[_key],
									column:columnArr,
							})
					})
			},
			/** 
					* 获取php列表
			*/
			getPhpList:function(){
					var that = this;
					var phpTable = bt_tools.table({
							el:'#sn-table--phpList',
							default:'暂未安装php版本',
							height: '530px',
							url:'/plugin?action=a&name=security_notice&s=get_index',
							dataFilter: function (data) {
									return {data:data.php_versions};
							},
							column:[
									{fid:'version',title:'版本',type:'text'},
									{fid:'site_count',title:'站点数量',type: 'text'},
									{fid:'state',title:'防护状态',type: 'switch',event: function (row, index, ev) {
											var _status = row.state == 1
											bt.confirm({
													title: (_status?'关闭':'开启')+'【php '+row.version+'】防护',
													msg: _status?'关闭后，该版本的站点将不再受到安全防护，是否继续？':'开启后，该版本的站点将受到安全防护，是否继续？',
													cancel: function () {
															$(ev.currentTarget).prop('checked', row['state'] == 1?true:false);
													}
													}, function () {
															that.ajaxTask('set_php_status',{php_version:row.v,enable:_status ? 0:1},function(rdata){
																	if(rdata.status) phpTable.$refresh_table_list();
																	bt_tools.msg(rdata);
															})
													}, function () {
															$(ev.currentTarget).prop('checked', row['state'] == 1?true:false);
											})
									}}
							]
					})
			},
			/**
					* 获取告警设置
			*/
			getAlarmSetting:function(){
				var that = this;
				var sendChannel = [{name: '邮箱',value: 'mail'},{name:'钉钉',value:'dingding'},{name:'飞书',value:'feishu'},{name:'企业微信',value:'weixin'},{name: '微信公众号',value: 'wx_account'},{name:'不绑定',value:'error'}]
				// 获取告警列表
				bt_tools.send({
					url: '/config?action=get_msg_configs',
				}, function (alarms) {
					$.post('/plugin?action=a&name=security_notice&s=get_send_config',function(rdata){
							var html = '',alarmType = -1,accountConfigStatus = false
							for(var i=0; i<sendChannel.length; i++){
									if(rdata.msg == sendChannel[i].value) alarmType = i
									if (sendChannel[i].value === 'wx_account') {
										var item = alarms[sendChannel[i].value]
										if (!$.isEmptyObject(item.data) && item.data.res.is_subscribe && item.data.res.is_bound) {
											accountConfigStatus = true;
										}
									}
									var is_config = sendChannel[i].value !== 'error' && (!alarms[sendChannel[i].value]['setup'] || $.isEmptyObject(alarms[sendChannel[i].value]['data'])) ? true : false
									html += '<li class="sn-alarm--item '+(sendChannel[i].value == rdata.msg && !is_config ? ' active':'') + (is_config ? ' disabled' : '') +'" name="'+sendChannel[i].value+'">'+sendChannel[i].name+ (is_config ? ' [<a target="_blank" class="bterror installNotice" data-type="' + sendChannel[i].value + '">未配置</a>]' : '') +'</li>'
							}
							$('.sn-alarm--list').html(html)
							$('.sn-alarm--channel').html(alarmType != -1 ? $('.sn-alarm--list .sn-alarm--item.active').hasClass('disabled') ? '请选择发送方式' : sendChannel[alarmType].name :'请选择发送方式')
							$('.sn-alarm--selectBox').find('.installNotice').unbind('click').click(function (ev) {
								var el = $(ev.currentTarget), type = $(el).data('type');
								openAlertModuleInstallView(type,'#phpSite .tab-nav-border span.on');
							});
					})
				})
				 // 获取告警列表
				//  bt_tools.send({
				// 	url: '/config?action=get_msg_configs',
				// }, function (alarms) {
				// 	// 获取选中告警
				// 	$.post('/plugin?action=a&name=security_notice&s=get_send_config', function (send) {
				// 		var html = '',accountConfigStatus = false
				// 		var tits = [];
				// 		// 当前选中的告警key
				// 		var cKey = send.msg;
				// 		// 渲染生成告警列表
				// 		$.each(alarms, function (key, item) {
				// 			accountConfigStatus = false
				// 			if (item.name === 'sms') return;
				// 			if (key === 'wx_account') {
				// 				if (!$.isEmptyObject(item.data) && item.data.res.is_subscribe && item.data.res.is_bound) {
				// 					accountConfigStatus = true;
				// 				}
				// 			}
				// 			var checked = cKey === item.name ? 'checked="checked"' : '';
				// 			var is_disabled = ((!item.setup || $.isEmptyObject(item.data)) ? true : ((key == 'wx_account' && !accountConfigStatus) ? true : false))
				// 			html += '\
				// 			<div class="form-item">\
				// 				<div class="form-label">' + item.title + '</div>\
				// 				<div class="form-content '+ (is_disabled ? 'check_disabled' : '') +'">\
				// 					<input type="checkbox" '+ (is_disabled ? 'disabled' : '') +' id="' + item.name + '_alarm" class="btswitch btswitch-ios" ' + checked + ' name="' + item.name + '" />\
				// 					<label class="btswitch-btn mr5" for="' + item.name + '_alarm"></label>'+
				// 					(is_disabled ? '[<a target="_blank" class="bterror installNotice" data-type="' + item.name + '">配置</a>]' : '')
				// 				+'</div>\
				// 			</div>';
				// 			tits.push(item.title);
				// 		});
				// 		$('.sn-alarm--mode .bt-form-new').html(html);
				// 		$('.sn-alarm--mode .bt-form-new').unbind('click').on('click', '.installNotice', function (ev) {
				// 			var el = $(ev.currentTarget), type = $(el).data('type');
				// 			openAlertModuleInstallView(type);
				// 		});
				// 	});
				// });  
			},
			/**
					* 获取告警列表
			*/
			getAlarmList:function(){
					bt_tools.table({
							el:'#sn-table--alarmList',
							default:'暂无告警信息',
							height: 450,
							url:'/plugin?action=a&name=security_notice&s=get_send_logs',
							column:[
									{fid:'log',title:'告警通知',type:'text'},
									{fid:'addtime',title:'日期',type: 'text',width:150},
							],
							tootls: [
									{ //分页显示
											type: 'page',
											numberParam: 'rows',
											defaultNumber: 20,
											numberStatus: true, //　是否支持分页数量选择,默认禁用
											jump: true, //是否支持跳转分页,默认禁用
									}
							]
					})
					
			},
			/**
					* 渲染日志列表
			*/
			renderLogTable:function(sitename){
					var that = this;
					bt_tools.table({
							el:'#sn-site__log--table',
							url:'/plugin?action=a&name=security_notice&s=get_domain_logs',
							param: {siteName:sitename},
							height: '470px',
							column:[{
									width:150,
									title: '时间',
									template:function(row){
											return '<span>'+bt.format_data(row['addtime'])+'</span>'
									}
							},{
									fid:'address',
									title: '用户IP',
									type:'link',
									tips:true,
									event:function(row,index){
											layer.confirm('是否将 <span style="color:#20a53a">' + row['address'] + '</span> 添加到IP白名单？', { title: '加入IP白名单', closeBtn: 2,icon:0}, function () {
													that.ajaxTask('add_ip_white',{start_ip:row['address'],end_ip:row['address']},function(res){
															layer.msg(res.msg,{icon:res.status?1:2});
													});
											});
									}
							},{
									fid:'intercept',
									title: '恶意类型'
							},{
									fid:'url',
									width: 270,
									title: 'URL地址',
									template:function (row){
											var dpath = $('<div></div>').text(row['url']),
											dpath = dpath.html()
											if(dpath.length > 35){
													dpath = dpath.substring(0,20)+'...'+dpath.substring(dpath.length-10,dpath.length)
											}
											return '<span title="'+dpath+'">'+dpath+'</span>'
									}
							},{
									title: '操作',
									type: 'group',
									width: 180,
									align: 'right',
									group: [{
											title:'URL加白',
											event:function(row){
													layer.confirm('加入URL白名单后此URL将不再进行防御，是否继续操作？', {title:'加入URL白名单',icon:3,closeBtn:2}, function () {
															that.ajaxTask('add_url_white',{url_rule:row.url},function(res){
																	layer.msg(res.msg, {icon:res.status?1:2});
															});
													});
											}
									},{
											title:'详情',
											event:function(row){
													var filterXssUrl = $('<div></div>').text(row['url'])   //过滤XSS
													layer.open({
															type: 1,
															title: "【"+ row['address'] + "】详情",
															area: '600px',
															closeBtn: 2,
															shadeClose: false,
															content: '\
																	<div class="pd15 lib-box">\
																			<table class="table" style="border:#ddd 1px solid;">\
																					<tbody>\
																							<tr>\
																									<th>时间</th>\
																									<td>' + bt.format_data(row['addtime']) + '</td>\
																									<th>用户IP</th>\
																									<td>\
																											<a class="btlink add_log_ip_white"  title="加入白名单">' + row['address'] + '</a>\
																									</td>\
																							</tr>\
																							<tr>\
																									<th>触发函数</th>\
																									<td>' + row['fun_name'] + '</td>\
																									<th>过滤器</th>\
																									<td style="max-width: 330px;word-break: break-all;">' + row['intercept'] + '</td>\
																							</tr>\
																					</tbody>\
																			</table>\
																			<div class="mt20">\
																					<b style="margin-left:10px">URI地址</b>\
																			</div>\
																			<div class="lib-con mt10">\
																					<div class="divpre">'+ filterXssUrl.html() + '</div>\
																			</div>\
																			<div class="mt20">\
																					<b style="margin-left:10px">User-Agent</b>\
																			</div>\
																			<div class="lib-con mt10">\
																					<div class="divpre">'+ row['data_info']['data']['request']['headers']['user-agent'] + '</div>\
																			</div>\
																			<div class="clearfix mt20">\
																					<b class="pull-left" style="margin-left: 10px;">传入值</b>\
																					<a class="btlink btn-error pull-right">URL加白</a>\
																			</div>\
																			<div class="lib-con mt10">\
																					<div class="divpre">'+ row['data_info']['data']['args'].join('</br>') + '</div>\
																			</div>\
																			<div class="clearfix mt20">\
																					<b class="pull-left" style="margin-left: 10px;">调用栈</b>\
																			</div>\
																			<div class="lib-con mt10">\
																					<div class="divpre">'+ row['data_info']['data']['stack_trace'].join('</br>') + '</div>\
																			</div>\
																			'+(row['fun_name'] == 'move_uploaded_file'?'<div class="clearfix mt20"><b class="pull-left" style="margin-left: 10px;">风险文件</b></div><div class="lib-con mt10"><div class="divpre">'+ row['data_info']['filename'] + '</div></div>':'')+'\
																	</div>',
															success:function($layer){
																	$('.add_log_ip_white').click(function(){
																			layer.confirm('是否将 <span style="color:#20a53a">' + row['address'] + '</span> 添加到IP白名单？', { title: '加入IP白名单', closeBtn: 2,icon:0}, function () {
																					that.ajaxTask('add_ip_white',{start_ip:row['address'],end_ip:row['address']},function(res){
																							layer.msg(res.msg,{icon:res.status?1:2});
																					});
																			});
																	});
																	$layer.find('.btn-error').click(function () {
																			layer.confirm('加入URL白名单后此URL将不再进行防御，是否继续操作？', { title: '加入URL白名单', closeBtn: 2, icon: 3 }, function () {
																					that.ajaxTask('wubao_url_white',{url_rule:row.url},function(res){
																							layer.msg(res.msg, {icon:res.status?1:2});
																					});
																			});
																	})
															}
													})
											}
									},{
											title:'HTTP',
											event:function(row){
													var _http_info = row;
													if(_http_info){
															layer.open({
																	type: 1,
																	title: "【"+ row.address + "】HTTP详情",
																	area: ['800px','500px'],
																	closeBtn: 1,
																	shadeClose: false,
																	maxmin: true,
																	content: '<div class="pd15 lib-box" style="height:100%">\
																					<pre id="http_info_data" style="height:100%;white-space: break-spaces;"></pre></div>',
																	success:function(layers){
																			$('#http_info_data').text(that.formatJsonForNotes(_http_info));
																			$(layers).css('top',($(window).height() - $(layers).height()) /2);
																	}
															})
													}else{
															layer.msg('暂无HTTP详情信息',{icon:6})
													}
											}
									}]
							}],
							tootls: [
									{ //分页显示
											type: 'page',
											numberStatus: true, //　是否支持分页数量选择,默认禁用
											jump: true, //是否支持跳转分页,默认禁用
									}
							]
					})
			},
			/**
					* 动态处理请求，设置全局ajaxList，api和提示语，遍历请求返回成功值
					* @param {string} config 需要请求的api
					* @param {Function} data 请求参数
					* @param {Function} success 成功值
					* @param {Function} error 失败值
			*/
			ajaxTask: function (config,data,success,error) {
					if(typeof config == "string"){
							if(typeof data == "object"){
									config = {method:config,data:data,success:success,error:error}
							}else if(typeof data == "function"){
									config = { method:config,success:data}
									if(typeof success == "function" ){
											config.error = success
									}
							}
					}
					if (config.middle === false) {config.success();return false}
					this.http({
							tips: '正在' + this.ajaxList[config.method] + ',请稍侯...',
							method: config.method,
							data: config.data || {},
							success: function (rdata) {
									if (config.success) config.success(rdata);
							},
							error: function (rdata) {
									if (config.error) config.error(rdata);
							}
					});
			},
			// json格式化
			formatJsonForNotes:function(json, options) {
					var reg = null,
							formatted = '',
							pad = 0,
							PADDING = '  '; // （缩进）可以使用'\t'或不同数量的空格
					// 可选设置
					options = options || {};
					// 在 '{' or '[' follows ':'位置移除新行
					options.newlineAfterColonIfBeforeBraceOrBracket = (options.newlineAfterColonIfBeforeBraceOrBracket === true) ? true : false;
					// 在冒号后面加空格
					options.spaceAfterColon = (options.spaceAfterColon === false) ? false : true;
					// 开始格式化...
					if (typeof json !== 'string') {
							// 确保为JSON字符串
							json = JSON.stringify(json);
					} else {
							//已经是一个字符串，所以解析和重新字符串化以删除额外的空白
							json = JSON.parse(json);
							json = JSON.stringify(json);
					}
					// 在花括号前后添加换行
					reg = /([\{\}])/g;
					json = json.replace(reg, '\r\n$1\r\n');
					// 在方括号前后添加新行
					reg = /([\[\]])/g;
					json = json.replace(reg, '\r\n$1\r\n');
					// 在逗号后添加新行
					reg = /(\,)/g;
					json = json.replace(reg, '$1\r\n');
					// 删除多个换行
					reg = /(\r\n\r\n)/g;
					json = json.replace(reg, '\r\n');
					// 删除逗号前的换行
					reg = /\r\n\,/g;
					json = json.replace(reg, ',');
					// 可选格式...
					if (!options.newlineAfterColonIfBeforeBraceOrBracket) {       
							reg = /\:\r\n\{/g;
							json = json.replace(reg, ':{');
							reg = /\:\r\n\[/g;
							json = json.replace(reg, ':[');
					}
					if (options.spaceAfterColon) {        
							reg = /\:/g;
							json = json.replace(reg, ': ');
					}
					$.each(json.split('\r\n'), function(index, node) {
							var i = 0,
									indent = 0,
									padding = '';
							if (node.match(/\{$/) || node.match(/\[$/)) {
									indent = 1;
							} else if (node.match(/\}/) || node.match(/\]/)) {
									if (pad !== 0) {
											pad -= 1;
									}
							} else {
									indent = 0;
							}
							for (i = 0; i < pad; i++) {
									padding += PADDING;
							}
							formatted += padding + node + '\r\n';
							pad += indent;
					});
					return formatted;
			},
			// 请求封装
			http: function (obj) {
					var loadT = '';
					if (obj.load == undefined) obj.load = 0;
					if (obj.url == undefined) {
							if (obj.plugin_name === undefined && this.plugin_name !== undefined) obj.plugin_name = this.plugin_name
							if (!obj.plugin_name || !obj.method) {
									layer.msg('插件类名称，或插件方法名称缺失!', {icon: 2 });
									return false;
							}
					}
					if (obj.load === 0 || obj.tips != undefined) {
							loadT = layer.msg(obj.tips, {icon: 16,time: 0, shade: 0.1});
					} else if (obj.load === 1 || (obj.tips == undefined && obj.load == undefined)) {
							loadT = layer.load();
					}
					$.ajax({
							type: 'POST',
							url: obj.url != undefined ? obj.url : ('/plugin?action=a&name=' + obj.plugin_name + '&s=' + obj.method),
							data: obj.data || {},
							timeout: obj.timeout || 99999999,
							complete: function (res) {
									if (obj.load === 0 || obj.load === 1) layer.close(loadT);
							},
							success: function (rdata) {
									if (obj.check) {
											obj.success(rdata);
											return
									}
									if (typeof rdata.status !== 'undefined' && rdata.status === false) {
											layer.msg(rdata.msg, {icon: 2});
											return false;
									}
									obj.success(rdata);
							},
							error: function (ex) {
									if (!obj.error) {
											obj.msg || obj.msg == undefined ? layer.msg('请求过程发现错误!', {icon: 2}) : '';
											return;
									}
									return obj.error(ex);
							}
					});
			},
			init:function(){
					var that = this;
					this.event()     //事件绑定
					$(".sn-menu__header li").eq(0).click() //获取首页
					$('.layui-layer-page').width(900).css({   //设置最外层弹窗大小
							'left':(document.body.clientWidth-900)/2+'px'
					})
			}
	}
	
	securityNotice.init()  //初始化
	</script>