<style>
	.alarmcon {
		float: left;
		width: 100%;
	}

	.bt-legend {
		border-color: #ccc;
		font-size: 14px;
		padding-bottom: 6px;
		margin-bottom: 10px;
	}

	.bt-legend .btswitch+.btswitch-btn {
		width: 2.4em;
		height: 1.4em;
		margin-bottom: 0;
	}

	.bt-box {
		display: none;
	}

	.logs_body .ov {
		width: 475px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.line_nest {
		width: 250px;
		display: inline-block;
	}
	.line_nest .nest_name {
		width: 75px;
	}
	.line_nest .nest_info {
		margin-left: 75px
	}
	.check_type_line .inlineBlock{
		width: 110px;
	}
	.check_type_line .inlineBlock span.vertical_middle{
		width: 77px;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		display: inline-block;
	}
	.bt-form-monitor.bt-form .form-checkbox.active {
		background-color: #20a53a;
		border-color: #20a53a;
	}
	.bt-form-monitor.bt-form .form-checkbox.active::after {
		content: '';
		position: absolute;
		display: block;
		left: 50%;
		top: 50%;
		margin-left: -2.5px;
		margin-top: -6px;
		width: 5px;
		height: 10px;
		border: solid #fff;
		border-width: 0 2px 2px 0;
		transform: rotate(45deg);
	}
	.bt-form-monitor.bt-form .form-checkbox {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 1px solid #ccc;
        background-color: #fff;
        vertical-align: top;
        position: relative;
        border-radius: 2px;
    }
	.bt-form-monitor.bt-form .form-checkbox-label {
        display: inline-block;
        height: 30px;
        line-height: 30px;
        cursor: pointer;
    }
    .unusual_push .bt_table .cust—checkbox, .unusual_push.bt-form .form-checkbox {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 1px solid #ccc;
        background-color: #fff;
        vertical-align: top;
        position: relative;
        border-radius: 2px;
    }
    .bt-form-monitor.bt-form .form-checkbox {
        vertical-align: middle;
    }
    .bt-form-monitor .vertical_middle {
        vertical-align: middle;
        font-weight: 500;
    }
</style>
<div class="bt-form unusual_push">
	<div class="bt-w-main">
		<div class="bt-w-menu">
			<p class="bgw">监控推送</p>
			<p>邮箱管理</p>
			<p>日志</p>
		</div>
		<div class="bt-w-con pd15">
			<div class="bt-box push_body" style="display:block;">
				<div class="push_conter" style="overflow: hidden;">
					<button class="btn btn-success btn-sm add_push_btn">添加监控推送</button>
					<div class="ssh-item" style="margin-right:0;margin-left:0; float:right;">
						<span style="display: inline-block;height: 20px;line-height: 20px;vertical-align: top;">监控总开关&nbsp;&nbsp;</span>
						<div class="" style="display:inline-block;"><input class="btswitch btswitch-ios" id="terclose" type="checkbox" /><label class="btswitch-btn" for="terclose"></label></div>
					</div>
				</div>
				<div class="divtable mt10" id="push_table" style="height:425px">
					<table class="table table-hover" style="position: relative;z-index: 999;" width="100%" cellspacing="0" cellpadding="0" border="0">
						<thead><tr><th width="12%">名称</th><th width="13%"> 推送方式</th><th width="50%">监控详情</th><th width="12%">是否检查</th><th style="text-align:right;"> 操作</th></tr></thead>
					</table>
					<div class="relative" style="height: 420px;overflow: auto;top:-35px;">
						<table class="table table-hover" width="100%" cellspacing="0" cellpadding="0" border="0">
							<thead><tr><th  width="12%">名称</th><th width="13%"> 推送方式</th><th width="50%">监控详情</th><th width="12%">是否检查</th><th style="text-align:right;"> 操作</th></tr></thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
				<ul class="help-info-text c7">
					<li>监测时间单位内的平均值大于预警阈值才发送邮件通知</li>
				</ul>
			</div>
			<div class="bt-box mail_body">
				<button class="btn btn-success btn-sm add_mail_btn">添加邮箱</button><i style="color:red;font-style:normal;margin-left:10px;">*
					必须将msg@bt.cn白名单才能收到信息<a href="https://www.bt.cn/bbs/forum.php?mod=viewthread&tid=23574&page=1&extra=#pid84228" class="btlink" style="margin-left:10px;" target="_blank" >如何设置邮箱白名单</a></i>
				<div class="divtable mt10 relative">
					<table width="100%" border="0" cellpadding="0" cellspacing="0" class="table table-hover">
						<thead><tr><th>邮箱地址</th><th style="width:150px;text-align: right;">操作</th></tr></thead>
						<tbody></tbody>
					</table>
				</div>
			</div>
			<div class="bt-box logs_body">
				<div class="divtable">
					<table width="100%" border="0" cellpadding="0" cellspacing="0" class="table table-hover">
						<thead><tr><th>详情</th><th>操作时间</th></tr></thead>
						<tbody></tbody>
					</table>
				</div>
				<div class="page" style="margin-top:10px"></div>
			</div>
		</div>
	</div>
</div>
<script>
	var msg_push = {
		push_list: [],
		push_form: {
			push_name: '',
			push_type: 'mail',
			check_type: 'cpu',
			push_time:'10',
			net_bandwidth: '20',
			check_time: '5',
			alarm_value: '80',
			site_check_url: '',
			site_check_word: '',
			url_list:'',
			site_name:'',
			open: 1,
			report_type:'hour',
			report:'',
			adv:0,
			key:'',
			action:0
		},
		data: {
			ua: [
				{
					title: '百度蜘蛛',
					value: 'Mozilla/5.0 (Linux;u;Android 4.2.2;zh-cn;) AppleWebKit/534.46 (KHTML,like Gecko)Version/5.1 Mobile Safari/10600.6.3 (compatible; Baiduspider/2.0;+http://www.baidu.com/search/spider.html)'
				},
				{
					title: '必应蜘蛛',
					value: 'Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/W.X.Y.Z Mobile Safari/537.36 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)'
				},
				{
					title: '搜狗蜘蛛',
					value: 'Sogou web spider/4.0(+http://www.sogou.com/docs/help/webmasters.htm#07)'
				},
				{
					title: '360蜘蛛',
					value: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36; 360Spider'
				},
				{
					title: '易搜蜘蛛',
					value: 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.81 YisouSpider/5.0 Safari/537.36'
				},
				{
					title: '字节跳动蜘蛛',
					value: 'Mozilla/5.0 (compatible; Bytespider;[https://zhanzhang.toutiao.com/] AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.0.0 Safari/537.36'
				},
				{
					title: '自定义UA',
					value: 'other'
				}
			]
		},
		bind: function () {
			var _this = this;
			$('.layui-layer-page').width(800);
			_this.get_event_list();
			_this.check_mail_first();
			$('.bt-w-menu p').click(function (e) {
				var index = $(this).index();
				$(this).addClass('bgw').siblings().removeClass('bgw');
				$(this).parent().next().find('.bt-box').eq(index).show().siblings().hide();
				switch (index) {
					case 0:
						_this.get_event_list();
					break;
					case 1:
						_this.get_mail_list();
					break;
					case 2:
						_this.get_push_log();
					break;
				}
			});
			$('.add_push_btn').click(function (e) {
				_this.push_event_view();
			});

			$('#terclose').change(function (e) {
				var checked = $(this).prop('checked');
				var confirm = layer.confirm('是否' + (!checked ? '关闭' : '开启') + '，异常监控推送服务 ', {
					title: '警告',
					btn: ['确定', '取消'],
					icon: 0,
					closeBtn: 2,
					cancel: function (index, layero) {
						$('#terclose').prop('checked', !checked);
						layer.close(index);
					},
					yes: function (index, layero) {
						_this.push_request(!checked ? 'stop' : 'start', {}, function (res) {
							if (!res.status) $('#terclose').prop('checked', checked);
						});
					},
					btn2: function (index, layero) {
						$('#terclose').prop('checked', !checked);
						layer.close(index);
					}
				});
			});
			$('.add_mail_btn').click(function (e) {
				_this.mail_event_view();
			});
		},
		check_mail_first: function () {
			var load = layer.load();
			$.get('/plugin?action=a&name=msg_push&s=CheckMailFirst', function (res) {
				layer.close(load);
				if (res != 0) layer.msg('请设置监控推送的邮箱地址！', { icon: 0 });
			});
		},
		// 获取事件推送列表
		get_event_list: function () {
			var _this = this;
			// var  load = layer.msg('正在获取推送列表，请稍候...',{icon:16,time:0,shade: [0.3, '#000'],zIndex:999});
			var load = layer.load();
			$.get('/plugin?action=a&name=msg_push&s=get_msgpush_list', function (res) {
				_this.push_list = res;
				layer.close(load);
				var content = '';
				for (var i = res.length - 1; i >= 0; i--) {
					var request_event_filter = _this.request_event_filter(res[i]);
					content += '<tr>' +
						'<td><span style="width:60px;display: inline-block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;"  title="'+ res[i].push_name +'">' + res[i].push_name + '</span></td>' +
						'<td>' + _this.filter_push_type(res[i].push_type) + '</td>' +
						'<td><span style="width:300px;display: inline-block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;" title="' + request_event_filter.conter_title + '">' + request_event_filter.conter + '</span></td>' +
						'<td>' + (res[i].open == 1 ? '<a href="javascript:;" class="set_push_open" style="color:#20a53a;" data-index="' + i + '">运行中 <span style="color:#20a53a" class="glyphicon glyphicon-play"></span></a>' : '<a href="javascript:;" class="set_push_open" style="color:red" data-index="' + i + '">已停止 <span style="color:red" class="glyphicon glyphicon-pause"></span></span>') + '</td>' +
						'<td style="text-align:right"><a href="javascript:;" class="btlink edit_push" data-msg="' + res[i].push_type + '" data-index="' + i + '">编辑</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:;" class="btlink del_push" data-name="' + res[i].push_name + '">删除</a></td>' +
					'</tr>'
				}
				if (res.length == 0) {
					conter = '<tr ><td colspan="4">当前没有数据</td></tr>'
				}
				$('.push_body tbody').html(content);
				setTimeout(function () {
					$('.del_push').click('click', function (e) {
						var name = $(this).attr('data-name');
						var confirm = layer.confirm('是否删除该监控&nbsp;[ ' + name + ' ]&nbsp;？ ', { title: '警告', btn: ['确定', '取消'], icon: 0, closeBtn: 2 }, function () {
							_this.push_request('del', { push_name: name }, confirm);
						}, function () {
							layer.close(confirm);
						});
					});
					$('.edit_push').click(function (e) {
						var index = $(this).attr('data-index');
						_this.push_event_view(_this.push_list[index]);
						$('.bt-form-monitor [name=push_type]').val($(this).attr('data-msg'));
					});
					$('.set_push_open').click(function (e) {
						var index = $(this).attr('data-index');
						var confirm = layer.confirm('是否' + (_this.push_list[index].open == 0 ? '开启' : '关闭') + '消息通知&nbsp;[' + (_this.push_list[index].push_name) + ']&nbsp;？', { title: '提示', btn: ['确定', '取消'], icon: 0, closeBtn: 2 }, function () {
							delete _this.push_list[index].time;
							_this.push_list[index].open = _this.push_list[index].open == 0 ? 1 : 0
							_this.push_request('open', _this.push_list[index], confirm);
						}, function () {
							layer.close(confirm);
						});
					});
				}, 100);

				_this.get_check_server(function (res) {
					$('#terclose').prop('checked', res.status);
				});
			});
		},
		// 过滤器
		request_event_filter: function (res) {
			var conter = '', conter_title = '';
			switch (res.check_type) {
				case 'cpu':
					conter = '每隔<a href="javascript:;" class="btlink">' + res.check_time + '分钟</a>检查一次当前的CPU使用率是否超过<a href="javascript:;" class="btlink">' + res.alarm_value + '%</a>';
					conter_title = '每隔' + res.check_time + '分钟,检查一次当前的CPU使用率是否超过' + res.alarm_value + '%';
					break;
				case 'mem':
					conter = '每隔<a href="javascript:;" class="btlink">' + res.check_time + '分钟</a>检查一次当前设置的内存使用率是否超过<a href="javascript:;" class="btlink">' + res.alarm_value + '%</a>';
					conter_title = '每隔' + res.check_time + '分钟,检查一次当前设置的内存使用率是否超过' + res.alarm_value + '%';
					break;
				case 'disk':
					conter = '检查当前设置的硬盘使用率是否超过<a href="javascript:;" class="btlink">' + res.alarm_value + '%';
					conter_title = '检查当前设置的硬盘使用率是否超过' + res.alarm_value + '%';
					break;
				case 'net':
					conter = '每隔<a href="javascript:;" class="btlink">' + res.check_time + '分钟</a>检查一次当前设置的带宽使用率是否超过<a href="javascript:;" class="btlink">' + res.alarm_value + '%</a>';
					conter_title = '每隔' + res.check_time + '分钟,检查一次当前设置的带宽使用率是否超过' + res.alarm_value + '%';
					break;
				case 'url':
					conter = '检查url<a href="' + res.site_check_url + '" class="btlink">' + res.site_check_url + '</a>是否出现关键字/词[<a href="javascript:;" class="btlink">' + res.site_check_word + '</a>]，出现表示正常';
					conter_title = '检查URL ' + res.site_check_url + '是否出现关键字/词[' + res.site_check_word + '],出现表示正常';
					break;
				case 'site':
					conter = '检查站点<a href="javascript:;" class="btlink">' + res.site_name + '</a>是否正常。';
					conter_title = '检查站点' + res.site_name + '是否正常。';
					break;
				case 'check_ssl_expired':
					conter = '每天<span style="color: red;">'+ res.report  +'</span>点检测SSL证书是否过期';
					conter_title = '每天'+ res.report  +'点检测SSL证书是否过期';
					break;
				case 'service':
					var services = res.services.join(',')
					conter = '每隔<a href="javascript:;" class="btlink">'+ res.push_time + '分钟</a>,检查一次【'+services+'】服务状态'
					conter_title = '每隔'+res.push_time + '分钟,检查一次'+services+'服务状态'
					break;
			}
			return { conter: conter, conter_title: conter_title };
		},
		// 推送事件视图,添加或编辑
		push_event_view: function (obj) {
			var push_type = false, _this = this, _option = '', _option1 = '', _option2 = '', site_list = {};
			if (obj == undefined) {
				obj = objDeepCopy(this.push_form)
				push_type = false;
			} else {
				push_type = true;
			}
			var arry = [{ name: 'CPU', value: 'cpu' },{ name: '内存', value: 'mem' },{ name: '硬盘', value: 'disk' }, { name: '带宽', value: 'net' },{ name: '站点', value: 'site' }, { name: 'URL链接', value:'url' }, { name: 'SSL证书过期', value: 'check_ssl_expired' },{ name:'常用服务',value:'service'}]
			for (var i = 0; i < arry.length; i++) {
				_option += '<option value="' + arry[i].value + '" ' + (obj.check_type == arry[i].value ? 'selected="selected"' : '') + '>' + arry[i].name + '</option>'
			}
			var _type = ['mail'];
			var push_view = layer.open({
				type: 1,
				closeBtn: 2,
				title: !push_type? '添加监控推送' : '编辑监控推送[&nbsp;' + obj.push_name + '&nbsp;]',
				area: '650px',
				btn:['确认','取消'],
				shadeClose: false,
				content: '<form class="bt-form bt-form-monitor pd20" style="padding-left:45px">' +
						'<div class="line">' +
							'<span class="tname">名称</span>' +
							'<div class="info-r"><input name="open" type="text" value="1" style="display:none"/><input name="push_name" class="bt-input-text mr5" placeholder="监控推送名称" type="text" value="' + obj.push_name + '" style="width:300px;" ' + (push_type == 1 ? 'disabled="disabled"' : '') + '></div>' +
						'</div>' +
						'<div class="line">' +
							'<span class="tname">推送方式</span>' +
							'<div class="info-r"><select class="bt-input-text mr5" name="push_type" style="width:27%" ' + (push_type == 1 ? 'disabled="disabled"' : '') + '><option value="msg_mail">邮件</option><option value="sms">短信</option><option value="dingding">钉钉</option><option value="mail">宝塔邮件API</option></select><i style="color:red;font-style:normal;">*推荐使用钉钉或邮件更稳定</i></div>' +
						'</div>' +
						'<div class="line">' +
							'<span class="tname">监控类型</span>' +
							'<div class="info-r"><select class="bt-input-text mr5" name="check_type" style="width:27%" ' + (push_type == 1 ? 'disabled="disabled"' : '') + '>' + _option + '</select><i style="color:red;font-style:normal;">*监控类型包括:CPU、内存、硬盘、带宽、URL链接</i></div>' +
						'</div>' +
						'<div class="check_type_line"></div>'+
					'</form>',
				success: function (layero, index) {
					_this.return_type_input(push_type,obj);
					$('[name="check_type"]').change(function () {
						obj.check_type = $(this).val();
						_this.return_type_input(push_type,obj);
					})
					$('[name="site_adv"]').change(function(){
						var checked = $(this).prop('checked');
						if(checked){
							$('.site_adv_block').show().find('input').val('');
						}else{
							$('.site_adv_block').hide();
						}
					})
					$('.bt-form-monitor').on('change','[name="site_name"]',function () {
						var val = $(this).val();
						$('[name="url_list"]').html(_this.get_site_domain(_this.site_list[val],'',false));
					})
					$('.bt-form-monitor').on('change','[name="adv"]',function(){
						var checked = $(this).prop('checked');
						checked?$('.ket_line').show().next().show():$('.ket_line').hide().next().hide()
						$('.ket_line input').val('');
					});
					$('.bt-form-monitor').on('change','[name=ua_type]',function () {
						console.log($(this).val())
						var val = $(this).val();
						$(this).next().val(val == 'other'? '' : val).prop('title',val == 'other' ? '' : val).attr('readonly',val == 'other'? false : true);
					})
					$.post('/plugin?action=a&name=msg_push&s=get_channel_settings', function (res) {
				        for (var i in res) {
				            if(res[i][i] == true){
    				            _type.push(i);
				            }
				        }
				    });
				},
				yes:function(index,layero){
					var config = $('.bt-form-monitor').serializeObject();
					if(config.push_name == ''){
						layer.msg('监控推送名称标识不能为空！',{icon:2});
						return false;
					}
					if(!push_type && $.inArray(config.push_type,_type) < 0 && config.push_type != 'sms'){
					    layer.msg('推送方式【' + _this.filter_push_type(config.push_type) + '】还未开启，请到【面板设置 --> 消息通道】 内设置！',{icon:2});
						return false;
					}
					if(config.push_time && config.push_time < 10) return layer.msg('推送间隔不能小于10分钟',{icon:2});
					if(config.alarm_value && (config.alarm_value < 1 || config.alarm_value > 100)) return layer.msg('预警阀值请设置【1-100】',{icon:2});
					if(config.check_time &&  config.check_time < 1) return layer.msg('监测时间不能小于0',{icon:2});
					for(var i in config){
						obj[i] = config[i];
					}
					if(push_type) config = objDeepCopy(obj)
					switch(config.check_type){
						case 'site':
							config.adv = $('[name="adv"]').prop('checked')?1:0;
							delete config['ua_type'];
							if(!$('[name="adv"]').prop('checked')) {
								config.key = '';
								config.ua_key = ''
							}
						break;
					    case 'check_ssl_expired':
							config.report_type = 'daily';
							config.push_time = 60;
						break;
						case 'service':
							var isCheck = [];
							$('.module-check').each(function(){
								if($(this).find('input').prop('checked')){
									isCheck.push($(this).find('span').html())
								}
							})
							if(isCheck.length == 0) return layer.msg('请选择一项服务',{icon:2})
							config['services'] = JSON.stringify(isCheck)
							config['act'] = config.act == 'on'?1:0
						break;
					}
				// 	console.log(config)
				// 	return
					_this.push_request(!push_type?'add':'edit',config, function(res){
					    if (res.status) {
			                layer.close(index);
			            }
					});
				}
			});
		},
		// 返回input格式
		return_type_input:function(type,row){
			var _html = '',_this = this,_config = {},_option1='',_option2='',_option3='',_option4='';
			var push_time = '<div class="line"><span class="tname">推送间隔时间</span><div class="info-r"><input name="push_time" class="bt-input-text mr5" placeholder="推送间隔时间" type="number" min="10"   value="' + row.push_time + '" style="width:27%" >分钟</div></div>';
			switch(row.check_type){
				case 'cpu': //cpu监控
				case 'mem'://内存监控
					if(row.check_type === 'cpu'){
						_config = {val_text:'CPU预警阀值',val_name:'alarm_value',_val:row['alarm_value'],time_text:'CPU监测时间',time_name:'check_time',_time:row['check_time']}
					}else{
						_config = {val_text:'内存预警阀值',val_name:'alarm_value',_val:row['alarm_value'],time_text:'内存监测时间',time_name:'check_time',_time:row['check_time']}
					}
					_html='<div class="translate_block"><div class="line"><span class="tname">'+ _config['val_text'] +'</span><div class="info-r">\
							<input name="'+ _config['val_name'] +'" class="bt-input-text mr5" type="number" min="1" max="100" value="'+ _config['_val'] +'" style="width:50px;">%\
							<span class="tnames" style="margin-left:25px;padding-right: 20px;">'+ _config['time_text'] +'</span>\
							<input name="'+ _config['time_name'] +'" class="bt-input-text mr5" min="0" type="number" value="'+ _config['_time'] +'" style="width:50px;">分钟\
						</div></div></div>';
					$('.check_type_line').html(push_time+_html);
					break;
				case 'disk': //硬盘监控
					_html='<div class="line"><span class="tname">硬盘预警阀值</span><div class="info-r">\
							<input name="alarm_value" class="bt-input-text mr5" type="number" min="0" max="100" value="'+ row['alarm_value'] +'" style="width:50px;">%\
						</div></div>';
					$('.check_type_line').html(push_time+_html);
					break;
				case 'net':
					 this.get_net_card(function(res){
						for(var i=0;i<res.length;i++){ _option1 += '<option value="'+ res[i] +'" '+ (res[i] == row.netcard ? 'selected="selected"':'') +'>'+ res[i] +'</option>'}
						_html = '<div class="line"><span class="tname">带宽预警阀值</span><div class="info-r">\
									<input class="bt-input-text mr5" type="number" name="alarm_value" min="0" max="100" value="'+ row['alarm_value'] +'" style="width:50px;">%\
									<span class="tnames" style="margin-left:25px;padding-right: 20px;">带宽监测时间</span>\
									<input name="check_time" class="bt-input-text mr5" type="number" min="0&quot;" value="'+ row['check_time'] +'" style="width:50px;">分钟\
									<span class="tnames" style="margin-left:25px;padding-right: 20px;">带宽总大小</span>\
									<input name="net_bandwidth" class="bt-input-text mr5" type="number" min="0" value="'+ row['net_bandwidth']+'" style="width:50px;">Mbps\
								</div></div>\
								<div class="line"><span class="tname">监控网卡</span><div class="info-r">\
								<select class="bt-input-text mr5 net_card" name="netcard" style="width:27%">'+ _option1 +'</select>\
							</div></div>';
						$('.check_type_line').html(push_time+_html);
					})
				break;
				case 'site':
					$('.check_type_line').html('');
					this.get_local_site_list(function (res) {
						res == undefined?res = {}:res;
						_this.site_list = res;
						var _site_name = row.site_name || get_object_first_attribute(_this.site_list,true);
						_option2 = _this.get_site_domain(_this.site_list,_site_name,true);
						_option3 = _this.get_site_domain(_this.site_list[_site_name],row.url_list,false);
						_html = '<div class="translate_block"><div class="line"><span class="tname">站点</span><div class="info-r">\
									<select class="bt-input-text mr5" name="site_name" style="width:150px">'+ _option2 +'</select>\
									<span class="tnames" style="margin-left:25px;padding-right: 20px;">域名</span>\
									<select class="bt-input-text mr5" name="url_list" style="width:150px">'+ _option3 +'</select>\
								</div></div></div><div class="line site_block"><span class="tname">精确监控</span><div class="info-r"><div style="display:inline-block;">\
									<input class="btswitch btswitch-ios" id="adv" name="adv" '+ (row['adv'] == '1'?'checked="checked"':'') +' type="checkbox"><label class="btswitch-btn" for="adv" style="position: relative;top: 6px;"></label></div></div></div>\
								<div class="line ket_line" style="'+ (row['adv'] == '1'?'display:block':'display:none') +'"><span class="tname">关键字/词</span>\
								<div class="info-r"><input name="key" class="bt-input-text mr5" placeholder="设置关键字/词 [ 百度 ]" type="text" value="'+  row.key +'" style="width:300px;"></div></div>\
								<div class="line" style="'+ (row['adv'] == '1'?'display:block':'display:none') +'"><span class="tname">访问UA</span><div class="info-r">\
									'+ _this.get_ua_options(_this.data.ua, row.hasOwnProperty('ua_key') ? row : false) +'\
								</div></div>'
						$('.check_type_line').html(push_time+_html);
					});
				break;
				case 'url':
					_html = '<div class="line"><span class="tname">检查URL</span><div class="info-r">\
							<input name="site_check_url" class="bt-input-text mr5" placeholder="设置检查的URL,例如 [ https://www.baidu.com ]" type="text" value="'+ row['site_check_url'] +'" style="width:300px;">\
							</div></div></div><div class="line"><span class="tname">关键字/词</span><div class="info-r">\
							<input name="site_check_word" class="bt-input-text mr5" placeholder="设置关键字/词 [ 百度 ]" type="text" value="'+ row['site_check_word'] +'" style="width:300px;">\
						</div></div>'
					$('.check_type_line').html(push_time+_html);
				break;
				case "check_ssl_expired":
					$('.check_type_line').html('<div class="line"><span class="tname">每天检测时间</span><div class="info-r"><input name="report" class="bt-input-text mr5" type="number" min="0" max="23" maxlength="2" value="'+ (row['report']?row['report']:10) +'"><span>点</span></div></div><div class="line"><span class="tname">有效期剩余</span><div class="info-r"><input name="check_time" class="bt-input-text mr5" type="number" min="0" max="30" maxlength="2" value="'+ (row['check_time']?row['check_time']:15) +'"><span>天，发送警告邮件</span></div></div>');
				break;
				case "service":
					var isCheckType = type?row.services:[]
						push_time += '<div class="line">' +
									'<span class="tname">检查时间</span>' +
									'<div class="info-r">' +
										'<input name="check_time" class="bt-input-text mr5" placeholder="检查时间" type="text" type="number" min="1"   value="' + row.check_time + '" style="width:27%" >' +
									'分钟</div>' +
								'</div>'+
								'<div class="line">' +
									'<span class="tname">自动重启</span>'+
									'<div class="info-r">' +
										'<div style="display:inline-block;">'+
											'<input class="btswitch btswitch-ios" id="act" name="act" '+ (row['act'] == '1'?'checked="checked"':'') +' type="checkbox">'+
											'<label class="btswitch-btn" for="act" style="position: relative;top: 6px;"></label>'+
										'</div>'+
									'</div>'+
								'</div>';
					this.get_service_list(function (res){
						_html += '<div class="line"><span class="tname">服务类型</span><div class="info-r">'
						$.each(res,function (index,item){
							_html += '<div class="inlineBlock module-check">' +
									'<label class="cursor-pointer form-checkbox-label" style="margin-right:10px;">' +
									'<i class="form-checkbox cursor-pointer mr5 ' + ($.inArray(item.check_name, isCheckType) >= 0 ? 'active' : '') + '" ></i>' +
									'<input type="checkbox" class="form—checkbox-input hide mr10" ' + ($.inArray(item.check_name, isCheckType) >= 0 ? 'checked' : '') + '>' +
									'<span class="vertical_middle">' + item.check_name + '</span>' +
									'</label>' +
									'</div>'
						})
						_html += '</div></div>'
						$('.check_type_line').html(push_time+_html)
						$('.module-check').on('click','label',function(e){
							var iCheck = $(this).find('i'),iStatus = $(this).find('input');
							if(iCheck.hasClass('active')){
								iCheck.removeClass('active');
								iStatus.attr('checked',false);
							}else{
								iCheck.addClass('active');
								iStatus.attr('checked',true);
							}
							e.stopPropagation();
							e.preventDefault()
						})
					})
				break;
			}
		},
        // 获取网卡
        get_net_card:function(callback){
			var loadT = layer.msg('正在获取系统网卡，请稍候...', {icon: 16, time: 0,shade: 0.3});
			$.post('/plugin?action=a&name=msg_push&s=GetNetCard', function (res) {
				layer.close(loadT);
				if(res.status === false){
					layer.msg(res.msg,{icon:res.status?1:2});
				}
				if (callback)callback(res)
			});
        },
		// 获取访问UA
		get_ua_options: function (list, row) {
			var _html = '',_option = '',is_exit = '',name = this.data.ua[0].value;
			if(row) {
				name = this.data.ua.filter(function (val) {
					return val.value == row.ua_key;
				}).length ? row.ua_key : 'other';
			}
			for (var i = 0; i < list.length; i++) {
				_option += '<option value="' + list[i].value + '" ' + (list[i].value == name ? 'selected="selected"' : '') + '>' + list[i].title + '</option>';
			}
			_html = '<select name="ua_type" class="bt-input-text">'+ _option +'</select><input name="ua_key" class="bt-input-text ml10" placeholder="请输入自定义UA" '+ (name == 'other' ? '' : 'readonly') +' value="'+ (row ? row.ua_key : this.data.ua[0].value) +'" title="'+ (row ? row.ua_key : this.data.ua[0].value) +'" type="text" style="width:300px;">'
			return _html;
		},
		// 获取站点域名
		get_site_domain:function(list,item,type) {
			var _option = '';
			if (type) {
				list == undefined?list = {}:list
				for (var i in list) {
					_option += '<option value="' + i + '" ' + ( i == item ? 'selected="selected"' : '') + '>' + i + '</option>';
				}
			} else {
				list == undefined?list = []:list
				for (var i = 0; i < list.length; i++) {
					_option += '<option value="' + list[i] + '" ' + ( list[i] == item ? 'selected="selected"' : '') + '>' + list[i] + '</option>';
				}
			}
			return _option;
		},
		//获取服务状态
		get_check_server: function (callback) {
			var loadT = layer.msg('正在获取服务状态，请稍候...', {icon: 16, time: 0,shade: 0.3});
			$.post('/plugin?action=a&name=msg_push&s=CheckServer', function (res) {
				layer.close(loadT);
				if (callback) callback(res)
			});
		},
		// 获取站点域名列表
		get_local_site_list: function (callback) {
			var loadT = layer.msg('正在获取站点域名，请稍候...', {icon: 16, time: 0,shade: 0.3});
			$.post('/plugin?action=a&name=msg_push&s=get_local_site_list', function (res) {
				layer.close(loadT);
				if (callback) callback(res)
			});
		},
		// 获取常用服务列表
		get_service_list: function (callback){
			var loadT = layer.msg('正在获取常用服务列表，请稍候...', {icon: 16, time: 0,shade: 0.3});
			$.post('/plugin?action=a&name=msg_push&s=get_service_list', function (res) {
				layer.close(loadT);
				if (callback) callback(res)
			});
		},
		// 推送信息请求
		push_request: function (type, obj, callback, index) {
			var _this = this, group = {};
			if (typeof callback != 'function') index = callback;
			switch (type) {
				case 'add':
					group = { tips: '正在添加监控推送内容，请稍候...', type: 'create_msg_even' }
					break;
				case 'edit':
					group = { tips: '正在保存监控推送内容，请稍候...', type: 'modify_msgpush' }
					break;
				case 'open':
					group = { tips: obj.open ? '正在开启该监控推送，请稍候...' : '正在关闭该监控推送，请稍候...', type: 'modify_msgpush' }
					break;
				case 'del':
					group = { tips: '正在删除监控推送[ ' + obj.push_name + ' ]，请稍候...', type: 'remove_msgpush' }
					break;
				case 'start':
					group = { tips: '正在启动监控推送，请稍候...', type: 'StartServer' }
					break;
				case 'stop':
					group = { tips: '正在停止监控推送，请稍候...', type: 'StopServer' }
					break;
			}
			var load = layer.msg(group.tips, { icon: 16, time: 0, shade: [0.3, '#000'] });
			$.post('/plugin?action=a&name=msg_push&s=' + group.type, obj, function (res) {
				layer.close(load);
				layer.msg(res.msg, { icon: res.status ? 1 : 2, time: 1500 }, function () {
				    if (typeof callback == 'function') callback(res);
				    if (res.status) {
				        layer.close(index);
				        _this.get_event_list();
				    }
				});
			});
		},
		// 过滤器推送类型
		filter_push_type: function (type) {
			var filter_type = '';
			switch (type) {
				case 'mail':
					filter_type = '宝塔邮件API';
				break;
				case 'dingding':
					filter_type = '钉钉';
				break;
				case 'msg_mail':
					filter_type = '邮件';
				break;
				case 'sms':
				    filter_type = '短信'
			}
			return filter_type;
		},
		// 获取邮箱列表
		get_mail_list: function () {
			var _this = this;
			var load = layer.load();
			$.get('/plugin?action=a&name=msg_push&s=get_email_list', function (res) {
				layer.close(load);
				var content = '';
				for (var i = res.emails.length - 1; i >= 0; i--) {
					content += '<tr>' +
						'<td>' + res.emails[i] + '</td>' +
						'<td style="text-align: right;"><a href="javascript:;"  class="btlink  del_mail" data-mail=' + res.emails[i] + '>删除</a></td>' +
						'</tr>'
				}
				if (res.emails.length == 0) {
					conter = '<tr ><td colspan="4">当前没有数据</td></tr>'
				}
				$('.mail_body tbody').html(content);
				setTimeout(function () {
					$('.del_mail').click(function () {
						var mail = $(this).attr('data-mail');
						var confirm = layer.confirm('是否删除该邮箱<a href="javascript:;" class="btlink">&nbsp;[' + mail + ']</a>&nbsp; ', { title: '警告', btn: ['确定', '取消'], icon: 0 }, function () {
							_this.mail_request('del', { email: mail }, confirm);
						});
					});
				}, 500);
			});
		},
		// 邮箱事件视图
		mail_event_view: function (mail) {
			var mail_type = 0, _this = this;
			if (mail == undefined) {
				mail_type = 0;
				mail = '';
			} else {
				mail_type = 1;
			}
			var mail_view = layer.open({
				type: 1,
				closeBtn: 2,
				title: mail_type == 0 ? '添加邮箱' : '编辑邮箱 [&nbsp;' + mail + '&nbsp;]',
				area: '380px',
				shadeClose: false,
                btn: ['提交', '取消'],
				content: '<div class="bt-form bt-form pd20">' +
					'<div class="line">' +
                        '<span class="tname">邮箱地址</span>' +
                        '<div class="info-r"><input name="mail" class="bt-input-text mr5" placeholder="请输入邮箱地址" type="text" value="' + mail + '" style="width:200px;"></div>' +
					'</div>' +
                    '<div class="line"><div style="margin-left: 34px;height: 25px;line-height: 25px;color: red;">*&nbsp;必须将msg@bt.cn白名单才能收到信息</div></div>'+
					'</div>',
                yes:function(index,layero){
                    var mail = $('[name=mail]').val();
                    if(mail == ''){
                        layer.msg('邮箱地址不能为空！');
                        return false;
                    }
                    _this.mail_request('add', { email: mail }, mail_view);
                }
			});
		},
		// 邮箱请求
		mail_request: function (type, obj, callback, index) {
			var _this = this, group = {};
			if (typeof callback != 'function') index = callback;
			switch (type) {
				case 'add':
					group = { tips: '正在添加邮箱号码，请稍候...', type: 'add_email' }
					break;
				case 'del':
					group = { tips: '正在删除邮箱号码[ ' + obj.push_name + ' ]，请稍候...', type: 'remove_email' }
					break;
			}
			var load = layer.msg(group.tips, { icon: 16, time: 0, shade: [0.3, '#000'] });
			$.post('/plugin?action=a&name=msg_push&s=' + group.type, obj, function (res) {
				layer.close(load);
				layer.msg(res.msg, { icon: res.status ? 1 : 0 });
				if (typeof callback == 'function') callback(res);
				if (res.status) layer.close(index);
				_this.get_mail_list();
			});
		},
		// 获取推送日志列表,参数:分页page
		get_push_log: function (page) {
			var _this = this;
			if (page == undefined) page = 1;
			var load = layer.msg('正在获取日志信息，请稍候...', { icon: 16, time: 0, shade: [0.3, '#000'] });
			$.get('/plugin?action=a&name=msg_push&s=get_logs&tojs=MSG_log&p=' + page, function (rdata) {
				layer.close(load);
				var content = '', rdatas = rdata.data, rdataPage = rdata.page, reg = /onclick='MSG_log\((\d+)\)'/g;
				for (var i = 0; i < rdatas.length; i++) {
					content += '<tr><td><div class="ov" title=\'' + rdatas[i].log + '\'>' + rdatas[i].log + '</div></td><td>' + rdatas[i].addtime + '</td></tr>';
				}
				$('.logs_body tbody').html(content);
				$('.logs_body .page').html(rdataPage.replace(reg, 'data-page=\'$1\''));
				setTimeout(function () {
					$('.logs_body .page a').click(function (e) {
						var page = $(this).attr('data-page');
						_this.get_push_log(page);
						return false;
					});
				}, 500);
			});
		},
	}
	jQuery.prototype.serializeObject=function(){  
		var obj=new Object();  
		$.each(this.serializeArray(),function(index,param){  
			if(!(param.name in obj)){  
				obj[param.name]=param.value;  
			}  
		});  
		return obj;  
	};  
	// 对象深拷贝
	function objDeepCopy(source) {
		var sourceCopy = source instanceof Array ? [] : {};
		for (var item in source) {
			sourceCopy[item] = typeof source[item] === 'object' ? objDeepCopy(source[item]) : source[item];
		}
		return sourceCopy;
	}
	function get_object_first_attribute(data,type){
		for (var key in data){
			if(type){
				return key;
			}else{
				return data[key];
			}
		}
			
	}
	msg_push.bind();
</script>