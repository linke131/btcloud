<style>
.db_config_line .line{
    padding: 0;
    padding-bottom: 1px;
}
.db_config_line .tname {
    width: 155px;
    padding-right: 10px;
    height: 30px;
    line-height: 30px;
}
.db_config_line .info-r {
    margin-bottom: 0px;
}
/* .db_config_line .line:nth-child(1) .ml0 {
    margin-bottom: 10px;
    padding-left: 95px;
    padding-bottom: 8px;
    border-bottom: 1px solid #ccc;
} */
.span_overflow_hidden{
    display: inline-block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.info-r.export_db_box {
    position: relative;
}
#export_button:hover{
    background-color: #fff;
    border-color: #ccc;
    color:#000;
}
.export_data_ul{
    width: 230px;
    padding: 0;
    max-height: 160px;
    overflow: auto;
}
.export_data_li{
    line-height: 26px;
    border-bottom: 1px solid #ccc;
    padding: 0 10px;
}
/* 慢查询出现次数 */
.slow_stat_tips{
    position: fixed;
    width: 360px;
    box-shadow: 0 0 5px 2px #ececec;
    border: 1px solid #ddd;
    background-color: #fff;
    z-index: 999;
    padding:5px;
}
.slow_stat_tips_radius{
    position: absolute;
    content: '';
    right: -12px;
    border-top: 6px transparent dashed;
    border-left: 6px #fff dashed;
    border-right: 6px transparent dashed;
    border-bottom: 6px transparent solid;
}
/* 慢查询出现次数 end */
</style>
<div class="bt-form db_monitor_config">
    <div class="bt-w-main">
        <div class="bt-w-menu">
            <p class="bgw" data-type="db_status">状态监控</p>
            <p data-type="majorization">索引优化</p>
            <p data-type="config_majorization">配置优化</p>
            <p data-type="binary_log">二进制管理</p>
            <p data-type="view_log">操作日志</p>
        </div>
        <div class="bt-w-con pd15">
            <div class="materCon"></div>
        </div>
    </div>
</div>
<script type="text/javascript">
var db_monitor = {
    plugin_name: 'database_mater',
    //推荐优化方案
    mysql_select: {
        '1': {
            title: '1-2GB', data: {
                key_buffer_size: 128,
                query_cache_size: 64,
                tmp_table_size: 64,
                innodb_buffer_pool_size: 256,
                sort_buffer_size: 768,
                read_buffer_size: 768,
                read_rnd_buffer_size: 512,
                join_buffer_size: 1024,
                thread_stack: 256,
                binlog_cache_size: 64,
                thread_cache_size: 64,
                table_open_cache: 128,
                max_connections: 100
            }
        },
        '2': {
            title: '2-4GB', data: {
                key_buffer_size: 256,
                query_cache_size: 128,
                tmp_table_size: 384,
                innodb_buffer_pool_size: 384,
                sort_buffer_size: 768,
                read_buffer_size: 768,
                read_rnd_buffer_size: 512,
                join_buffer_size: 2048,
                thread_stack: 256,
                binlog_cache_size: 64,
                thread_cache_size: 96,
                table_open_cache: 192,
                max_connections: 200
            }
        },
        '3': {
            title: '4-8GB', data: {
                key_buffer_size: 384,
                query_cache_size: 192,
                tmp_table_size: 512,
                innodb_buffer_pool_size: 512,
                sort_buffer_size: 1024,
                read_buffer_size: 1024,
                read_rnd_buffer_size: 768,
                join_buffer_size: 2048,
                thread_stack: 256,
                binlog_cache_size: 128,
                thread_cache_size: 128,
                table_open_cache: 384,
                max_connections: 300
            }
        },
        '4': {
            title: '8-16GB', data: {
                key_buffer_size: 512,
                query_cache_size: 256,
                tmp_table_size: 1024,
                innodb_buffer_pool_size: 1024,
                sort_buffer_size: 2048,
                read_buffer_size: 2048,
                read_rnd_buffer_size: 1024,
                join_buffer_size: 4096,
                thread_stack: 384,
                binlog_cache_size: 192,
                thread_cache_size: 192,
                table_open_cache: 1024,
                max_connections: 400
            }
        },
        '5': {
            title: '16-32GB', data: {
                key_buffer_size: 1024,
                query_cache_size: 384,
                tmp_table_size: 2048,
                innodb_buffer_pool_size: 4096,
                sort_buffer_size: 4096,
                read_buffer_size: 4096,
                read_rnd_buffer_size: 2048,
                join_buffer_size: 8192,
                thread_stack: 512,
                binlog_cache_size: 256,
                thread_cache_size: 256,
                table_open_cache: 2048,
                max_connections: 500
            }
        }
    },
    db_list: 0,
    all_db_list: [],
    slow_select_name: '',
    slow_public_data:{},    // 慢查询概览公共数据
    ajaxList:{
        'get_local_database2':'获取数据库列表',
        'get_run_status':'获取数据库状态',
        'get_comprehensive_score':'对数据库评估',
        'get_optimization_log':'获取优化数据',
        'get_db_config':'获取配置数据',
        'get_mysql_bin':'获取二进制文件列表',
        'set_automatic_backup':'设置自动备份状态',
        'get_backup_mysql_bin':'获取已备份文件',
        'get_backup_log':'获取备份日志',
        'backup_mysql_bin':'备份数据',
        'del_bin_log_file':'删除二进制文件',
        'analysis_bin_log':'分析二进制文件',
        'get_local_log':'获取操作日志',
        'automatic_optimization':'自动优化SQL语句',
        'optimization':'优化SQL语句',
        'select_testing':'测试SQL语句',
        'set_retry':'重试优化',
        'set_revoke':'撤销优化',
        'export_db_sql':'导出数据',
    },
    init: function(){
        var _that = this;
        $('.layui-layer-page').width(800);
        _that.db_status();
        $(".bt-w-menu p").click(function(){
            $(this).addClass("bgw").siblings().removeClass("bgw");
            _that[$(this).data('type')]()
        })
        // 优化方案select点击时
        $("body").on("change",".mysql_set",function(){
            if($(this).val() > 0){
                var data = _that.mysql_select[$(this).val()].data;
                for (var key in data) $('.' + key).val(data[key]);
            }
        });
        //索引优化分页
        $("body").on('click','#majorization-page a',function(e){
            var _href = $(this).attr('href');
            var page = _href.match(/p=([0-9]*)/)[1]
            _that.majorization(page);
            e.preventDefault();
            e.stopPropagation();
        })
        //查看已备份分页
        $("body").on('click','#backup_view_log a',function(e){
            var _href = $(this).attr('href');
            var page = _href.match(/p=([0-9]*)/)[1]
            _that.render_backup_log(page);
            e.preventDefault();
            e.stopPropagation();
        })
        // 操作日志分页
        $("body").on('click','#log_page a',function(e){
            var _href = $(this).attr('href');
            var page = _href.match(/p=([0-9]*)/)[1]
            _that.view_log(page);
            e.preventDefault();
            e.stopPropagation();
        })
    },
    // 数据库状态
    db_status:function(){
        this.ajaxTask('get_run_status',function(rdata){
            rdata = rdata.data
            var _Con = '';
            if(rdata.File == 'OFF') return layer.msg('数据库二进制日志未开启',{icon:2});
            var cache_size = ((parseInt(rdata.Qcache_hits) / (parseInt(rdata.Qcache_hits) + parseInt(rdata.Qcache_inserts))) * 100).toFixed(2) + '%';
            if (cache_size == 'NaN%') cache_size = 'OFF';
            var title10 = ((1 - rdata.Threads_created / rdata.Connections) * 100).toFixed(2);
            var title11 = ((1 - rdata.Key_reads / rdata.Key_read_requests) * 100).toFixed(2);
            var title12 = ((1 - rdata.Innodb_buffer_pool_reads / rdata.Innodb_buffer_pool_read_requests) * 100).toFixed(2);
            var title14 = ((rdata.Created_tmp_disk_tables / rdata.Created_tmp_tables) * 100).toFixed(2);
            _Con = '<div style="text-align: right; margin-bottom:10px">\
            <button class="btn btn-success btn-sm" onclick="db_monitor.get_assess()">风险评估</button>\
                </div>\
            <div class="divtable" style="height: 480px;overflow: auto;"><table class="table table-hover table-bordered" style="margin-bottom:10px;background-color:#fafafa">\
                <tbody>\
                    <tr><th>'+ lan.soft.mysql_status_title1 + '</th><td>' + getLocalTime(rdata.Run) + '</td><th>' + lan.soft.mysql_status_title5 + '</th><td>' + parseInt(rdata.Questions / rdata.Uptime) + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title2 + '</th><td>' + rdata.Connections + '</td><th>' + lan.soft.mysql_status_title6 + '</th><td>' + parseInt((parseInt(rdata.Com_commit) + parseInt(rdata.Com_rollback)) / rdata.Uptime) + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title3 + '</th><td>' + ToSize(rdata.Bytes_sent) + '</td><th>' + lan.soft.mysql_status_title7 + '</th><td>' + rdata.File + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title4 + '</th><td>' + ToSize(rdata.Bytes_received) + '</td><th>' + lan.soft.mysql_status_title8 + '</th><td>' + rdata.Position + '</td></tr>\
                    <tr><th>QPS</th><td>' + parseInt(rdata.qps) + '</td><th>IO</th><td>' + rdata.mysql_io_write_speed + '</td></tr>\
                    <tr><th>CPU开销</th><td>' + rdata.mysql_system_cpu + '</td><th>内存开销</th><td>' + ToSize(rdata.mysql_memory) + '</td></tr>\
                    <tr><th>慢查询</th><td>' + (rdata.slow_query_log.slow_query_log == 'NO'? '已开启': '已关闭') + '</td><th>数据库大小</th><td>' + rdata.mysql_count_size + '</td></tr>\
                </tbody>\
                </table>\
                <table class="table table-hover table-bordered">\
                <thead style="display:none;"><th></th><th></th><th></th><th></th></thead>\
                <tbody>\
                    <tr><th>'+ lan.soft.mysql_status_title9 + '</th><td>' + rdata.Threads_running + '/' + rdata.Max_used_connections + '</td><td colspan="2">' + lan.soft.mysql_status_ps1 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title10 + '</th><td>' + (!isNaN(title10)?title10:'0') + '%</td><td colspan="2">' + lan.soft.mysql_status_ps2 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title11 + '</th><td>' + (!isNaN(title11)?title11:'0') + '%</td><td colspan="2">' + lan.soft.mysql_status_ps3 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title12 + '</th><td>' + (!isNaN(title12)?title12:'0') + '%</td><td colspan="2">' + lan.soft.mysql_status_ps4 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title13 + '</th><td>' + cache_size + '</td><td colspan="2">' + lan.soft.mysql_status_ps5 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title14 + '</th><td>' + (!isNaN(title14)?title14:'0') + '%</td><td colspan="2">' + lan.soft.mysql_status_ps6 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title15 + '</th><td>' + rdata.Open_tables + '</td><td colspan="2">' + lan.soft.mysql_status_ps7 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title16 + '</th><td>' + rdata.Select_full_join + '</td><td colspan="2">' + lan.soft.mysql_status_ps8 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title17 + '</th><td>' + rdata.Select_range_check + '</td><td colspan="2">' + lan.soft.mysql_status_ps9 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title18 + '</th><td>' + rdata.Sort_merge_passes + '</td><td colspan="2">' + lan.soft.mysql_status_ps10 + '</td></tr>\
                    <tr><th>'+ lan.soft.mysql_status_title19 + '</th><td>' + rdata.Table_locks_waited + '</td><td colspan="2">' + lan.soft.mysql_status_ps11 + '</td></tr>\
                <tbody>\
                </table></div>'
            $(".materCon").html(_Con);
        });
    },
    // 风险评估按钮
    get_assess:function(){
        this.ajaxTask('get_comprehensive_score',function(rdata){
            rdata = rdata.data
            layer.open({
                type: 1,
                shift: 5,
                closeBtn: 2,
                area: '450px',
                title: '风险分数【'+rdata.fraction+'分】',
                content:'<div class="pd15 divtable"><table class="table table-hover">\
                    <thead><tr>\
                        <th>提醒</th>\
                    </tr></thead>\
                    <tbody id="assess_table"></tbody>\
                </table></div>',
                success:function(layero,index){
                    var _tbody = '';
                    if(rdata.msg_list.length >0){
                        for(var i= 0; i<rdata.msg_list.length; i++){
                            _tbody += '<tr>\
                            <td>'+rdata.msg_list[i]+'</td>\
                            </tr>'
                        }
                    }else{
                        _tbody = '<tr><td colspan="2" style="text-align:center">没有数据</td></tr>'
                    }
                    $("#assess_table").html(_tbody);
                }
            })
        })
    },
    // 索引优化
    majorization:function(){
        var that = this;
        var _html = '慢查询数据库 <select name="db_bank_list" class="bt-input-text mr5"></select>'+
            '<button class="btn btn-success btn-sm slow_optimization">一键优化</button>'+
            '<div class="pull-right">'+
                '<button class="btn btn-default btn-sm mr5" onclick="db_monitor.slow_optimization_list()">优化列表</button>'+
                '<button class="btn btn-default btn-sm" onclick="db_monitor.slow_optimization_operate()">优化记录</button>'+
            '</div>'+
            '<div id="slow_query_table"></div>';

        $(".materCon").html(_html);

        // 表格加载
        this.render_slow_query_table();

        // 一键优化
        $('.slow_optimization').on('click',function(){
            var db_name = $('[name=db_bank_list]').val()
            if(db_name == 'no_slow_index') return bt_tools.msg({status:true,msg:'没有数据库需要优化'})
            bt.confirm({ title: '一键优化', msg: '一键优化【'+(db_name == ''?'所有数据库':db_name)+'】中慢查询的语句，是否继续？'}, function (indexs) {
                layer.close(indexs)
                that.optimization_log({api:'all_optimization',param:{db_name:db_name},type:'all'})
            });
        })
    },
    /**
     * @descripttion: 渲染慢查询表格
     * @author: Lifu
     * @return viod
    */
    render_slow_query_table:function(){
        var that = this,fixedThead= true,num = 0;
        var slow_query_table = bt_tools.table({
            el:'#slow_query_table',
            url:'/plugin?action=a&name=database_mater&s=get_slow_log',
            default:'暂无慢查询数据',
            height: 390,
            dataFilter:function(res){
                that.slow_public_data = res.data;
                that.render_slow_public_data();
                return {data:res.data.slow_query_list,page:res.data.page.page};
            },
            beforeRequest:function(beforeData){
                return $.extend(beforeData,{db_name:that.slow_select_name})
            },
            column:[
                {
                    type: 'checkbox',
                    width: 20
                },
                {
                    fid: 'query_sql',
                    title: '慢查询语句',
                    width:430,
                    template:function(row){
                        // 字符转义
                        var query_sql = bt.replace_all(row.query_sql,'\"','&quot;')
                        return '<div><span class="span_overflow_hidden" style="width:355px;vertical-align: top;" title="'+query_sql+'">'+query_sql+'</span>\
                            <span class="ico-copy cursor ml10 slow_query_sql" title="复制语句" data-pw="\''+query_sql+'\'"></span>\
                        </div>'
                    }
                },
                {
                    title: '出现次数',
                    template:function(row){
                        return '<span class="slow_stat--block" data-id="'+row.id+'">'+row.list.length+'<a class="btlink">(查看)</a></span>'
                    }
                },
                {
                    title: "操作",
                    type: 'group',
                    align: 'right',
                    group: [{
                        title: '索引优化',
                        event: function (row, index, ev, key) {
                            // 点击时的操作
                            bt.confirm({ title: '索引优化', msg: '将对当前语句进行索引优化，是否继续？'}, function (indexs) {
                                layer.close(indexs)
                                that.optimization_log({api:'optimization_sql',param:{sql_id:JSON.stringify([row.id])},type:'row'})
                            });
                        }
                    }]
                }
            ],
            tootls:[
                {
                    // 批量操作
                    type: 'batch', //batch_btn
                    positon: ['left', 'bottom'],
                    config: {
                        title:'索引优化',
                        callback:function(bThat){
                            bt.confirm({ title: '索引优化', msg: '批量对选中的语句索引优化，是否继续？'}, function (indexs) {
                                layer.close(indexs)
                                // 遍历list中的id组成数组
                                var id_list = [];
                                for(var i=0;i<bThat.check_list.length;i++){
                                    id_list.push(bThat.check_list[i].id)
                                }
                                that.optimization_log({api:'optimization_sql',param:{sql_id:JSON.stringify(id_list)},type:'row'})
                            });
                        }
                    }
                },
                {
                    //分页显示
                    type: 'page',
                    positon: ['right', 'bottom'], // 默认在右下角
                    pageParam: 'page', //分页请求字段,默认为 : p
                    page: 1, //当前分页 默认：1
                    numberParam: 'page_size',//分页数量请求字段默认为 : limit
                }],
            success:function(config){
                if(fixedThead){
                    num++;
                    if(num >= 2){
                        // 鼠标经过增加tips展示
                        $('#slow_query_table').on('mouseover','.slow_stat--block',function(ev){
                            var id = $(this).data('id'),
                                item = config.data.find(function(item){return item.id == id}) // 获取当前行数据
                            // 根据型数据显示tips
                            that.open_slow_stat_tips(item.list,ev)
                        }).on('mouseout','.slow_stat--block',function(e){
                            // 不在含有stat_tips的元素内
                            if(e.relatedTarget.className.indexOf('stat_tips') == -1){
                                $('.slow_stat_tips').remove()
                            }
                        })
                    }
                }
            }
        })
        // 复制语句
        $('#slow_query_table').on('click','.slow_query_sql',function(){
            var _copy = $(this).attr('data-pw');
            bt.pub.copy_pass(_copy);
        })
    },
    /**
     * @descripttion: 显示语句tips信息
     * @author: Lifu
     * @param {Object} row 当前行数据
     * @param {String} ev 当前元素
     * @return viod
     */
    open_slow_stat_tips:function(slowList,ev){
        $('.slow_stat_tips').remove()   // 移除之前的tips
        var that = this,
            tips = '',
            _tbody = '',
            evTopHeight = $(ev.target).offset().top + $(ev.target).outerHeight() - $(window).scrollTop(),// 偏离高度(元素距离文档顶部的偏移+元素本身的高度-滚动条的高度)
            evLeftWidth = $(ev.target).offset().left;// 偏离宽度
        
        // 渲染tbody信息
        slowList.forEach(function(item,index){
            _tbody += '<tr>\
                <td style="width:45px">'+index+'</td>\
                <td style="width:75px">'+item.query_time+'</td>\
                <td style="width:75px">'+item.lock_time+'</td>\
                <td>'+getLocalTime(new Date(item.log_time).getTime())+'</td>\
            </tr>'
        })
        // tips模板
        tips = '<div class="slow_stat_tips">\
            <div class="divtable"><table class="table table-hover">\
                <thead><tr>\
                    <th width=45>序号</th>\
                    <th width=75>耗时(秒)</th>\
                    <th width=75>锁表(秒)</th>\
                    <th >出现时间</th>\
                </tr></thead>\
            </table><div style="overflow:auto; max-height:200px"><table class="table table-hover">\
                <tbody id="slow_index--table">'+_tbody+'</tbody></table></div>\
            </div><i class="slow_stat_tips_radius"></i></div>'
        // 根据数据长度判断tips的高度
        if(slowList.length == 1){
            evTopHeight+=90
        }else if(slowList.length == 2){
            evTopHeight+=70
        }
        $('.db_monitor_config').append($(tips).css({left:evLeftWidth-370+'px',top:evTopHeight-130+'px'}))
        $('.slow_stat_tips').find('td,tr,th').addClass('stat_tips')

        // 判断tips是否超出边界
        var tipsHeight = $('.slow_stat_tips').outerHeight(),
            winHeight = $(window).height(),
            tipsTop = $('.slow_stat_tips').offset().top;
        if(tipsTop + tipsHeight > winHeight){
            var realHeight = evTopHeight-tipsHeight
            $('.slow_stat_tips').css({top:realHeight+50+'px'})
            // i标签跟随
            $('.slow_stat_tips .slow_stat_tips_radius').css({top:tipsHeight-65+'px'})
        }else{
            $('.slow_stat_tips .slow_stat_tips_radius').css({top:(slowList.length == 1?28:(slowList.length == 2?47:115))+'px'})
        }
        // 鼠标离开弹窗时
        $('.slow_stat_tips').on('mouseout',function(e){
            if(e.relatedTarget.className.indexOf('stat_tips') == -1){
                $('.slow_stat_tips').remove()
            }
        })
    },
    /**
     * @descripttion: 渲染慢查询优化公共数据
     * @author: Lifu
     * @return viod
    */
    render_slow_public_data:function(){
        var that = this,
            opetionArr = this.slow_public_data.db_list,
            _option = '<option value="">所有数据库(次数:'+this.slow_public_data.total_num+')</option>';// 数据库列表
        if(opetionArr.length == 0){
            _option = '<option value="no_slow_index">暂无数据库</option>'
        }else{
            $.each(opetionArr,function(index,item){
                _option += '<option value="'+item.db_name+'" '+(that.slow_select_name == item.db_name?'selected = "selected"':'')+'>'+item.db_name+'(次数:'+item.total+')</option>'
            })
        }
        $('[name=db_bank_list]').html(_option)
        // 慢查询列表点击事件
        $('[name=db_bank_list]').unbind().on('change',function(){
            var _val = $(this).val()
            if(_val == 'no_slow_index') return false;
            that.slow_select_name = _val
            that.render_slow_query_table()
        })
    },
    /**
     * @descripttion: 渲染慢查询优化操作日志
     * @author: Lifu
     * @return viod
     */
    slow_optimization_operate:function(){
        bt_tools.open({
            title:'优化记录',
            area:['600px','470px'],
            btn:false,
            content:'<div id="slow_optimization_table" class="pd15"></div>',
            success:function(){
                bt_tools.table({
                    el:'#slow_optimization_table',
                    url:'/plugin?action=a&name=database_mater&s=get_optimization_log',
                    default:'暂无优化记录',
                    height: 350,
                    dataFilter:function(res){
                        return {data:res.data.operate_log,page:res.data.page.page}
                    },
                    column:[
                        {
                            fid: 'log',
                            title: '详情',
                            fixed:true,
                            width:410
                        },
                        {
                            fid: 'add_time',
                            title: '时间'
                        }
                    ],
                    tootls:[{
                        //分页显示
                        type: 'page',
                        positon: ['right', 'bottom'], // 默认在右下角
                        pageParam: 'page', //分页请求字段,默认为 : p
                        page: 1, //当前分页 默认：1
                        numberParam: 'page_size',//分页数量请求字段默认为 : limit
                    }],
                    success:function(){
                        // 调整样式
                        $('#slow_optimization_table').find('.divtable').removeClass('mtb10').addClass('mb10')
                    }
                })
            }
        })
    },
    /**
     * @descripttion: 渲染慢查询优化列表
     * @author: Lifu
     * @return viod
     */
    slow_optimization_list:function(){
        var that = this;
        bt_tools.open({
            title:'优化列表',
            area:['630px','470px'],
            btn:false,
            content:'<div id="slow_optimization_table" class="pd15"></div>',
            success:function(){
                var slow_optimization_table = bt_tools.table({
                    el:'#slow_optimization_table',
                    url:'/plugin?action=a&name=database_mater&s=get_optimization_index_log',
                    default:'暂无优化记录',
                    height: 354,
                    dataFilter:function(res){
                        return {data:res.data.index_log,page:res.data.page.page}
                    },
                    column:[
                        {
                            type: 'checkbox',
                            width: 20
                        },
                        {
                            fid: 'db_name',
                            title: '数据库',
                            fixed:true,
                            width:130
                        },
                        {
                            fid: 'tb_name',
                            title: '表名',
                            fixed:true,
                            width:100
                        },
                        {
                            fid: 'field',
                            title: '字段名',
                            fixed:true,
                            width:100
                        },
                        {
                            fid: 'add_time',
                            title: '时间'
                        },
                        {
                            title: "操作",
                            type: 'group',
                            align: 'right',
                            group: [{
                                title: '删除索引',
                                event: function (row, index, ev, key) {
                                    // 点击时的操作
                                    bt.confirm({ title: '删除索引', msg: '即将删除字段名['+row.field+']的索引，是否继续？'}, function (indexs) {
                                        layer.close(indexs)
                                        bt_tools.send({url:'/plugin?action=a&name=database_mater&s=del_optimization_index',data:{index_id:JSON.stringify([row.id])}},function(res){
                                            if(res.status){
                                                slow_optimization_table.$refresh_table_list()
                                            }
                                            
                                            var sConfig = {
                                                title:'删除索引',
                                                th:'索引名称',
                                                html:that.render_slow_query_sucess_list(res)
                                            }
                                            bt_tools.$batch_success_table(sConfig)
                                        },'删除索引')
                                    });
                                }
                            }]
                        }
                    ],
                    tootls:[{
                        // 批量操作
                        type: 'batch', //batch_btn
                        positon: ['left', 'bottom'],
                        config: {
                            title: '删除索引',
                            url: '/plugin?action=a&name=database_mater&s=del_optimization_index',
                            paramName: 'index_id',
                            beforeRequest:function(list){
                                // 遍历list中的id组成数组
                                var id_list = [];
                                for(var i=0;i<list.length;i++){
                                    id_list.push(list[i].id)
                                }
                                return JSON.stringify(id_list)
                            },
                            theadName: '详情',
                            refresh: true,
                        }
                    },{
                        //分页显示
                        type: 'page',
                        positon: ['right', 'bottom'], // 默认在右下角
                        pageParam: 'page', //分页请求字段,默认为 : p
                        page: 1, //当前分页 默认：1
                        numberParam: 'page_size',//分页数量请求字段默认为 : limit
                    }],
                    success:function(){
                        $('#slow_optimization_table').find('.divtable').removeClass('mtb10').addClass('mb10')
                    }
                })
            }
        })
    },
    /**
     * @descripttion: 渲染慢查询优化列表
     * @author: Lifu
     * @param res 接口返回的数据
     * @return 拼接的内容
     */
    render_slow_query_sucess_list:function(res){
        var tbody = '';
        $.each(res.error, function (key, item) {
            tbody += '<tr><td><span class="text-overflow" title="' + key + '">' + key + '</span/></td><td><div style="float:right;" class="size_ellipsis"><span style="color:red">' + item + '</span></div></td></tr>';
        });
        $.each(res.success, function (index, item) {
            tbody += '<tr><td><span class="text-overflow" title="' + item + '">' + item + '</span></td><td><div style="float:right;" class="size_ellipsis"><span style="color:#20a53a">操作成功</span></div></td></tr>';
        });
        return tbody;
    },
    /**
     * @descripttion: 优化日志
     * @author: Lifu
     * @param config.api 接口地址
     * @param config.param 参数
     * @param config.type 类型
     * @return 拼接的内容
     */
    optimization_log:function(config){
        var that = this,timer = null;
        layer.open({
            type: 1,
            shift: 5,
            closeBtn: 2,
            area: '450px',
            title: '优化日志',
            content:'<pre style="margin-bottom: 0px;height:250px;text-align: left;background-color: #000;color: #fff;white-space: pre-wrap;" id="slow_log"></pre>',
            success:function(){
                // 定时器请求数据
                timer = setInterval(function(){
                    bt_tools.send({url:'/plugin?action=a&name=database_mater&s='+config.api,data:config.param},function(res){

                        if(res.status && typeof res.type == 'undefined'){
                            clearInterval(timer)
                            switch(config.type){
                                case 'all':
                                    that.render_slow_query_table();
                                    break;
                                case 'row':
                                    that.render_slow_query_table();
                            }
                        }else if(!res.status){
                            clearInterval(timer)
                            
                            layer.msg(res.msg,{icon:2})
                            return false;
                        }
                        $('#slow_log').html(res.msg)
                        $('#slow_log').scrollTop(100000000000);
                    },{verify:false})
                },1500)
            },
            cancel:function(){
                clearInterval(timer)
            }
        });
    },
    // 索引 ---》 重试按钮
    optimiz_retry:function(id){
        this.ajaxTask('set_retry',{id:id},function(rdata){
            layer.msg(rdata.msg,{icon:rdata.status?1:2})
        })
    },
    // 索引 ---》 撤销按钮
    optimiz_revoke:function(id){
        var _that = this;
        this.ajaxTask('set_revoke',{id:id},function(rdata){
            layer.msg(rdata.msg,{icon:rdata.status?1:2})
            if(rdata.status) _that.majorization();
        })
    },
    // 配置优化
    config_majorization:function(){
        this.ajaxTask('get_db_config',function(rdata){
            rdata = rdata.data
            var _Con = ''
            var key_buffer_size = bt.format_size(rdata.key_buffer_size, false, 0, 'MB')
            var query_cache_size = bt.format_size(rdata.query_cache_size, false, 0, 'MB')
            var tmp_table_size = bt.format_size(rdata.tmp_table_size, false, 0, 'MB')
            var innodb_buffer_pool_size = bt.format_size(rdata.innodb_buffer_pool_size, false, 0, 'MB')
            var innodb_additional_mem_pool_size = bt.format_size(rdata.innodb_additional_mem_pool_size, false, 0, 'MB')
            var innodb_log_buffer_size = bt.format_size(rdata.innodb_log_buffer_size, false, 0, 'MB')

            var sort_buffer_size = bt.format_size(rdata.sort_buffer_size, false, 0, 'MB')
            var read_buffer_size = bt.format_size(rdata.read_buffer_size, false, 0, 'MB')
            var read_rnd_buffer_size = bt.format_size(rdata.read_rnd_buffer_size, false, 0, 'MB')
            var join_buffer_size = bt.format_size(rdata.join_buffer_size, false, 0, 'MB')
            var thread_stack = bt.format_size(rdata.thread_stack, false, 0, 'MB')
            var binlog_cache_size = bt.format_size(rdata.binlog_cache_size, false, 0, 'MB')
            var thread_cache_size = rdata.thread_cache_size;
            var table_open_cache = rdata.table_open_cache;
            var max_connections = rdata.max_connections;
            var a = key_buffer_size + query_cache_size + tmp_table_size + innodb_buffer_pool_size + innodb_additional_mem_pool_size + innodb_log_buffer_size
            var b = sort_buffer_size + read_buffer_size + read_rnd_buffer_size + join_buffer_size + thread_stack + binlog_cache_size
            var memSize = a + rdata.max_connections * b
            _Con = '<div class="bt-form db_config_line">\
                <div class="line"><div class="info-r m10" style="margin-bottom: 10px;padding-left: 95px;padding-bottom: 8px;border-bottom: 1px solid #ccc;">\
                    <span class="mr5">优化方案 <select class="bt-input-text mr5 mysql_set" name="mysql_set"></select><span>\
                    <span class="mr5">最大使用内存<input name="memSize" disabled="" class="bt-input-text mr5 memSize" type="text" style="width:70px" value="'+memSize.toFixed(2)+'"></span>\
                    <span class="c9 mt10">MB</span>\
                </div></div>\
                <div class="line">\
                    <span class="tname">key_buffer_size</span>\
                    <div class="info-r ">\
                        <input name="key_buffer_size" class="bt-input-text mr5 key_buffer_size" type="number" style="width:70px" value="'+key_buffer_size+'">\
                        <span class="c9 mt10 mr5">MB, <font>用于索引的缓冲区大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">query_cache_size</span>\
                    <div class="info-r ">\
                        <input name="query_cache_size" class="bt-input-text mr5 query_cache_size" type="number" style="width:70px" value="'+query_cache_size+'">\
                        <span class="c9 mt10 mr5">MB, <font>查询缓存,不开启请设为0</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">tmp_table_size</span>\
                    <div class="info-r ">\
                        <input name="tmp_table_size" class="bt-input-text mr5 tmp_table_size" type="number" style="width:70px" value="'+tmp_table_size+'">\
                        <span class="c9 mt10 mr5">MB, <font>临时表缓存大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">innodb_buffer_pool_size</span>\
                    <div class="info-r ">\
                        <input name="innodb_buffer_pool_size" class="bt-input-text mr5 innodb_buffer_pool_size" type="number" style="width:70px" value="'+innodb_buffer_pool_size+'">\
                        <span class="c9 mt10 mr5">MB, <font>Innodb缓冲区大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">innodb_log_buffer_size</span>\
                    <div class="info-r ">\
                        <input name="innodb_log_buffer_size" class="bt-input-text mr5 innodb_log_buffer_size" type="number" style="width:70px" value="'+innodb_log_buffer_size+'">\
                        <span class="c9 mt10 mr5">MB, <font>Innodb日志缓冲区大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">sort_buffer_size</span>\
                    <div class="info-r ">\
                        <input name="sort_buffer_size" class="bt-input-text mr5 sort_buffer_size" type="number" style="width:70px" value="'+(sort_buffer_size * 1024)+'">\
                        <span class="c9 mt10 mr5">KB * 连接数, <font>每个线程排序的缓冲大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">read_buffer_size</span>\
                    <div class="info-r ">\
                        <input name="read_buffer_size" class="bt-input-text mr5 read_buffer_size" type="number" style="width:70px" value="'+(read_buffer_size *1024)+'">\
                        <span class="c9 mt10 mr5">KB * 连接数, <font>读入缓冲区大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">read_rnd_buffer_size</span>\
                    <div class="info-r ">\
                        <input name="read_rnd_buffer_size" class="bt-input-text mr5 read_rnd_buffer_size" type="number" style="width:70px" value="'+(read_rnd_buffer_size * 1024)+'">\
                        <span class="c9 mt10 mr5">KB * 连接数, <font>随机读取缓冲区大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">join_buffer_size</span>\
                    <div class="info-r ">\
                        <input name="join_buffer_size" class="bt-input-text mr5 join_buffer_size" type="number" style="width:70px" value="'+(join_buffer_size * 1024)+'">\
                        <span class="c9 mt10 mr5">KB * 连接数, <font>关联表缓存大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">thread_stack</span>\
                    <div class="info-r ">\
                        <input name="thread_stack" class="bt-input-text mr5 thread_stack" type="number" style="width:70px" value="'+(thread_stack * 1024)+'">\
                        <span class="c9 mt10 mr5">KB * 连接数, <font>每个线程的堆栈大小</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">binlog_cache_size</span>\
                    <div class="info-r ">\
                        <input name="binlog_cache_size" class="bt-input-text mr5 binlog_cache_size" type="number" style="width:70px" value="'+(binlog_cache_size * 1024)+'">\
                        <span class="c9 mt10 mr5">KB * 连接数, <font>二进制日志缓存大小(4096的倍数)</font></span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">thread_cache_size</span>\
                    <div class="info-r ">\
                        <input name="thread_cache_size" class="bt-input-text mr5 thread_cache_size" type="number" style="width:70px" value="'+thread_cache_size+'">\
                        <span class="c9 mt10 mr5">线程池大小</span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">table_open_cache</span>\
                    <div class="info-r ">\
                        <input name="table_open_cache" class="bt-input-text mr5 table_open_cache" type="number" style="width:70px" value="'+table_open_cache+'">\
                        <span class="c9 mt10 mr5">表缓存(最大不要超过2048)</span>\
                    </div></div>\
                <div class="line ">\
                    <span class="tname">max_connections</span>\
                    <div class="info-r ">\
                        <input name="max_connections" class="bt-input-text mr5 max_connections" type="number" style="width:70px" value="'+max_connections+'">\
                        <span class="c9 mt10 mr5">最大连接数</span>\
                    </div></div>\
                <div class="line ">\
                    <div class="info-r ml0"style="text-align: right;">\
                        <button name="bt_mysql_restart" class="btn btn-success btn-sm mr5 ml5" onclick="db_monitor.mysql_restart()">重启数据库</button>\
                        <button name="bt_mysql_save" class="btn btn-success btn-sm mr5 ml5" onclick="db_monitor.mysql_save()">保存</button>\
                    </div></div>\
                </div>'
            $('.materCon').html(_Con);
        }) 
        this.config_select();
    },
    // 配置优化   option添加
    config_select:function(){
        var _sel = this.mysql_select,_option = '<option value="0">'+lan.soft.mysql_set_select+'</option>';
        for(var key in _sel){
            _option += '<option value="'+key+'">'+_sel[key].title+'</option>'
        }
        setTimeout(function(){
            $(".mysql_set").html(_option)
        },300);
    },
    // 配置优化  ---》重启数据库
    mysql_restart:function(){
        bt.pub.set_server_status('mysqld', 'restart');
    },
    // 配置优化  ---》 保存按钮
    mysql_save:function(){
        var mysql_set = $(".mysql_set").val();
        var memSize = $(".memSize").val();
        var key_buffer_size = $(".key_buffer_size").val();
        var query_cache_size = $(".query_cache_size").val();
        var tmp_table_size = $(".tmp_table_size").val();
        var innodb_buffer_pool_size = $(".innodb_buffer_pool_size").val();
        var innodb_log_buffer_size = $(".innodb_log_buffer_size").val();
        var sort_buffer_size = $(".sort_buffer_size").val();
        var read_buffer_size = $(".read_buffer_size").val();
        var read_rnd_buffer_size = $(".read_rnd_buffer_size").val();
        var join_buffer_size = $(".join_buffer_size").val();
        var thread_stack = $(".thread_stack").val();
        var binlog_cache_size = $(".binlog_cache_size").val();
        var thread_cache_size = $(".thread_cache_size").val();
        var table_open_cache = $(".table_open_cache").val();
        var max_connections = $(".max_connections").val();
        var query_cache_type = 0;
        if(query_cache_size >0){
            query_cache_type = 1;
        }
        var loadT = layer.msg('正在保存配置 <img src="/static/img/ing.gif">', { icon: 16, time: 0, shade: [0.3, '#000'] });
        $.post('/database?action=SetDbConf',{mysql_set:mysql_set,memSize:memSize,key_buffer_size:key_buffer_size,
            query_cache_size:query_cache_size,
            tmp_table_size:tmp_table_size,
            innodb_buffer_pool_size:innodb_buffer_pool_size,
            innodb_log_buffer_size:innodb_log_buffer_size,
            sort_buffer_size:sort_buffer_size,
            read_buffer_size:read_buffer_size,
            read_rnd_buffer_size:read_rnd_buffer_size,
            join_buffer_size:join_buffer_size,
            thread_stack:thread_stack,
            binlog_cache_size:binlog_cache_size,
            thread_cache_size:thread_cache_size,
            table_open_cache:table_open_cache,
            max_connections:max_connections,
            query_cache_type:query_cache_type,
            max_heap_table_size:tmp_table_size},function(res){
                layer.close(loadT)
                layer.msg(res.msg,{icon:res.status?1:2})
                if(res.status){
                    setTimeout(function(){
                        _that.config_majorization()
                    },1000)
                }
        })
    },
    // 二进制管理
    binary_log:function(){
        var _that = this;
        this.ajaxTask('get_mysql_bin',function(rdata){
            rdata = rdata.data
            var _html = '',binary_tbody = '';
            if(rdata.length >0){
                for(var i = 0; i<rdata.length; i++){
                    var _path = rdata[i]
                    binary_tbody += '<tr>\
                        <td>'+_path+'</td>\
                        <td style="text-align: right;">\
                            <a class="btlink" onclick="db_monitor.binary_backup(\''+_path+'\')" >备份</a>&nbsp;|&nbsp;\
                            <a class="btlink" onclick="db_monitor.binary_analysis(\''+_path+'\')" >分析</a>&nbsp;|&nbsp;\
                            <a class="btlink" onclick="db_monitor.binary_delete(\''+_path+'\')" >删除</a>\
                        </td>\
                    </tr>'
                }
            }else{
                binary_tbody = '<tr><td colspan="2" style="text-align:center>没有数据</td></tr>'
            }
            _html = '<div style="margin-bottom:10px;position: relative;">\
                <button name="bt_mysql_restart" class="btn btn-default btn-sm mr5" onclick="db_monitor.view_backup_dbData()">已备份文件</button>\
                <button name="bt_mysql_restart" class="btn btn-default btn-sm mr5 ml5" onclick="db_monitor.binary_export_sql()">导出数据库</button>\
                <button name="bt_mysql_save" class="btn btn-default btn-sm mr5 ml5" onclick="db_monitor.backup_log()">查看备份日志</button>\
                <div style="float: right;">\
                    <span style="position: absolute;right: 45px;top: 2px;">自动备份</span>\
                    <span class="btswitch-p"><input class="btswitch btswitch-ios" id="mysql_auto_backup" type="checkbox">\
                        <label class="btswitch-btn binary_auto_backup" for="mysql_auto_backup" style="margin:0px;display: inline-block;" ></label>\
                    </span></div>\
                </div>\
                <div class="divtable"><table class="table table-hover" style="background-color:#fafafa">\
                    <thead><tr><th>文件路径</th><th style="text-align: right;">操作</th></tr></thead>\
                    <tbody></tbody>\
                </table><div style="overflow:auto;max-height:390px;margin-bottom:10px;"><table class="table table-hover"><tbody class="binary_table">'+binary_tbody+'</tbody></table></div>'
            $(".materCon").html(_html)
            // 获取自动备份状态
            _that.get_automatic_status(function(rdata){
                $("#mysql_auto_backup").prop("checked",rdata);
            });
            // 自动备份开关
            $('.binary_auto_backup').click(function(){
                var status = $('#mysql_auto_backup').prop("checked");
                _that.ajaxTask('set_automatic_backup',{status: !status}, function(rdata){
                    rdata = rdata.data
                    $("#mysql_auto_backup").prop("checked",rdata.data);
                    layer.msg(rdata.msg,{icon:rdata.status?1:2})
                });
            })
        })
        
    },
    // 二进制管理  ---》 备份按钮
    binary_backup:function(path){
        this.ajaxTask('backup_mysql_bin',{path:path},function(rdata){
            layer.msg(rdata.msg,{icon:rdata.status?1:2})
        })
    },
    // 二进制管理  ---》 分析按钮
    binary_analysis:function(path){
        this.ajaxTask('analysis_bin_log',{path:path},function(rdata){
            rdata = rdata.data
            layer.open({
                type: 1,
                shift: 5,
                closeBtn: 2,
                area: '600px',
                title: '二进制分析',
                content:'<textarea readonly="" style="margin: 0px;width: 600px;height: 450px;background-color: #333;color:#fff; padding:0 5px" id="analysis_logs">'+rdata+'</textarea>'
            })
        })
    },
    // 二进制管理  ---》 删除按钮
    binary_delete:function(path){
        var _that = this;
        layer.confirm('是否删除【'+path+'】文件,请确认', {title:'删除二进制文件',icon:3,closeBtn: 2}, function() {
            _that.ajaxTask('del_bin_log_file',{path:path},function(rdata){
                if(rdata.status) _that.binary_log();
                layer.msg(rdata.msg,{icon:rdata.status?1:2})
            })
        });
    },
    // 二进制管理  ---》 已备份文件列表
    view_backup_dbData:function(){
        this.ajaxTask('get_backup_mysql_bin',function(rdata){
            rdata = rdata.data
            layer.open({
                type: 1,
                shift: 5,
                closeBtn: 2,
                area: '450px',
                title: '已备份文件列表',
                content:'<div class="pd15 divtable"><table class="table table-hover table-bordered">\
                    <thead><tr><th>文件路径</th></tr></thead>\
                    <tbody class="before_backup_log_table"></tbody>\
                </table></div>',
                success:function(layero,index){
                    var _tbody = '';
                    if(rdata.length >0){
                        for(var i =0; i<rdata.length; i++){
                            _tbody += '<tr>\
                                <td><span class="span_overflow_hidden" style="width:400px">'+(rdata[i])+'</span></td>\
                            </tr>'
                        }
                    }else{
                        _tbody = '<tr><td style="text-align:center>没有数据</td></tr>'
                    }
                    $(".before_backup_log_table").html(_tbody);
                }
            })
        })
    },
    // 二进制管理  ---》 导出数据库
    binary_export_sql:function(root,file){
        var _that = this;
        layer.open({
            type: 1,
            shift: 5,
            closeBtn: 2,
            area: '450px',
            title: '导出数据库',
            content:'<div class="bt-form db_optimiz_statement pd20 pb70">\
                <div class="line">\
                    <span class="tname">导出文件</span>\
                    <div class="info-r export_db_box dropdown">\
                        <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" type="button" id="export_button" style="width:230px;height:30px;text-align: left;overflow: hidden;">\
                        <b class="db_name" val=""></b>\
                        </button>\
                        <ul class="dropdown-menu export_data_ul" role="menu" aria-labelledby="export_button"></ul>\
                    </div></div>\
                <div class="line">\
                    <span class="tname">开始时间</span>\
                    <div class="info-r ">\
                        <input name="export_start_time" class="bt-input-text mr5" type="text" id="export_start_time" style="width:230px">\
                    </div></div>\
                <div class="line">\
                    <span class="tname">结束时间</span>\
                    <div class="info-r ">\
                        <input name="export_end_time" class="bt-input-text mr5" type="text" id="export_end_time" style="width:230px">\
                    </div></div>\
                <div class="bt-form-submit-btn">\
                    <button type="button" class="btn btn-danger btn-sm export_closeBtn">关闭</button>\
                    <button class="btn btn-success btn-sm export_save">确定</button>\
                </div>\
            </div>',
            success:function(layers,index){
                laydate.render({elem: '#export_start_time',type: 'datetime'});
                laydate.render({elem: '#export_end_time',type: 'datetime'});
                _that.ajaxTask('get_mysql_bin',function(rdata){
                    rdata = rdata.data
                    var _li = '<li class="export_data_li"><label><input type="checkbox" style="margin-right:5px; vertical-align:-2px" value="all">全部</label></li>';
                    _that.db_list = rdata.length;
                    if(rdata.length >0){
                        for(var i =0; i<rdata.length; i++){
                            _that.all_db_list.push(rdata[i])
                            file_name = rdata[i].split('/').pop();
                            _li += '<li class="export_data_li item">\
                                    <label>\
                                        <input type="checkbox" style="margin-right:5px; vertical-align:-2px" data-file="'+file_name+'" value="'+rdata[i]+'">\
                                        '+file_name+'\
                                    </label>\
                                </li>'
                        }
                    }
                    $(".export_data_ul").html(_li)

                    $(".export_data_ul input").click(function(){
                        var checkbox_db_list = [],b_text_list=[];
                        if($(this).val() == 'all'){
                            if($(this).prop("checked")){
                                checkbox_db_list = _that.all_db_list;
                                b_text_list = ['全部文件']
                                $('.export_data_ul .item input:checkbox').each(function() { 
                                    $(this).prop('checked',true);
                                });
                            }else{
                                checkbox_db_list = [];
                                b_text_list = []
                                $('.export_data_ul input').prop('checked',false);
                            }
                        }else{
                            checkbox_db_list = [];
                            b_text_list = []
                            $('.export_data_ul .item input:checkbox').each(function() {
                                if ($(this).prop('checked')){
                                    checkbox_db_list.push($(this).val());
                                    b_text_list.push($(this).attr("data-file"))
                                }
                            });
                            if(checkbox_db_list.length == _that.db_List){
                                $('.export_data_ul input').eq(0).prop('checked',true);
                                checkbox_db_list = _that.all_db_list;
                                b_text_list = ['全部文件']
                            }else{
                                $('.export_data_ul input').eq(0).prop('checked',false);
                            }
                        }
                        $(".db_name").attr("val",checkbox_db_list.join(","))
                        $(".db_name").html(b_text_list.join(","))
                    })
                })
                
                $(".export_save").click(function(){
                    var file = $(".db_name").attr("val"),start_time = $("#export_start_time").val(),end_time = $("#export_end_time").val();var file_data = new Array();
                    if(file == '') return layer.msg('请选择文件',{icon:2});
                    if(start_time == '') return layer.msg('请选择开始时间',{icon:2});
                    if(end_time == '') return layer.msg('请选择结束时间',{icon:2});
                    file_data = file.split(",")
                    _that.ajaxTask('export_db_sql',{path:JSON.stringify(file_data),start_datetime:start_time, stop_datetime:end_time},function(res){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        if(res.status) layer.close(index)
                    })
                })
                $(".export_closeBtn").click(function(){
                    layer.close(index)
                })
            }
        })
    },
    // 二进制管理  ---》 查看备份日志按钮
    backup_log:function(){
        var _that = this;
        layer.open({
            type: 1,
            shift: 5,
            closeBtn: 2,
            area: ['600px','537px'],
            title: '备份日志',
            content:'<div class="pd15 divtable"><table class="table table-hover table-bordered">\
                <thead><tr><th>详情</th></tr></thead>\
                <tbody class="backup_log_table"></tbody>\
            </table><div class="page" id="backup_view_log"></div></div>',
            success:function(layero,index){
                _that.render_backup_log()
            }
        })
    },
    // 渲染备份日志
    render_backup_log:function(page){
        this.ajaxTask('get_backup_log',{p:page == undefined ?1:page},function(rdata){
            var readData = rdata.data
            var _tbody = ''
            if(readData.data.length >0){
                for(var i =0; i<readData.data.length; i++){
                    _tbody += '<tr><td><span class="span_overflow_hidden" style="width:520px" title="'+readData.data[i].log+'">'+readData.data[i].log+'</span></td></tr>'
                }
            }else{
                _tbody = '<tr><td style="text-align:center">没有数据</td></tr>'
            }
            $(".backup_log_table").html(_tbody);
            $('#backup_view_log').html(readData.page.page)
        })
    },
    // 操作日志
    view_log:function(page){
        this.ajaxTask('get_local_log',{p:page==undefined?1:page},function(rdata){
            rdata = rdata.data
            var _html = '',_tbody = '',_page;
            if(rdata.data.length > 0){
                for(var i =0; i<rdata.data.length; i++){
                    _tbody += '<tr>\
                        <td><span class="span_overflow_hidden" style="width:450px" title="'+rdata.data[i].log+'">'+rdata.data[i].log+'</span></td>\
                        <td width="150px">'+rdata.data[i].addtime+'</td>\
                    </tr>'
                }
            }else{
                _tbody = '<tr><td colspan="2" style="text-align:center">没有数据</td></tr>'
            }
            _page = '<div class="page" id="log_page">'+rdata.page.page+'</div>'
            _html = '<div class="divtable"><table class="table table-hover">\
                <thead><tr><th>详情</th><th width="150px">操作时间</th></tr></thead>\
                <tbody class="logs_tabls">'+_tbody+'</tbody>\
                </table></div>'+_page+'';
            $(".materCon").html(_html)
            setTimeout(function(){
                //操作日志分页
                
            },300)
        })
        
    },
    // <------获取数据------->
    get_automatic_status:function(callback){
        this.http({
            tips:'正在获取自动备份状态中，请稍候...',
            check:true,
            method: "get_automatic_status",
            success: function(res){
                if(callback) callback(res.data);
            }
        })
    },
    
    /**
        * 动态处理请求，设置全局ajaxList，api和提示语，遍历请求返回成功值
        * @param {string} config 需要请求的api
        * @param {Function} data 请求参数
        * @param {Function} success 成功值
        * @param {Function} error 失败值
    */
    ajaxTask: function (config,data,success,error) {
        if(typeof config == "string"){
            if(typeof data == "object"){
                config = {method:config,data:data,success:success,error:error}
            }else if(typeof data == "function"){
                config = { method:config,success:data}
                if(typeof success == "function" ){
                    config.error = success
                }
            }
        }
        if (config.middle === false) {config.success();return false}
        this.http({
            tips: '正在' + this.ajaxList[config.method] + ',请稍侯...',
            method: config.method,
            data: config.data || {},
            success: function (rdata) {
                if (config.success) config.success(rdata);
            },
            error: function (rdata) {
                if (config.error) config.error(rdata);
            }
        });
    },
    // 请求方法
    http: function (obj) {
        var loadT = '';
        if (obj.load == undefined) obj.load = 0;
        if (obj.url == undefined) {
            if (obj.plugin_name === undefined && this.plugin_name !== undefined) obj.plugin_name = this.plugin_name
            if (!obj.plugin_name || !obj.method) {
                layer.msg('插件类名称，或插件方法名称缺失!', {icon: 2 });
                return false;
            }
        }
        if (obj.load === 0 || obj.tips != undefined) {
            loadT = layer.msg(obj.tips, {icon: 16,time: 0, shade: 0.1});
        } else if (obj.load === 1 || (obj.tips == undefined && obj.load == undefined)) {
            loadT = layer.load();
        }
        $.ajax({
            type: 'POST',
            url: obj.url != undefined ? obj.url : ('/plugin?action=a&name=' + obj.plugin_name + '&s=' + obj.method),
            data: obj.data || {},
            timeout: obj.timeout || 99999999,
            complete: function (res) {
                if (obj.load === 0 || obj.load === 1) layer.close(loadT);
            },
            success: function (rdata) {
                if (obj.check) {
                    obj.success(rdata);
                    return
                }
                if (typeof rdata.status !== 'undefined' && rdata.status === false) {
                    layer.msg(rdata.msg, {icon: 2});
                    return false;
                }
                obj.success(rdata);
            },
            error: function (ex) {
                if (!obj.error) {
                    obj.msg || obj.msg == undefined ? layer.msg('请求过程发现错误!', {icon: 2}) : '';
                    return;
                }
                return obj.error(ex);
            }
        });
    }
}
db_monitor.init()
</script>