<style>
  .plugin_body .box_conter {
    display: none;
  }

  .plugin_body .box_conter.active {
    display: block;
  }

  .tomcat_log {
    margin: 0px;
    width: 560px;
    height: 470px;
    background-color: #424251;
    overflow: auto;
    line-height: 22px;
    color: #fff;
    padding-left: 10px;
    font-family: arial;
    margin-top: 10px;
    outline: none;
  }

  .bt-form .bt_tab_list {
    border: 1px solid #ccc;
    border-bottom: 0;
    background-color: #ececec;
  }

  .bt-form .bt_tab_list .bt_tab_index.active {
    background: #fff;
  }

  .bt_tab_index {
    display: inline-block;
    padding: 10px 25px;
    border-right: 1px solid #ccc;
    cursor: pointer;
    /* font-size: 14px; */
    color: #666;
  }

  .box_item {
    height: 150px;
    padding: 15px;
  }

  .box_item .status {
    height: 30px;
  }

  .btn_item_block {
    display: inline-block;
    margin-right: 50px;
  }

  .box_item .btn {
    margin-right: 15px;
  }

  .box_item .box_title {
    height: 35px;
    line-height: 35px;
    font-size: 14px;
    border-bottom: 1px solid #f0f0f1;
    margin-bottom: 15px;
  }

  .box_table_conter {
    height: 290px;
    overflow-y: auto;
  }

  .tomcat_list .path,
  .tomcat_path_list .path {
    width: 150px;
  }

  .tomcat_list tr td span,
  .tomcat_path_list tr td i {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-style: normal;
  }

  .select_list {
    width: 180px;
    height: 35px;
    line-height: 35px;
    border: 1px solid #888;
    border-radius: 2px;
    display: inline-block;
    cursor: pointer;
    position: relative;
    margin-left: 15px;

    background: #fff url(data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAICAgICAgICAgIDAgICBAUEAgIEBQYFBQUFBQYHBgYGBgYGBwcICAkICAcKCgsLCgoODg4ODg4ODg4ODg4ODg7/2wBDAQMDAwYFBgsHBwsODAoMDhEQEBAQEREODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg7/wAARCAAHABQDAREAAhEBAxEB/8QAFgAAAwAAAAAAAAAAAAAAAAAABQcJ/8QAJBAAAQMCBAcAAAAAAAAAAAAAAQMEBQIRAAYHQRITITJRYXH/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Ar9nrS5SSnWj+E5bdOWVtJpmwCdVialaRvcAm3n70BywcKxy/GN4yPT4G7cd29R3qPs4AzgP/2Q==) no-repeat right center;
  }

  .select_list .select_item {
    width: 100%;
    display: block;
    /* text-align: center; */
    padding-left: 10px;
  }

  .select_list .select {
    width: 180px;
    position: absolute;
    left: -1px;
    top: 33px;
    border: 1px solid #999;
    background: #fff;
    height: 250px;
    overflow: auto;
  }

  .select_list .select li {
    height: 35px;
    line-height: 35px;
    padding: 0 10px;
  }

  .select_list .select li.active {
    background: #e6e6e6;
    /* cursor: no-drop; */
  }

  .select_list .select li:hover {
    background: #e6e6e6;
  }

  .install_version_box .btn-danger {
    color: #fff;
    background-color: #d9534f;
    border-color: #d43f3a;
  }

  .install_version_box {
    /* padding: 15px 25px; */
  }

  .project_box {
    margin-bottom: 5px;
  }

  .textarea_logs {
    width: 860px;
    height: 470px;
    line-height: 22px;
    margin: 0px;
    margin-top: 10px;
    padding-left: 10px;
    background-color: #424251;
    outline: none;
    overflow: auto;
    color: #fff;
    font-family: arial;
    font-size: 12px;
  }

  .project_logs,
  .add_project_log {
    margin-top: 0;
  }

  .python_logs {
    height: 428px;
  }

  .table_self_conter {
    display: inline-block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: bottom;
  }

  .table > tbody > tr > td {
    vertical-align: top;
  }

  .changepath {
    height: 500px;
    border-bottom: 1px solid #dddddd;
  }

  .changepath .path-top {
    height: 50px;
    line-height: 50px;
    padding-left: 10px;
    border-bottom: #dddddd 1px solid;
  }

  .changepath .path-con-left {
    width: 160px;
    height: 450px;
    float: left;
    border-right: #dddddd 1px solid;
    padding-top: 5px;
  }

  .changepath .path-con-left dl .open_disk:hover {
    background: #ececec;
    cursor: pointer;
  }

  .changepath .path-con-right {
    float: left;
    height: 450px;
    width: 590px;
    overflow: hidden;
  }

  .getfile-btn {
    background: #f7f7f7 none repeat scroll 0 0;
    padding: 8px 20px 10px;
    text-align: right;
    width: 100%;
    border-top: 0px;
  }

  .changepath .path-top .btn span {
    margin-right: 5px;
  }

  .changepath .path-con-left dl dt {
    height: 40px;
    line-height: 40px;
    padding-left: 20px;
    margin-left: 0;
    background: none;
  }

  .changepath .path-con-left dl dt span {
    margin-right: 10px;
  }

  .file-list .table-hover > tbody > tr {
    height: 50px;
    cursor: pointer;
  }

  .file-list .table > tbody > tr > td {
    vertical-align: middle;
  }

  .file-list .dir_block {
    display: inline-block;
    vertical-align: top;
    height: 25px;
    line-height: 25px;
  }

  .table_dir .dir_block,
  .table_files .dir_block {
    height: 28px;
    line-height: 28px;
    display: inline-block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .file-list .list-list span.glyphicon-option-horizontal {
    height: 30px;
    line-height: 35px;
    font-size: 15px;
  }

  .file-list .list-list span.glyphicon-folder-open {
    margin-right: 15px;
    font-size: 23px;
    margin-left: 4px;
  }

  .file-list {
    display: block;
    overflow: auto;
    height: 417px !important;
    position: relative;
    top: -1px;
  }

  .label_checkbox {
    position: relative;
  }

  .list-list tr:last-child {
    border-bottom: 1px solid #ddd;
  }

  .divtable .table thead th {
    border-bottom: 0px solid #e6e6e6;
  }

  .table_hide th {
    padding: 0 !important;
  }

  .list-list .ico-default {
    background-position: center center;
    background-repeat: no-repeat;
    /* display: inline-block; */
    height: 30px;
    margin-right: 10px;
    width: 33px;
    z-index: 1;
    float: left;
  }

  #table_thead {
    border-bottom: 1px solid #ddd !important;
  }

  .path-con-right .list-list td {
    cursor: auto;
  }

  .drop-down {
    /* display: none; */
    /* position: absolute; */
    width: 80px;
    text-align: center;
    /* padding: 5px 5px; */
  }

  .drop-down .glyphicon.glyphicon-trash {
    font-size: 12px;
    color: red;
    margin-right: 0;
  }

  .drop-down .del_file {
    color: red;
    position: relative;
  }

  .module-list {
    display: block;
    overflow: auto;
    height: 210px;
    position: relative;
    top: -1px;
  }

  .line .tname {
    width: 120px;
  }

  .cnblogs_code {
    padding: 20px 5px;
    border: 1px solid #e1e1e1;
    background: #fcfcfc;
    border-radius: 4px;
    line-height: 24px;
  }

  .cnblogs_code span {
    display: block;
    margin-left: 15px;
    margin-bottom: 0;
  }

  .cnblogs_code .code {
    display: inline-block;
    margin-left: 0px;
    margin-bottom: 5px;
    background: #efefef;
    padding: 0 8px;
    border: 2px;
  }

  /* 表单 */
  .bt-new-form .form-item {
    display: flex;
  }

  .bt-new-form .form-item + .form-item {
    margin-top: 15px;
  }

  .bt-new-form .form-label {
    width: 100px;
    line-height: 32px;
    padding-right: 20px;
    text-align: right;
  }

  .bt-new-form .form-value {
    min-height: 32px;
  }

  .bt-form-inline {
    display: inline-flex;
  }

  .bt-form-inline .form-item .form-label {
    width: auto;
  }

  .bt-form-inline .form-item + .form-item {
    margin-top: 0;
  }

  .form-switch,
  .form-checkbox {
    display: inline-flex;
    align-items: center;
    min-height: 32px;
  }

  .form-switch .btswitch-btn {
    margin-bottom: 0;
  }

  .form-checkbox input[type="checkbox"] {
    margin: 0;
    width: 15px;
    height: 15px;
    cursor: pointer;
  }

  .form-checkbox label {
    margin: 0;
    margin-left: 12px;
    font-weight: normal;
    cursor: pointer;
  }

  /* end */

  /* 添加python项目 */
  .bt-python-form .form-label {
    width: 148px;
  }

  .bt-python-form .bt-input-text {
    width: 270px;
  }

  .bt-python-form .python-options-item {
    margin-top: 15px;
  }

  .python-options-item .form-item .form-label {
    width: 112px;
  }

  .bt-python-form .python-options-item .install-module-label {
    width: 148px;
  }

  /* end */
  #PathPlace {
    display: inline-flex;
	}
	#PathPlace span {
    overflow: hidden;
    display: inline-block;
    max-width: 590px;
    text-overflow: ellipsis;
    white-space: nowrap;
	}
</style>

<div class="bt-form">
  <div class="bt-w-main">
    <!--菜单部分-->
    <div class="bt-w-menu">
      <p class="bgw">项目管理</p>
      <p>版本管理</p>
      <!-- <p>日志</p> -->
    </div>
    <!--内容部分-->
    <div class="bt-w-con pd15">
      <div class="plugin_body">
        <!-- 项目管理 -->
        <div class="box_conter active divtable">
          <button class="btn btn-success btn-sm va0 mb15 add_python">
            添加项目
          </button>
          <div id="tomcat_fix" class="box_table_conter">
            <table class="table table-hover">
              <thead>
              <tr>
                <th>项目名</th>
                <th>项目路径</th>
                <th>端口</th>
                <th>启动方式</th>
                <th>Python版本</th>
                <th>CPU</th>
                <th>内存</th>
                <th>状态</th>
                <th>开机启动</th>
                <th>守护进程</th>
                <th style="text-align: right">操作</th>
              </tr>
              </thead>
              <tbody class="python_list"></tbody>
            </table>
          </div>
          <div class="cnblogs_code">
            <span>开机启动：因依赖的进程守护管理器插件为开机自启，如关闭开机启动但守护进程开启，那么系统重启时进程守护管理器插件会自启动，然后守护进程开启时会把该项目启动，所以需要关闭开机启动请将守护进程也一起关闭</span>
            <span>管理器默认使用pip安装项目根目录requirements.txt内的模块，如有其他模块需要安装请手动进入独立环境安装</span>
            <span>使用独立环境PIP的方法：</span>
            <span>在命令行输入<span class="code">/项目路径/md5命名的文件夹/bin/pip</span></span>
            <span>如：<span class="code">/data/python/d9036cc6563924cf9e1da4e1cd64f9a4_venv/bin/pip</span></span>
          </div>
        </div>
        <div class="box_conter install_version_box">
          <span>Python版本:</span>
          <div class="select_list">
            <span class="select_item">获取中 ...</span>
            <ul class="select" style="display: none"></ul>
          </div>
          <button
            class="btn btn-success btn-sm va0 mlr15 install_python"
            style="display: none">
            安装版本
          </button>
          <button
            class="btn btn-danger btn-sm va0 mlr15 uninstall_python"
            style="display: inline-block">
            卸载版本
          </button>
          <ul class="help-info-text c7">
            <li style="color: red">安装python版本可能会耗时比较久请耐心等候</li>
          </ul>
          <textarea class="python_logs textarea_logs"></textarea>
        </div>
        <!-- <div class="box_conter python_project_logs">
              <div class="project_box">
                  <span style="margin-right: 10px;">Python项目:</span>
                  <select class="bt-input-text mr5 project_select" name="project_select" style="width:180px">
                      <option value="0">tomcat7</option>
                  </select>
              </div>
              <textarea class="project_logs textarea_logs"></textarea>
          </div> -->
      </div>
    </div>
  </div>
</div>
<!--JS脚本部分，不要将JS脚本写在其它地方-->

<script>
  /**
   * 插件交互对象
   * 您的所有JS代码可以写在里面
   * 若不习惯JS的面向对象编程，可删除此对象，使用传统函数化的方式编写
   * */
  var python = {
    plugin_name: 'pythonmamager',
    add_python_view: 0,
    version_list: [],
    project_list: [],
    project_info: {
      pjname: '',
      path: '',
      rfile: '',
      framework: '',
      version: '',
      port: '',
      rtype: '',
      log_path: '',
      install_module: false
    },
    add_project_logs_view: null,
    add_project_logs_timer: null,
    python_logs_timer: null,
    // 初始化
    init: function () {
      var _this = this;
      $(".layui-layer-page").width(1200);
      $(".bt-w-menu p").click(function () {
        var index = $(this).index();
        $(this).addClass('bgw').siblings().removeClass('bgw').parent().next().find('.box_conter').eq(index).addClass('active').siblings().removeClass('active')
        switch (index) {
          // 项目管理
          case 0:
            _this.create_project_table();
            break;
          // 版本管理
          case 1:
            _this.create_python_version();
            break;
          // case 2:
          //     _this.create_python_logs();
          //     break;
        }
      });
      $('.select_list').on('click', '.select li', function () {
        $(this).addClass('active').siblings().removeClass('active');
        $('.select_list .select_item').html($(this).html());
        $('.select_list .select').hide();
        if ($(this).html().indexOf('已安装') == -1) {
          $('.install_python').show().next().hide();
        } else {
          $('.uninstall_python').show().prev().hide();
        }
      });
      $('.select_list .select_item').click(function (e) {
        e.stopPropagation();
        if ($('.select_list .select').attr('style').indexOf('block') > -1) {
          $('.select_list .select').hide();
        } else {
          $('.select_list .select').show();
        }
        $(document).click(function (e) {
          e.stopPropagation();
          $('.select_list .select').hide();
        });
      });
      // 安装python
      $('.install_version_box').on('click', '.install_python', function () {
        var active_val = $('.select .active').attr('data-version');
        layer.closeAll('dialog');
        _this.show_python_logs();
        _this.install_python_version({version: active_val}, function (res) {
          _this.clear_python_logs();
          if (res.status) {
            _this.create_python_version(function () {
              layer.msg(res.msg, {icon: 1});
            });
          } else {
            layer.msg(res.msg, {icon: 2});
          }
        });
      });
      // 卸载python
      $('.install_version_box').on('click', '.uninstall_python', function () {
        var active_val = $('.select .active').attr('data-version');
        layer.closeAll('dialog');
        layer.confirm('是否卸载【' + active_val + '】程序', {
          title: '卸载Python',
          icon: 0,
          closeBtn: 2,
          shift: 5
        }, function () {
          _this.show_python_logs();
          _this.remove_python_version({version: active_val}, function (res) {
            if (res.status) {
              _this.clear_python_logs();
              _this.create_python_version(function () {
                layer.msg(res.msg, {icon: 1});
              });
            } else {
              layer.msg(res.msg, {icon: 2});
            }
          });
        });
      });
      // 添加python项目
      $('.add_python').click(function () {
        _this.get_install_python_version(function (res) {
          var _option = '', _option1 = '', _option2 = '', user_option = '',
            arry = ['gunicorn', 'uwsgi', 'python', '自定义'], arry1 = ['python', 'flask', 'django', 'sanic'],
            user_arr = ['root', 'www'];
          for (var i = 0; i < res.length; i++) {
            _option += '<option value="' + res[i] + '">' + res[i] + '</option>'
          }
          for (var j = 0; j < arry.length; j++) {
            _option1 += '<option value="' + (arry[j] == '自定义' ? 'customize' : arry[j]) + '">' + arry[j] + '</option>'
          }
          for (var z = 0; z < arry1.length; z++) {
            _option2 += '<option value="' + arry1[z] + '">' + arry1[z] + '</option>'
          }
          for (var k = 0; k < user_arr.length; k++) {
            user_option += '<option value="' + user_arr[k] + '" ' + (user_arr[k] == 'root' ? 'selected="selected"' : '') + '>' + user_arr[k] + '</option>';
          }
          python.add_python_view = layer.open({
            type: 1,
            closeBtn: 2,
            title: '添加Python项目',
            area: '550px', //宽高
            btn: ['确定', '取消'],
            content: '\
												<div class="bt-python-form bt-new-form pd15">\
													<div class="form-item">\
														<div class="form-label">项目名称</div>\
														<div class="form-value">\
															<input class="bt-input-text" type="text" name="pjname" placeholder="请输入项目名称" autocomplete="off" />\
														</div>\
													</div>\
													<div class="form-item">\
														<div class="form-label">Python版本</div>\
														<div class="form-value">\
															<select class="bt-input-text mr5 project_version" name="version">' + _option + '</select>\
															<a class="btlink" href="javascript:python.return_version_view();">版本管理</a>\
														</div>\
													</div>\
													<div class="form-item">\
														<div class="form-label">框架</div>\
														<div class="form-value">\
															<select class="bt-input-text mr5 project_framework" name="framework">' + _option2 + '</select>\
														</div>\
													</div>\
													<div class="form-item">\
														<div class="form-label">启动方式</div>\
														<div class="form-value">\
															<select class="bt-input-text mr5 project_version" name="rtype">' + _option1 + '</select>\
														</div>\
													</div>\
													<div class="form-item">\
														<div class="form-label">项目路径</div>\
														<div class="form-value">\
															<input class="bt-input-text" id="server_path" type="text" name="path" placeholder="请选择项目路径" />\
															<span data-id="path" class="glyphicon cursor ml5 glyphicon-folder-open open_select_item" onclick="python.change_path(\'#server_path\',\'dir\')"></span>\
														</div>\
													</div>\
													<div class="form-item">\
														<div class="form-label">日志路径</div>\
														<div class="form-value">\
															<input class="bt-input-text" id="server_log" type="text" name="log_path" placeholder="请选择自定义日志路径" />\
															<span data-id="path" class="glyphicon cursor ml5 glyphicon-folder-open open_select_item" id="select-server-logs"></span>\
														</div>\
													</div>\
													<div class="form-item">\
														<div class="form-label">启动文件/文件夹</div>\
														<div class="form-value">\
															<input class="bt-input-text" id="server_file" type="text" name="rfile" placeholder="请选择项目启动文件" />\
															<span data-id="path" class="glyphicon cursor ml5 glyphicon-folder-open open_select_item" id="select-server-file"></span>\
														</div>\
													</div>\
													<div class="form-item port">\
														<div class="form-label">端口</div>\
														<div class="form-value">\
															<input class="bt-input-text" type="text" name="port" placeholder="请输入项目端口，没有端口请留空" autocomplete="off" />\
														</div>\
													</div>\
													<div class="form-item custom_start">\
														<div class="form-label">自定义启动方式</div>\
														<div class="form-value">\
															<input class="bt-input-text" type="text" name="rfile" placeholder="请输入自定义启动方式" autocomplete="off" />\
														</div>\
													</div>\
													<div class="form-item">\
														<div class="form-label">运行项目的用户</div>\
														<div class="form-value">\
															<select class="bt-input-text mr5 project_version" name="user">' + user_option + '</select>\
														</div>\
													</div>\
													<div class="form-item operation_param_line" style="display: none;">\
														<div class="form-label">运行参数</div>\
														<div class="form-value">\
															<input class="bt-input-text" type="text" name="parm" placeholder="请输入运行参数，没有参数请留空" autocomplete="off" />\
														</div>\
													</div>\
													<div class="bt-form-inline python-options-item">\
														<div class="form-item">\
															<div class="form-label install-module-label">安装模块依赖</div>\
															<div class="form-value">\
																<div class="form-checkbox">\
																	<input type="checkbox" name="install_module" checked="checked" />\
																</div>\
															</div>\
														</div>\
														<div class="form-item">\
															<div class="form-label">开机启动</div>\
															<div class="form-value">\
																<div class="form-checkbox">\
																	<input type="checkbox" name="auto_start" checked="checked" />\
																</div>\
															</div>\
														</div>\
														<div class="form-item">\
															<div class="form-label">守护进程</div>\
															<div class="form-value">\
																<div class="form-checkbox">\
																	<input type="checkbox" name="is_supervisor" checked="checked" />\
																</div>\
															</div>\
														</div>\
													</div>\
													<ul class="help-info-text c7" style="margin-top: 20px; padding-left: 30px;">\
														<li>Gunicorn 是一个被广泛使用的的Python WSGI UNIX HTTP服务器</li>\
														<li>uWsgi 是一个高性能WEB服务器</li>\
														<li>python 直接使用python运行项目</li>\
														<li>项目日志需要在项目内定位到 /项目目录/logs/error.log 否则无法获取日志</li>\
														<li>自定义启动的项目路径需要填写完整路径</li>\
													</ul>\
												</div>\
											',
            success: function () {
              // 判断获取目录
              $('[name="rtype"]').change(function (e) {
                var val = $(this).val();
                if (val == 'customize') {
                  $('.custom_start').show().find('input').val('');
                  $('.custom_path').hide().find('input').val('');
                  $('.help-customize').show();
                } else {
                  $('.custom_path').show().find('input').val('');
                  $('.custom_start').hide().find('input').val('');
                  $('.help-customize').hide();
                }
                if (val == 'python') {
                  $('.operation_param_line').show();
                  $('.form-item.port').hide();
                } else {
                  $('.operation_param_line').hide();
                  $('.form-item.port').show();
                }
                _this.get_django_wsgi_path();
                _this.get_manager_path();
              });
              $('[name="framework"]').change(function (e) {
                _this.get_django_wsgi_path();
                _this.get_manager_path();
              });
              $('[name="path"]').blur(function (e) {
                _this.get_django_wsgi_path();
                _this.get_manager_path();
              });

              $('#select-server-file').click(function () {
                var path = $('#server_path').val() || '/';
                python.change_path('#server_file', 'other', path);
              });

              $('#select-server-logs').click(function () {
                var path = $('#server_path').val() || '/';
                python.change_path('#server_log', 'dir', path);
              });

              $('select[name="rtype"]').val('python').change();
            },
            yes: function (index, layero) {
              _this.project_info = {
                pjname: $('[name="pjname"]').val(), //项目名称
                path: $('[name="path"]').val(), //项目路径
                version: $('[name="version"]').val(), //版本号
                framework: $('[name="framework"]').val(),
                rfile: $('[name="rtype"]').val() == 'customize' ? $('[name="rfile"]')[1].value : $('[name="rfile"]')[0].value,
                rtype: $('[name="rtype"]').val(),
                port: $('[name="port"]').val(),
                install_module: $('[name="install_module"]').prop('checked') ? 1 : 0,
                auto_start: $('[name="auto_start"]').prop('checked') ? 1 : 0,
                user: $('[name="user"]').val(),
                is_supervisor: $('[name="is_supervisor"]').prop('checked') ? 1 : 0,
                log_path: $('[name="log_path"]').val()
              };
              if (_this.project_info.rfile == "") {
                layer.msg('启动文件/文件夹不能为空', {icon: 2});
              }
              if (!($('[name="parm"]').parents('.line').is(":hidden"))) {
                _this.project_info.parm = $('[name="parm"]').val();
              }

              for (var i in _this.project_info) {
                if (_this.project_info[i] === '' && i != 'port' && i != 'parm' && i != 'log_path') {
                  if (i == 'pjname') {
                    layer.msg('项目名称不能为空', {icon: 2});
                  } else if (i == 'path') {
                    layer.msg('项目地址不能为空', {icon: 2});
                  }
                  return false;
                }
              }

              if (_this.project_info.is_supervisor == 1) {
                _this.project_info.numprocs = 1;
              }

              _this.show_add_project_log();

              _this.add_project(_this.project_info, function (res) {
                _this.clear_add_project_log();
                if (res.status) {
                  layer.close(index);
                  _this.create_project_table(function () {
                    layer.msg(res.msg, {icon: 1});
                  });
                } else {
                  layer.msg(res.msg, {icon: 2});
                }
              });
            }
          });
        });
      });
      $('.project_select').change(function () {
        var project_val = $(this).val();
        _this.get_project_logs({pjname: project_val}, function (res) {
          $('.project_logs').val(res);
          var scrollDom = document.getElementsByClassName('project_logs')[0]
          scrollDom.scrollTop = scrollDom.scrollHeight;
        });
      });
      this.create_project_table();
    },
    /**
     * 显示添加项目日志
     */
    show_add_project_log: function () {
      var _this = this;
      var content = '<textarea class="add_project_log textarea_logs">暂无日志</textarea>';
      this.add_project_logs_view = layer.open({
        type: 1,
        area: "860px",
        title: '日志',
        closeBtn: 2,
        shift: 5,
        shadeClose: false,
        content: content
      });
      $('.add_project_log').parent().css('font-size', '0');
      this.get_add_project_log();
      _this.add_project_logs_timer = setInterval(function () {
        _this.get_add_project_log();
      }, 1000);
    },
    /**
     * 获取添加项目日志
     */
    get_add_project_log: function () {
      this.get_logs(function (res) {
        $('.add_project_log').val(res ? res : '暂无日志');
        var ele = document.getElementsByClassName('add_project_log')[0];
        ele.scrollTop = ele.scrollHeight;
      });
    },
    /**
     * 清除添加项目日志
     */
    clear_add_project_log: function () {
      if (this.add_project_logs_timer) clearInterval(this.add_project_logs_timer);
      if (this.add_project_logs_view) layer.close(this.add_project_logs_view);
    },
    /**
     * 获取get_django_wsgi_path
     */
    get_django_wsgi_path: function () {
      this.get_public_path('get_django_wsgi_path', ['uwsgi', 'gunicorn'], ['django']);
    },
    /**
     * 获取get_manager_path
     */
    get_manager_path: function () {
      this.get_public_path('get_manager_path', ['python'], ['django']);
    },
    /**
     * 获取通用路径
     * @param {String} url 接口名称
     * @param {Array} rtypes 判断启动方式的值
     * @param {Array} frameworks 判断框架的值
     */
    get_public_path: function (url, rtypes, frameworks) {
      var path_val = $('[name="path"]').val();
      var rtype_val = $('[name="rtype"]').val();
      var framework_val = $('[name="framework"]').val();
      var path_judge = path_val != '';
      var rtype_judge = false;
      var framework_judge = false;
      rtypes = rtypes || [];
      frameworks = frameworks || [];
      for (var i = 0; i < rtypes.length; i++) {
        if (rtypes[i] == rtype_val) {
          rtype_judge = true;
          break;
        }
      }
      for (var i = 0; i < frameworks.length; i++) {
        if (frameworks[i] == framework_val) {
          framework_judge = true;
          break;
        }
      }
      if (path_judge && rtype_judge && framework_judge) {
        this.get_path(url, {path: path_val}, function (res) {
          $('[name="rfile"]').val(res ? res : '');
        });
      } else {
        $('[name="rfile"]').val('');
      }
    },
    // 返回版本管理视图
    return_version_view: function () {
      layer.close(python.add_python_view);
      $(".bt-w-menu p").eq(1).click();
    },
    // 创建python版本界面
    create_python_version: function (callback) {
      var _this = this;
      _this.get_python_version(function (res) {
        var _html_one = '', _html_two = '', _install = '', _value = '';
        _this.version_list = res;
        for (var i = 0; i < _this.version_list.length; i++) {
          if (_this.version_list[i][1] == 1) {
            _html_one += '<li data-version="' + _this.version_list[i][0] + '" data-install="1">' + _this.version_list[i][0] + '<i style="font-style: normal;color: #20a53a;">&nbsp;&nbsp;[已安装]&nbsp;&nbsp;</i></li>'
          } else {
            _html_two += '<li data-version="' + _this.version_list[i][0] + '" data-install="0">' + _this.version_list[i][0] + '<i style="font-style: normal;">&nbsp;&nbsp;[未安装]&nbsp;&nbsp;</i></li>'
          }
        }
        $('.select_list .select').html(_html_one + _html_two);
        _value = $('.select_list .select li').eq(0).attr('data-version');
        _install = $('.select_list .select li').eq(0).attr('data-install');
        $('.select_item').html(_value + '<i style="font-style: normal;' + (_install == 1 ? 'color: #20a53a;' : '') + '">&nbsp;&nbsp;[ ' + (_install == 1 ? '已安装' : '未安装') + ' ]&nbsp;&nbsp;</i>');
        $('.select_list .select li').eq(0).addClass('active');
        if (_install == 1) {
          $('.uninstall_python').show();
          $('.install_python').hide();
        } else {
          $('.uninstall_python').hide();
          $('.install_python').show();
        }
        if (callback) callback();
      });
    },
    /**
     * 显示python日志
     */
    show_python_logs: function (callback) {
      var _this = this;
      _this.get_python_logs();
      _this.python_logs_timer = setInterval(function () {
        _this.get_python_logs();
      }, 1500);
    },
    /**
     * 获取python日志
     */
    get_python_logs: function () {
      this.get_logs(function (res) {
        var python_logs_ele = $('.python_logs');
        python_logs_ele.val(res ? res : '暂无日志');
        var ele = document.getElementsByClassName('python_logs')[0];
        ele.scrollTop = ele.scrollHeight;
      });
    },
    /**
     * 清除时间戳
     */
    clear_python_logs: function () {
      if (this.python_logs_timer) clearInterval(this.python_logs_timer);
    },
    // 单位转换
    to_size: function (a) {
      var d = [" MB", " GB", " TB", " PB"];
      var e = 1024;
      for (var b = 0; b < d.length; b++) {
        if (a < e) {
          return (b == 0 ? a : a.toFixed(2)) + d[b]
        }
        a /= e
      }
    },
    // 创建列表
    create_project_table: function (callback) {
      var _this = this;
      this.get_project_list(function (rdata) {
        var _html = '';
        for (var i = rdata.length - 1; i >= 0; i--) {
          _html += '<tr>\
									<td><span class="table_self_conter" style="width:50px" title="' + rdata[i].pjname + '">' + rdata[i].pjname + '</span></td>\
									<td><a href="javascript:openPath(\'' + rdata[i].path + '\');" class="btlink"><span class="path table_self_conter" style="width:110px" title="' + rdata[i].path + '">' + rdata[i].path + '</span></a></td>\
									<td><span class="table_self_conter" style="width:auto">' + (rdata[i].port || '--') + '</span></td>\
									<td><span class="table_self_conter" style="width:auto">' + rdata[i].rtype + '</span></td>\
									<td><span class="table_self_conter" style="width:auto">' + rdata[i].version + '</span></td>\
									<td><span class="table_self_conter" style="width:auto">' + rdata[i].cpu + '%</span></td>\
									<td><span class="table_self_conter" style="width:auto">' + _this.to_size(rdata[i].mem) + '</span></td>\
									<td><a href="javascript:;" class="btlink python_status_click" data-index="' + i + '">' + (rdata[i].status == '0' ? '<span style="color:red;">已暂停 </span><span style="color:red" class="glyphicon glyphicon-pause"></span>' : '<span style="color:#5CB85C">运行中 </span><span style="color:#5CB85C" class="glyphicon glyphicon-play"></span>') + '</a></td>\
									<td>\
										<a href="javascript:;" class="btlink python_auto_status_click" data-index="' + i + '">' + (rdata[i].auto_start == '0' ? '<span style="color:red;">关闭</span>' : '<span style="color:#5CB85C">开启</span>') + '</a>\
									</td>\
									<td>\
									 	<a href="javascript:;" class="btlink supervisor_status_click" data-index="' + i + '">' + (rdata[i].is_supervisor == 1 ? '<span>已设置</span>' : '<span style="color:red">未设置</span>') + '</a>\
										<a href="javascript:;" class="btlink python_status_click_protect" data-index="' + i + '">' + (rdata[i].is_supervisor == 1?rdata[i].supervisor_status == undefined || rdata[i].supervisor_status == 0 ? '<span style="color: red">（未运行）</span>' : '<span style="color:#5CB85C">（已运行）</span>':'') + '</a>\
									</td>\
									<td style="text-align:right;width:272px"><a href="javascript:;" class="btlink project_logs_btn" data-index="' + i + '" title="日志">日志</a>&nbsp;&nbsp;|&nbsp;&nbsp;' + (rdata[i].proxy != '' ? '<a href="javascript:;" class="btlink python_proxy_click" data-index="' + i + '" title="取消映射">取消映射</a>&nbsp;&nbsp;|&nbsp;&nbsp;' : '<a href="javascript:;" class="btlink python_proxy_click" data-index="' + i + '" title="映射项目">映射</a>&nbsp;&nbsp;|&nbsp;&nbsp;') + '<a href="javascript:;" class="btlink python_restart_click" data-index="' + i + '" title="重启项目">重启</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:;" class="btlink python_conf_click" data-index="' + i + '" title="配置文件">配置</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:;" class="btlink python_module_click" data-index="' + i + '" title="模块管理">模块</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:;" class="btlink python_del_click" data-index="' + i + '" title="删除项目">删除</a></td>\
								</tr>'
        }
        if (rdata.length == 0) {
          _html += '<tr><td class="text-center" colspan="11">当前没有数据</td></tr>'
        }
        $('.python_list').html(_html);
        setTimeout(function () {
          // 状态切换事件
					$('.python_status_click_protect').click(function () {
						var index = $(this).attr('data-index');
						var res = _this.project_list[index];
            console.log(res)
						var status = res.supervisor_status== 0 ? '开启' : '关闭';
						var title = status + 'Python项目【' + res.pjname + '】的守护进程';
						var content = status+ '守护进程后项目异常关闭时将'+(res.supervisor_status== 0 ?'会':'不再')+'自动启动，是否继续？'
						var confirm = layer.confirm(content, {
							title: title,
							icon: 0,
							closeBtn: 2,
							btn: ['确定', '取消']
						}, function () {
							_this.set_project_status(res.supervisor_status == 0 ? 'start' : 'stop', {
								pjname: res.pjname,
								is_supervisor: 1
							},1, function (res) {
								if (res.status) {
									_this.create_project_table(function () {
										layer.msg(res.msg, {icon: 1});
									});
								} else {
									layer.msg(res.msg, {icon: 2});
								}
							});
						});
					})
          $('.python_status_click').click(function () {
            var index = $(this).attr('data-index');
            var res = _this.project_list[index];
            var status = res.status == 0 ? '开启' : '关闭';
            var title = status + 'Python项目【' + res.pjname + '】';
            var startContent = '\
									<div>\
										<div>开启项目时勾选守护进程后项目异常关闭时会自动启动，是否继续？</div>\
										<div>\
											<div class="form-checkbox">\
												<input type="checkbox" id="isSupervisor" name="is_supervisor" />\
												<label for="isSupervisor">守护进程</label>\
											</div>\
										</div>\
									</div>';
            var content = res.status == 0 ? startContent : '关闭项目时会把该项目的守护进程也一起关闭，是否继续？';
            var confirm = layer.confirm(content, {
              title: title,
              icon: 0,
              closeBtn: 2,
              btn: ['确定', '取消']
            }, function () {
              var is_supervisor =0;
              if (res.status == 0) {
                is_supervisor = $('#isSupervisor').is(':checked') ? 1 : 0;
              }
              _this.set_project_status(res.status == 0 ? 'start' : 'stop',{
                pjname: res.pjname,
                is_supervisor: is_supervisor
              },0, function (res) {
                if (res.status) {
                  _this.create_project_table(function () {
                    layer.msg(res.msg, {icon: 1});
                  });
                } else {
                  layer.msg(res.msg, {icon: 2});
                }
              });
            });
          });

          $('.supervisor_status_click').click(function () {
            var index = $(this).attr('data-index');
            var res = _this.project_list[index];
            if (res.is_supervisor == 0) {
              layer.confirm('开启守护进程后项目异常关闭时会自动启动，是否继续？', {
                title: '开启守护进程【' + res.pjname + '】',
                icon: 0,
                closeBtn: 2,
                btn: ['确定', '取消']
              }, function () {
                _this.set_project_supervisor('start', {pjname: res.pjname, numprocs: 1}, function (res) {
                  if (res.status) {
                    _this.create_project_table(function () {
                      layer.msg(res.msg, {icon: 1});
                    });
                  } else {
                    layer.msg(res.msg, {icon: 2});
                  }
                });
              });
            } else {
              layer.confirm('关闭守护进程后项目异常关闭时将不再自动启动，是否继续？', {
                title: '关闭守护进程【' + res.pjname + '】',
                icon: 0,
                closeBtn: 2,
                btn: ['确定', '取消']
              }, function () {
                _this.set_project_supervisor('stop', {pjname: res.pjname}, function (res) {
                  if (res.status) {
                    _this.create_project_table(function () {
                      layer.msg(res.msg, {icon: 1});
                    });
                  } else {
                    layer.msg(res.msg, {icon: 2});
                  }
                });
              });
            }
          });


          // 开机启动事件
          $('.python_auto_status_click').click(function () {
            var index = $(this).attr('data-index');
            var res = _this.project_list[index];
            var status = res.auto_start == 0 ? '开启' : '关闭';
            var title = status + '开机启动【' + res.pjname + '】';
            var content = res.auto_start == 0 ? '开启后系统开机将自动启动该项目，是否继续？' : '关闭后系统开机将不会自动启动该项目，是否继续？';
            var confirm = layer.confirm(content, {
              icon: 0,
              closeBtn: 2,
              title: title,
              btn: ['确定', '取消']
            }, function () {
              _this.edit_auto_start({pjname: res.pjname, auto_start: res.auto_start == '0' ? 1 : 0}, function (res) {
                if (res.status) {
                  _this.create_project_table(function () {
                    layer.msg(res.msg, {icon: 1})
                  });
                } else {
                  layer.msg(res.msg, {icon: 2});
                }
              });
            });
          });

          // 重启事件
          $('.python_restart_click').click(function () {
            var index = $(this).attr('data-index');
            var pj = _this.project_list[index];
            var confirm = layer.confirm('是否重启Python项目&nbsp;[' + pj.pjname + ']&nbsp;？', {
              title: '提示',
              btn: ['确定', '取消'],
              icon: 0,
              closeBtn: 2
            }, function () {
              if (pj.status == 0) {
                _this.set_project_status('start', {pjname: pj.pjname,is_supervisor: pj.supervisor_status}, 0,function (rdata) {
                  if (rdata.status) {
                    _this.create_project_table(function () {
                      layer.msg(rdata.msg, {icon: 1});
                    });
                  } else {
                    layer.msg(rdata.msg, {icon: 2});
                  }
                });
              } else {
                _this.set_project_status('stop', {pjname: pj.pjname,is_supervisor: pj.supervisor_status},0, function (rdata1) {
                    setTimeout(function () {
                      _this.set_project_status('start', {pjname: pj.pjname,is_supervisor: pj.supervisor_status},0, function (rdata) {
                        _this.create_project_table(function () {
                          layer.msg(rdata.msg, {icon: 1});
                        });
                      });
                    }, 500);
                });
              }
            });
          });
          // 模块事件
          $('.python_module_click').click(function () {
            var index = $(this).attr('data-index');
            _this.create_packages_view(index, 'table');
          });
          // 映射事件
          $('.python_proxy_click').click(function () {
            var i = $(this).attr('data-index');
            var res = _this.project_list[i];
            if (res.proxy != '') {
              layer.confirm('是否取消项目映射域名&nbsp;[' + res.proxy + ']&nbsp;？', {
                title: '提示',
                btn: ['确定', '取消'],
                icon: 0,
                closeBtn: 2
              }, function () {
                _this.remove_project_proxy({pjname: res.pjname}, function (res) {
                  if (res.status) {
                    _this.create_project_table(function () {
                      layer.msg(res.msg, {icon: 1});
                    });
                  } else {
                    layer.msg(res.msg, {icon: 2});
                  }
                });
              });
            } else {
              layer.open({
                type: 1,
                closeBtn: 2,
                title: '映射项目&nbsp;[' + res.pjname + ']&nbsp;',
                area: ['380px', '180px'],
                shadeClose: false,
                btn: ['提交', '取消'],
                content: '<div class="bt-form bt-form pd20">' +
                  '<div class="line">' +
                  '<span class="tname">映射域名</span>' +
                  '<div class="info-r"><input name="ip" class="bt-input-text mr5" placeholder="请输入映射域名" type="text" value="" style="width:200px;"></div>' +
                  '</div>' +
                  '</div>',
                yes: function (index, layero) {
                  var domain = $('[name=ip]').val()
                  _this.set_proxy_project({pjname: res.pjname, domain: domain}, function (res) {
                    if (res.status) {
                      layer.close(index);
                      _this.create_project_table(function () {
                        layer.msg(res.msg, {icon: 1});
                      });
                    } else {
                      layer.msg(res.msg, {icon: 2});
                    }
                  });
                }
              });
            }
          });

          // 配置事件
          $('.python_conf_click').click(function () {
            var i = $(this).attr('data-index');
            var rdata = _this.project_list[i], code_mirror = '', encoding = '';
            _this.get_python_config(rdata.pjname, function (ress) {
              if (!ress.status) {
                layer.msg(ress.msg, {icon: 2});
                return false;
              }
              var u = ["utf-8", "GBK", "GB2312", "BIG5"], n = '';
              for (var p = 0; p < u.length; p++) {
                m = ress.encoding == p[u] ? "selected" : "";
                n += '<option value="' + u[p] + '" ' + m + ">" + u[p] + "</option>";
              }
              var _aceEditor = null;
              layer.open({
                type: 1,
                closeBtn: 2,
                title: '编辑&nbsp;[' + rdata.pjname + ']&nbsp;项目配置',
                area: ['650px', '550px'],
                shadeClose: false,
                btn: ['确认', '取消'],
                content: '\
														<form class="bt-form pd20">\
															<div class="line">\
																<p style="color:red;margin-bottom:10px">提示：Ctrl+F 搜索关键字，Ctrl+G 查找下一个，Ctrl+S 保存，Ctrl+Shift+R 查找替换!\
																	<select class="bt-input-text" name="encoding" style="width: 74px;position: absolute;top: 22px;right: 19px;height: 22px;z-index: 9999;border-radius: 0;">' + n + '</select>\
																</p>\
																<div id="edit_python_text" class="bt-input-text ace_config_editor_scroll" style="height: 380px; line-height:18px;"></div>\
															</div>\
														</form>',
                success: function (layero, index) {
                  var that = this;
                  _aceEditor = bt.aceEditor({
                    el: 'edit_python_text',
                    content: ress.data,
                    saveCallback: function () {
                      that.yes(index, layero);
                    }
                  });
                },
                yes: function (index, layero) {
                  var encoding = $('select[name="encoding"]').val();
                  _this.save_conf_file({
                    pjname: rdata.pjname,
                    data: _aceEditor.ACE.getValue(),
                    encoding: encoding
                  }, function (res) {
                    layer.msg(res.msg, {icon: res.status ? 1 : 2});
                  });
                }
              });
            });
          });

          // 删除事件
          $('.python_del_click').click(function () {
            var i = $(this).attr('data-index');
            var res = _this.project_list[i];
            var confirm = layer.confirm('删除该项目前会将该项目停止后再删除，是否继续？', {
              title: '删除Python项目【' + res.pjname + '】',
              btn: ['确定', '取消'],
              icon: 0,
              closeBtn: 2
            }, function () {
              _this.del_project({pjname: res.pjname, is_supervisor: res.is_supervisor}, function (res) {
                if (res.status) {
                  _this.create_project_table(function () {
                    layer.msg(res.msg, {icon: 1});
                  });
                } else {
                  layer.msg(res.msg, {icon: 2});
                }
              });
            });
          });
          // 查看日志
          $('.project_logs_btn').click(function () {
            var index = $(this).attr('data-index');
            var pjname = _this.project_list[index].pjname;
            _this.get_project_logs({pjname: pjname}, function (res) {
              var content = '<textarea class="project_logs textarea_logs">' + (res ? res : '暂无日志') + '</textarea>';
              layer.open({
                type: 1,
                area: "860px",
                title: '查看【' + pjname + '】的日志',
                closeBtn: 2,
                shift: 5,
                shadeClose: false,
                content: content
              });
              var scrollDom = document.getElementsByClassName('project_logs')[0];
              scrollDom.scrollTop = scrollDom.scrollHeight;
              $('.project_logs').parent().css('font-size', '0');
            });
          });
          if (callback) callback();
        }, 500);
      });
    },
    // 创建python日志
    create_python_logs: function () {
      var _html = '';
      for (var i = this.project_list.length - 1; i >= 0; i--) {
        _html += '<option value="' + this.project_list[i].pjname + '">' + this.project_list[i].pjname + '</option>';
      }
      $('.project_select').html(_html);
      this.get_project_logs({pjname: $('.project_select').val()}, function (res) {
        $('.project_logs').val(res);
        var scrollDom = document.getElementsByClassName('project_logs')[0]
        scrollDom.scrollTop = scrollDom.scrollHeight;
      })
    },
    // 项目日志
    get_project_logs: function (data, callback) {
      this.send({
        method: 'GetProjectLog',
        load: 2,
        msg: false,
        data: data,
        success: function (res) {
          if (callback) callback(res);
        }
      });
    },
    // 获取项目列表
    get_project_list: function (callback) {
      var _this = this;
      this.send({
        method: 'GetPorjectList',
        tips: '正在获取项目列表，请稍后...',
        success: function (res) {
          if (res.status === false) {
            layer.msg(res.msg, {icon: 2});
            return false;
          }
          _this.project_list = res;
          if (callback) callback(res);
        }
      });
    },
    // 获取项目列表
    remove_project_proxy: function (data, callback) {
      var _this = this;
      this.send({
        method: 'RemoveProxy',
        data: {pjname: data.pjname},
        tips: '正在取消项目映射，请稍后...',
        success: function (res) {
          _this.project_list = res;
          if (callback) callback(res);
        }
      });
    },
    // 获取本地python版本列表
    get_install_python_version: function (callback) {
      this.send({
        method: 'GetPythonV',
        tips: '正在获取python版本，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 创建模块视图
    create_packages_view: function (index, type, callback) {
      var res = this.project_list[index], _this = this;
      _this.get_packages_list({pjname: res.pjname}, function (ress) {
        var package_list = '';
        for (var i in ress) {
          package_list += '<tr><td>' + i + '</td><td>' + ress[i] + '</td><td style="text-align: right;"><a href="javascript:;" class="btlink uninstall_module" data-name="' + i + '">卸载</a></td></tr>';
        }
        if (callback) callback(package_list);
        if (type == 'table') {
          layer.open({
            type: 1,
            closeBtn: 2,
            title: '模块管理&nbsp;[' + res.pjname + ']&nbsp;',
            area: '380px',
            shadeClose: false,
            content: '<div class="bt-form bt-form pd20">\
                            <div class="line" style="height: 30px;padding: 0;">\
                                <input type="text" class="bt-input-text" placeholder="模块名称" name="module_name" style="width: 186px;"/>\
                                <input type="text" class="bt-input-text" placeholder="模块版本" name="module_version" style="margin-left:10px;margin-right:10px;width:80px;"/>\
                                <button class="btn btn-success btn-sm va0 mb15 install_module">添加</button>\
                            </div>\
                            <div class="line" style="height: 35px;line-height: 35px;padding: 0;color: red;">*&nbsp;模块版本留空则安装最新版&nbsp;*</div>\
                            <div class="divtable_list">\
                                <div class="divtable" style="border: 1px solid #dddddd;border-bottom: 0;">\
                                    <table class="table table-hover" id="table_thead" style="border:0 none">\
                                        <thead><tr><th width="45%">名称</th><th width="35%">版本</th><th width="20%" style="text-align: right;">操作</th></tr></thead>\
                                    </table>\
                                </div>\
                                <div class="module-list divtable" style="display: block;">\
                                    <table class="table table-hover" style="margin-top: -34px;">\
                                        <thead><tr><th width="45%">名称</th><th width="35%">版本</th><th width="20%" style="text-align: right;">操作</th></tr></thead>\
                                        <tbody id="module_list">' + package_list + '</tbody>\
                                    </table>\
                                </div>\
                            </div>\
                        </div>',
            success: function (layero, indexs) {
              // 安装模块
              $('.install_module').click(function () {
                var p = $('[name="module_name"]').val(), v = $('[name="module_version"]').val();
                _this.set_mamger_package({act: 'install', pjname: res.pjname, p: p, v: v}, function (res) {
                  if (res.status) {
                    _this.create_packages_view(index, 'list', function (html) {
                      $('#module_list').html(html);
                      $('[name="module_name"]').val('');
                      $('[name="module_version"]').val('');
                      layer.msg(res.msg, {icon: 1});
                    });
                  } else {
                    layer.msg(res.msg, {icon: 2});
                  }
                });
              });
              // 卸载模块
              $('#module_list').on('click', '.uninstall_module', function () {
                var name = $(this).attr('data-name');
                var confirm = layer.confirm('是否卸载模块&nbsp;[' + name + ']&nbsp;？', {
                  title: '警告',
                  btn: ['确定', '取消'],
                  icon: 0,
                  closeBtn: 2
                }, function () {
                  _this.set_mamger_package({
                    act: 'uninstall',
                    pjname: res.pjname,
                    p: name,
                    v: ress[name]
                  }, function (res) {
                    layer.msg(res.msg, {icon: res.status ? 1 : 2});
                    if (res.status) {
                      _this.create_packages_view(index, 'list', function (html) {
                        $('#module_list').html(html)
                        layer.msg(res.msg, {icon: 1});
                      });
                    } else {
                      layer.msg(res.msg, {icon: 2});
                    }
                  });
                });
              });
            }
          });
        } else {
          return package_list;
        }
      });
    },
    // 获取模块列表
    get_packages_list: function (data, callback) {
      this.send({
        method: 'GetPackages',
        data: {pjname: data.pjname},
        tips: '正在获取项目[' + data.pjname + ']模块，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 设置模块
    set_mamger_package: function (data, callback) {
      this.send({
        method: 'MamgerPackage',
        data: {pjname: data.pjname, act: data.act, p: data.p, v: data.v},
        tips: '正在获取项目[' + data.pjname + ']模块，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 添加项目
    add_project: function (data, callback) {
      this.send({
        method: 'CreateProject',
        data: data,
        tips: '正在安装项目所需要的依赖，可能耗时较久，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 编辑项目
    edit_project: function () {
      // this.send({
      //     method:'',
      //     data:data,
      //     tips:'',
      //     success:function(res){

      //     }
      // });
    },
    // 设置守护进程
    set_project_supervisor: function (type, data, callback) {
      var status = type == 'start' ? 'StartSupervisor' : 'StopSupervisor';
      this.send({
        method: status,
        data: data,
        tips: '正在' + (type == 'start' ? '开启' : '关闭') + '守护进程，请稍候...',
        success: function (res) {
          if (callback) callback(res);
        }
      });
    },
    // 设置项目状态
    set_project_status: function (type, data,index, callback) {
      var status = type == 'start' ? 'StartProject' : 'StopProject';
      this.send({
        method: status,
        data: data,
        tips: '正在' + (type == 'start' ?index==1?'运行守护进程': '开启Python项目' : index==1?'停止守护进程':'关闭Python项目') + ',请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      });
    },
    // 编辑开机启动
    edit_auto_start: function (obj, callback) {
      this.send({
        method: 'edit_auto_start',
        data: obj,
        tips: '正在设置项目开机启动状态，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },

    // 映射设置
    set_proxy_project: function (data, callback) {
      this.send({
        method: 'ProxyProject',
        data: data,
        tips: '正在映射Python项目,请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 删除项目
    del_project: function (data, callback) {
      this.send({
        method: 'RemoveProject',
        data: data,
        tips: '正在删除Python项目,请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      });
    },
    // 获取python可安装的版本
    get_python_version: function (callback) {
      this.send({
        method: 'GetCloudPython',
        tips: '获取python版本中，请稍后...',
        success: function (res) {
          if (res.status === false) {
            layer.msg(res.msg, {icon: 2});
            return false;
          }
          if (callback) callback(res);
        }
      })
    },
    //安装python的版本
    install_python_version: function (data, callback) {
      this.send({
        method: 'InstallPythonV',
        data: data,
        tips: '正在安装Python版本[' + data.version + ']，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    get_logs: function (callback) {
      this.send({
        method: 'get_logs',
        load: -1,
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 卸载python版本
    remove_python_version: function (data, callback) {
      this.send({
        method: 'RemovePythonV',
        data: data,
        tips: '正在卸载Python版本[' + data.version + ']，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      });
    },
    // 获取配置信息
    get_python_config: function (pjname, callback) {
      this.send({
        method: 'GetConfFile',
        data: {pjname: pjname},
        tips: '正在获取配置信息，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      });
    },
    // 保存配置信息
    save_conf_file: function (obj, callback) {
      this.send({
        method: 'SaveConfFile',
        data: {
          pjname: obj.pjname,
          data: obj.data,
          encoding: obj.encoding
        },
        tips: '正在保存配置信息，请稍后...',
        success: function (res) {
          if (callback) callback(res);
        }
      });
    },
    // 选择目录
    change_path: function (el, type, path) {
      var _this = this;
      layer.open({
        type: 1,
        area: "750px",
        title: type == 'files' ? '选择项目启动文件' : '选择项目目录',
        closeBtn: 2,
        shift: 5,
        shadeClose: false,
        content: "<div class='changepath'>\
                            <div class='path-top'>\
                                <button type='button' class='btn btn-default btn-sm btn-back-file'><span class='glyphicon glyphicon-share-alt'></span>" + lan.public.return + "</button>\
                                <div class='place' id='PathPlace'>" + lan.bt.path + "：<span></span></div>\
                            </div>\
                            <div class='path-con'>\
                                <div class='path-con-left'>\
                                    <dl><dt id='changecomlist' onclick='BackMyComputer()'><span class='glyphicon glyphicon-hdd'></span>" + lan.bt.comp + "</dt></dl>\
                                </div>\
                                <div class='path-con-right'>\
                                    <ul class='default' id='computerDefautl'></ul>\
                                    <div class='divtable'>\
                                        <table class='table table-hover' id='table_thead' style='border:0 none'>\
                                            <thead><tr class='file-list-head'><th width='6%'></th><th width='30%'>" + lan.bt.filename + "</th><th width='25%'>" + lan.bt.etime + "</th><th width='10%'>" + lan.bt.access + "</th><th width='10%'>" + lan.bt.own + "</th><th width='10%'></th></tr></thead>\
                                        </table>\
                                    </div>\
                                    <div class='file-list divtable'>\
                                        <table class='table table-hover' style='border:0 none;margin-top: -32px;'>\
                                            <thead><tr class='file-list-head'><th width='6%'></th><th width='30%'>" + lan.bt.filename + "</th><th width='25%'>" + lan.bt.etime + "</th><th width='10%'>" + lan.bt.access + "</th><th width='10%'>" + lan.bt.own + "</th><th width='10%'></th></tr></thead>\
                                            <tbody id='dir_tbody' class='list-list'></tbody>\
                                        </table>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>\
                        <div class='getfile-btn' style='margin-top:0'>\
                            <button type='button' class='btn btn-default btn-sm pull-left btn_create_folder'>" + lan.bt.adddir + "</button>\
                            <button type='button' class='btn btn-danger btn-sm mr5 btn_close'>" + lan.public.close + "</button>\
                            <button type='button' class='btn btn-success btn-sm btn_path_ok'>" + lan.bt.path_ok + "</button>\
                        </div>",
        success: function (layero, index) {
          //设置文件目录
          switch (type) {
            case 'dir':
              setCookie('file_paths', $(el).val() || path || '/www');
              break;
            case 'files':
              setCookie('file_paths', _this.back_file());
              break;
            case 'other':
              setCookie('file_paths', $(el).val() || path || '/');
              break;
          }
          // 返回目录
          $('.btn-back-file').click(function () {
            setCookie('file_paths', _this.back_file());
            _this.get_dir_dom(type);
          });
          // 关闭layer
          $('.btn_close').click(function () {
            layer.close(index);
          });
          // 选择目录或文件
          $('.btn_path_ok').click(function () {
            var file_name = $('#dir_tbody .ui-selected').find('.open_files_event').attr('data-name');
            var types = $('#dir_tbody .ui-selected').find('.open_files_event').attr('data-type');
            switch (type) {
              case 'dir':
                if (file_name == undefined) file_name = '';
                break;
              case 'files':
                if ($('#dir_tbody .ui-selected').length == 0) layer.msg('请选择文件', {icon: 2});
                return false;
                break;
              case 'other':
                if (file_name == undefined) file_name = '';
                break;
            }
            var paths = getCookie('file_paths');
            var paths_arry = paths.split('/');
            if (paths_arry[paths_arry.length - 1] != '') {
              paths += '/'
            }
            $(el).val(paths + (file_name == '' ? '' : file_name));
            if (type == 'dir' && el == '#server_path') {
              var nPath = paths + (file_name == '' ? '' : file_name);
              $('#server_log').val(paths + (file_name == '' ? '' : file_name) + (nPath[nPath.length - 1] == '/' ? '' : '/') + 'logs');
              _this.get_django_wsgi_path();
              _this.get_manager_path();
            }
            layer.close(index);
          });
          // 新建文件夹
          $('.btn_create_folder').click(function () {
            var isCreate = $('#dir_tbody tr:eq(0)').hasClass('table_add_dir');
            if (isCreate) return false;
            $('#dir_tbody').prepend('<tr class="table_add_dir">\
                                <td></td><td colspan="2"><span class="glyphicon glyphicon-folder-open"></span><input class="newFolderName" type="text" value="" style="width: 250px;height: 30px;vertical-align: bottom;">\
                                <td colspan="3"><button type="button" class="btn btn-success btn-sm newFolderEvent">确定</button>&nbsp;&nbsp;<button type="button" class="btn btn-default btn-sm newFolderClaer">取消</button></td>\
                            </td></tr>');
            document.getElementsByClassName('file-list')[0].scrollTop = 0;
            setTimeout(function () {
              $('.table_add_dir').on('click', '.newFolderEvent', function (e) {
                var fileName = $('.newFolderName').val();
                if (fileName == '') {
                  layer.msg('请输入新建文件名称', {icon: 0});
                  return false;
                }
                _this.new_folder_event(getCookie('file_paths') + '/' + fileName, function (res) {
                  $(this).parent().parent().remove();
                  _this.get_dir_dom(type);
                });
                e.stopPropagation();
              });
              $('.table_add_dir').on('click', '.newFolderClaer', function (e) {
                $(this).parent().parent().remove();
                e.stopPropagation();
              });
            }, 500);
          });
          // 磁盘目录跳转
          $('.path-con-left').on('click', '.open_disk', function () {
            var dir = $(this).attr('data-dir');
            setCookie('file_paths', dir);
            _this.get_dir_dom(type);
          });
          // 选择文目录或文件
          $('#dir_tbody').on('click', 'tr', function (e) {
            $(this).find('input[type="checkbox"]').click();
            e.stopPropagation();
          });
          // 选择文件或目录
          $('#dir_tbody').on('click', 'tr input[type="checkbox"]', function (e) {
            var checked = $(this).prop('checked');
            if (!checked) {
              _this.select = '';
              $(this).parent().parent().removeClass('ui-selected');
            } else {
              _this.select = $(this).attr('data-name');
              $(this).parent().parent().addClass('ui-selected').siblings().removeClass('ui-selected').find('input').prop('checked', false);
            }
            e.stopPropagation();
          });
          // 跳转指定目录，获取选择文件
          $('#dir_tbody').on('click', '.open_files_event', function (e) {
            var fType = $(this).attr('data-type');
            var name = $(this).attr('data-name');
            var path = getCookie('file_paths');
            if (fType == 'dir') {
              setCookie('file_paths', path + '/' + name);
              _this.get_dir_dom(type);
            } else {
              $(this).parent().prev().find('input[type="checkbox"]').click();
            }
            e.stopPropagation();
          })
          // 跳转指定目录
          $('#dir_tbody').on('click', '.open_files_event .path-con-left dl', function (e) {
            var path = $(this).attr('data-name');
            e.stopPropagation();
          });
          // 跳转指定下一层目录
          $('#dir_tbody').on('dblclick', 'tr', function (e) {
            $(this).find('.open_files_event').click();
            e.stopPropagation();
          });
          //获取目录DOM
          _this.get_dir_dom(type);
        }
      });
    },
    // 过滤一级目录
    back_file: function () {
      c = getCookie('file_paths');
      if (c == '/') return '/'
      if (c.substr(c.length - 1, 1) == "/") {
        c = c.substr(0, c.length - 1)
      }
      var d = c.split("/");
      var a = "";
      if (d.length > 1) {
        var e = d.length - 1;
        for (var b = 0; b < e; b++) {
          a += d[b] + "/"
        }
        return a.replace("//", "/")
      } else {
        a = d[0]
      }
      if (d.length == 1) {
      }
    },
    // 获取后缀
    obtain_suffix: function (fileName) {
      var extArr = fileName.split(".");
      var exts = ['folder', 'folder-unempty', 'sql', 'c', 'cpp', 'cs', 'flv', 'css', 'js', 'htm', 'html', 'java', 'log', 'mht', 'php', 'url', 'xml', 'ai', 'bmp', 'cdr', 'gif', 'ico', 'jpeg', 'jpg', 'JPG', 'png', 'psd', 'webp', 'ape', 'avi', 'flv', 'mkv', 'mov', 'mp3', 'mp4', 'mpeg', 'mpg', 'rm', 'rmvb', 'swf', 'wav', 'webm', 'wma', 'wmv', 'rtf', 'docx', 'fdf', 'potm', 'pptx', 'txt', 'xlsb', 'xlsx', '7z', 'cab', 'iso', 'rar', 'zip', 'gz', 'bt', 'file', 'apk', 'bookfolder', 'folder', 'folder-empty', 'folder-unempty', 'fromchromefolder', 'documentfolder', 'fromphonefolder', 'mix', 'musicfolder', 'picturefolder', 'videofolder', 'sefolder', 'access', 'mdb', 'accdb', 'sql', 'c', 'cpp', 'cs', 'js', 'fla', 'flv', 'htm', 'html', 'java', 'log', 'mht', 'php', 'url', 'xml', 'ai', 'bmp', 'cdr', 'gif', 'ico', 'jpeg', 'jpg', 'JPG', 'png', 'psd', 'webp', 'ape', 'avi', 'flv', 'mkv', 'mov', 'mp3', 'mp4', 'mpeg', 'mpg', 'rm', 'rmvb', 'swf', 'wav', 'webm', 'wma', 'wmv', 'doc', 'docm', 'dotx', 'dotm', 'dot', 'rtf', 'docx', 'pdf', 'fdf', 'ppt', 'pptm', 'pot', 'potm', 'pptx', 'txt', 'xls', 'csv', 'xlsm', 'xlsb', 'xlsx', '7z', 'gz', 'cab', 'iso', 'rar', 'zip', 'bt', 'file', 'apk', 'css'];
      var extLastName = extArr[extArr.length - 1];
      for (var i = 0; i < exts.length; i++) {
        if (exts[i] == extLastName) {
          return exts[i];
        }
      }
      return 'file';
    },
    // 生成列表DOM
    get_dir_dom: function (type) {
      var _this = this;
      this.get_dirk_list(function (res) {
        $('.path-con-right .file-list').show();
        var dir = res.DIR, files = res.FILES, disk = res.DISK, path = res.PATH, page = res.PAGE, dir_html = '',
          files_html = '', disk_html = '';
        for (var i = 0; i < dir.length; i++) {
          var dir_arry = dir[i].split(';');
          var input = type != 'files' ? '<input type="checkbox" name="dir_input" data-name="' + dir_arry[0] + '"/>' : '';
          dir_html += '<tr class="table_dir"><td class="label_checkbox">' + input + '</td><td><a href="javascript:;" data-name="' + dir_arry[0] + '" data-type="dir" class="open_files_event"><span class="glyphicon glyphicon-folder-open"></span><span class="dir_block" style="width:130px;">' + dir_arry[0] + '</span></td><td>' + getLocalTime(dir_arry[2]) + '</td><td>' + dir_arry[3] + '</td><td>' + dir_arry[4] + '</td><td style="text-align: center;"><span class="glyphicon glyphicon-option-horizontal" aria-hidden="true"></span></td></tr>'
        }
        for (var j = 0; j < files.length; j++) {
          var files_arry = files[j].split(';');
          var input = type != 'dir' ? '<input type="checkbox" name="dir_input" data-name="' + files_arry[0] + '"/>' : '';
          files_html += '<tr class="table_files"><td class="label_checkbox">' + input + '</td><td><a href="javascript:;"  data-name="' + files_arry[0] + '" data-type="file" class="open_files_event"><span class="ico-default ico-' + _this.obtain_suffix(files_arry[0]) + '"></span><span class="dir_block" style="width:130px;">' + files_arry[0] + '</span></a></td><td>' + getLocalTime(files_arry[2]) + '</td><td>' + files_arry[3] + '</td><td>' + files_arry[4] + '</td><td style="text-align: center;position: relative;"><span class="glyphicon glyphicon-option-horizontal" aria-hidden="true"></span></td></tr>'
        }
        for (var z = 0; z < disk.length; z++) {
          var disk_info = disk[z];
          var dir_list = disk_info.path.split('/');
          dir_list = dir_list[dir_list.length - 1];
          disk_html += '<dt class="open_disk" data-dir="' + disk_info.path + '"><span class="glyphicon glyphicon-hdd"></span>' + (disk_info.path == '/' ? '根目录 (' + disk_info.size[2] + ')' : '<span class="table_self_conter" style="width:100px" title="' + disk_info.path + ' (' + disk_info.size[2] + ')">' + dir_list + ' (' + disk_info.size[2] + ')</span>') + '</dt>'
        }
        setCookie('file_paths', path);
        $('.changepath .path-con-left dl').html(disk_html);
        $('#dir_tbody').html(dir_html + files_html);
        $('#PathPlace span').html(path).prop('title', path);
      });
    },
    // 新建文件事件
    new_folder_event: function (path, callback) {
      this.send({
        url: '/files?action=CreateDir',
        tips: '正在新建文件，请稍后...',
        data: {path: path},
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 获取文件列表
    get_dirk_list: function (callback) {
      var dir = getCookie('file_paths');
      dir = dir.replace(/\/\//g, "/");
      this.send({
        url: '/files?action=GetDir',
        tips: '正在获取文件列表，请稍后...',
        data: {path: dir, disk: 'True'},
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    /**
     * 获取文件路径
     * @param {*} url 接口名称
     * @param {*} callback 成功回调
     */
    get_path: function (url, data, callback) {
      this.send({
        method: url,
        tips: '正在获取文件路径，请稍候...',
        data: {
          path: data.path
        },
        success: function (res) {
          if (callback) callback(res);
        }
      })
    },
    // 请求封装
    send: function (obj) {
      var loadT = '';
      if (obj.load == undefined) obj.load = 0;
      if (obj.url == undefined) {
        if (obj.plugin_name === undefined && this.plugin_name !== undefined) obj.plugin_name = this.plugin_name
        if (!obj.plugin_name || !obj.method) {
          layer.msg('插件类名称，或插件方法名称缺失!', {
            icon: 2
          });
          return false;
        }
      }
      if (obj.load === 0) {
        loadT = layer.msg(obj.tips, {
          icon: 16,
          time: 0,
          shade: 0.3
        });
      } else if (obj.load === 1 || (obj.tips == undefined && obj.load == undefined)) {
        loadT = layer.load();
      }
      $.ajax({
        type: 'POST',
        url: obj.url != undefined ? obj.url : ('/plugin?action=a&name=' + obj.plugin_name + '&s=' + obj.method),
        data: obj.data || {},
        timeout: obj.timeout || 99999999,
        complete: function (res) {
          if (obj.load === 0 || obj.load === 1) layer.close(loadT);
        },
        success: function (rdata) {
          if (!obj.success) {
            obj.msg || obj.msg == undefined ? layer.msg(rdata.msg, {icon: rdata.status ? 1 : 2}) : '';
            return;
          }
          obj.success(rdata);
        },
        error: function (ex) {
          if (!obj.error) {
            obj.msg || obj.msg == undefined ? layer.msg('请求过程发现错误!', {icon: 2}) : '';
            return;
          }
          return obj.error(ex);
        }
      });
    }
  }
  python.init();
</script>