<div class="bt-content tamper-core">
    <div class="bt-w-main">
        <div class="bt-w-menu">
            <p class="bgw">概览</p>
            <p>保护列表</p>
            <p>全局配置</p>
            <p>进程白名单</p>
            <p>告警设置</p>
            <p>操作日志</p>
        </div>
        <div class="bt-w-con pd15">
            <div class="bt-box active" data-type="OverView">
                <div class="tc_plugin--switch">
                    <span>全局开关</span>
                    <div style="display: inline-block;vertical-align: middle;margin-left:5px;">
                        <input type="checkbox" class="btswitch btswitch-ios" id="serviceStatus">
                        <label class="btswitch-btn serviceStatus" for="serviceStatus"></label>
                    </div>
                </div>
                <div class="tc_total--title">
                    <!-- 拦截次数 -->
                    <div class="tc_total_block">
                        <i class="tc_icon interLogo"></i>
                        <div class="tc_block--num">
                            <div class="tc_block--num--title">拦截次数</div>
                            <div class="tc_block--num--num" id="interceptNum">0</div>
                        </div>
                    </div>
                    <!-- 保护天数 -->
                    <div class="tc_total_block">
                        <i class="tc_icon poritectLogo"></i>
                        <div class="tc_block--num">
                            <div class="tc_block--num--title">保护天数</div>
                            <div class="tc_block--num--num" id="protectDays">0</div>
                        </div>
                    </div>
                    <!-- 告警次数 -->
                    <div class="tc_total_block" style="border-left: 1px solid #E5E5E5;padding-left: 110px;">
                        <div class="tc_block--num">
                            <div class="tc_block--num--title">告警次数</div>
                            <div class="tc_block--num--num" id="alarmNum" style="text-align: center;">0</div>
                        </div>
                    </div>
                </div>
                <div class="tc_intercept--type">
                    <div class="tc_intercept--type--head">拦截类型如下：</div>
                    <div class="tc_intercept--line">
                        <i class="tc_intercept--add"></i>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">创建文件</div>
                            <div class="tc_intercepe--type--num" name="g_create">0</div>
                            <div class="tc_intercepe--type--today" name="t_create"></div>
                        </div>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">新建文件夹</div>
                            <div class="tc_intercepe--type--num" name="g_mkdir">0</div>
                            <div class="tc_intercepe--type--today" name="t_mkdir"></div>
                        </div>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">创建软链</div>
                            <div class="tc_intercepe--type--num" name="g_link">0</div>
                            <div class="tc_intercepe--type--today" name="t_link"></div>
                        </div>
                    </div>
                    <div class="tc_intercept--line" style="border: 1px solid rgb(93 136 180 / 10%);border-left: none;border-right: none;">
                        <i class="tc_intercept--del"></i>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">删除文件</div>
                            <div class="tc_intercepe--type--num" name="g_unlink">0</div>
                            <div class="tc_intercepe--type--today" name="t_unlink"></div>
                        </div>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">删除文件夹</div>
                            <div class="tc_intercepe--type--num" name="g_rmdir">0</div>
                            <div class="tc_intercepe--type--today" name="t_rmdir"></div>
                        </div>
                    </div>
                    <div class="tc_intercept--line">
                        <i class="tc_intercept--edit"></i>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">编辑文件</div>
                            <div class="tc_intercepe--type--num" name="g_modify">0</div>
                            <div class="tc_intercepe--type--today" name="t_modify"></div>
                        </div>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">文件重命名</div>
                            <div class="tc_intercepe--type--num" name="g_rename">0</div>
                            <div class="tc_intercepe--type--today" name="t_rename"></div>
                        </div>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">修改文件权限</div>
                            <div class="tc_intercepe--type--num" name="g_chmod">0</div>
                            <div class="tc_intercepe--type--today" name="t_chmod"></div>
                        </div>
                        <div class="tc_intercepe--type--block">
                            <div class="tc_intercepe--type--title">修改所有者</div>
                            <div class="tc_intercepe--type--num" name="g_chown">0</div>
                            <div class="tc_intercepe--type--today" name="t_chown"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bt-box" data-type="ProtectList">
                <div id="ProtectTable"></div>
            </div>
            <div class="bt-box" data-type="GlobalConfig">
                <div id="GlobalConfig">
                    <div id="tabGlobalConfig" class="tab-nav"></div>
                    <div class="tab-con" style="padding:5px 0 15px 0;"></div>
                </div>
            </div>
            <div class="bt-box" data-type="CommonProcess">
                <div id="CommonProcessTable"></div>
                <ul class="help-text-info mb15 pl7"><li>提示：进程开启后更新文件时将不会进行拦截，请谨慎开启</li></ul>
            </div>
            <div class="bt-box" data-type="AlertConfig">
                <div id="AlertSettingTable"></div>
            </div>
            <div class="bt-box" data-type="OperationLog">
                <div id="OperationLog"></div>
            </div>
            <div class="kernel_clone_masks hide">
                <div class="kernel_clone__box">
                    <div class="kernel_clone__title"><i></i>【服务已停止】</div>
                    <div class="kernel_clone__subtitle">检测到当前服务未开启，请尝试手动启动！否则无法正常使用防篡改插件功能</div>
                    <div class="kernel_clone__btns">
                        <button class="btn btn-default btn-sm mr20" data-action="start">启动</button>
                        <button class="btn btn-default btn-sm mr20" data-action="restart">重启</button>
                        <button class="btn btn-default btn-sm mr20" data-action="reload">重载配置</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .plugin_mask {
        position: relative;
        background-color: #000;
        opacity: 0.3;
        width: 100%;
        height: 588px;
        top: -588px;
        z-index: 999;
        margin: 0 0 0 110px;
        display: none;
    }

    .bt-w-main {
        height: 645px;
    }

    .bt-box.active {
        display: block;
        height: 100%;
    }

    .bt-box {
        display: none;
    }
    .basic_set{
        margin: 0 0 15px 0;
        padding: 0 25px;
    }
    .basic_set .line{
        height: 65px;
        width: 210px;
    }
    .basic_set .line .tname{
        width: 120px;
    }
    .basic_set .line .info-r{
        margin-left: 120px;
    }
    #advancedConfig .line .info-r{
        margin-bottom: 0px;
    }
    #GlobalConfig .table tbody tr td:nth-child(2)>span{
        width: auto;
    }
    /* 概览 */
    .tc_plugin--switch{
        position: relative;
        font-size: 14px;
        height: 42px;
        line-height: 42px;
        margin-bottom: 10px;
    }
    .tc_total--title {
        height: 100px;
        padding: 20px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        background: rgb(202 215 241 / 20%);
        border-radius: 4px;
        color:#666
    }
    .tc_total_block {
        display: inline-block;
    }
    .tc_block--num--title {
        font-size: 17px;
    }
    .tc_block--num--num {
        font-size: 21px;
        font-weight: 400;
    }
    .tc_block--num {
        display: inline-block;
        vertical-align: text-bottom;
    }
    i.tc_icon {
        width: 48px;
        height: 57px;
        display: inline-block;
        background: url(/tamper_core/static/img/safety.png);
        background-position: 0 0px;
        margin-right: 15px;
    }
    .tc_icon.poritectLogo{background-position: 0 -56px;}
    
    .tc_intercept--type {
        margin-top: 15px;
        background: rgb(202 215 241 / 20%);
        padding: 15px 15px 0;
        border-radius: 4px;
        color: #666;
    }
    .tc_intercept--type--head {
        font-size: 15px;
        margin-bottom: 10px;
        color: #333;
    }
    .tc_intercept--line {
        height: 105px;
        padding:20px;
    }
    .tc_intercept--line i {
        background: url(/tamper_core/static/img/tc_type.png);
        display: inline-block;
        width: 38px;
        height: 28px;
        margin-bottom: 20px;
    }
    .tc_intercept--line i.tc_intercept--del{
        background-position: 0px -28px;
        height: 33px;
    }
    .tc_intercept--line i.tc_intercept--edit{
        background-position: 0 31px;
        height: 31px;
    }
    .tc_intercepe--type--block {
        display: inline-block;
        text-align: center;
        width: 170px;
        height: 66px;
        vertical-align: bottom;
    }
    .tc_intercepe--type--title {
        font-size: 15px;
    }
    .tc_intercepe--type--num {
        font-size: 20px;
    }
    .tc_warning--num{
        color:#666;
    }
    .tc_warning--num--today {
        background-color: #FFEBEB;
        color: #FF2E00;
        padding: 0px 5px;
    }
    .kernel_clone_masks {
        width: 100%;
        height: 100%;
        background: #fff;
        position: absolute;
        right: 0;
        top: 0;
    }
    .kernel_clone__box {
        text-align: center;
        width: 760px;
        height: 470px;
        background: #FAFAFA;
        margin: 50px auto;
        padding-top: 150px;
    }
    .kernel_clone__title {
        color: #666;
        font-size: 24px;
        margin-bottom: 10px;
    }
    .kernel_clone__title i{
        background: url(/tamper_core/static/img/service.png);
        width: 30px;
        height: 29px;
        display: inline-block;
        background-size: 100%;
        vertical-align: bottom;
    }
    .kernel_clone__subtitle {
        font-size: 14px;
        color: #999;
        margin-bottom: 20px;
    }
    /* 保护列表 */
    .website-status-box{
        display: block;
    }
    .website-status-box.active{
        background-color: #F5F5F5;
    }
    #addProSite .module-check.check_disabled label,
    #addProSite .module-check.check_disabled i{
        cursor: no-drop;
    }
    .website-status-box .no-drop-tag{
        background: #F7FEF9;
        color: #20a53a;
        padding: 0 4px;
        border-radius: 4px;
        transform: scale(0.8, 0.8);
        display: inline-block;
    }
    /* 全局设置 */
    #GlobalConfig .basic_set{
        padding: 15px 40px 0 40px;
        border-radius: 5px;
        background-color: rgba(250, 250, 250, 100);
        border: 1px solid rgba(221, 221, 221, 100);
    }
    #GlobalConfig .basic_set .line .tname{
        width: 160px;
    }
    #GlobalConfig .basic_set .line .info-r{
        margin-left: 160px;
    }
    .basic_global_set .line .tname{
        text-align: left;
        width: 60px;
        padding-right: 10px;
    }
    /* 防护日志 */
    #protectiveLog{
        margin-bottom: 10px;
        padding: 10px 20px;
    }
    #protectiveLog .table tr th:nth-child(2)>span,#protectiveLog .table tr td:nth-child(2)>span{
        width: 480px;
        overflow: hidden;
        white-space: nowrap;
    }
    #protectiveLog .table tr th:nth-child(5)>span,#protectiveLog .table tr td:nth-child(5)>span{
        width: 95px;
        overflow: hidden;
        white-space: nowrap;
    }
    .bt_table .tootls_top .pull-left input{
        width: 240px;
    }
    /* 保护列表 */
    #ProtectTable .table tr th:nth-child(2)>span,#ProtectTable .table tr td:nth-child(2)>span{
        word-wrap: break-word;
    }
    #ProtectTable .tHover{
        cursor: pointer;
    }
    .tc_log--select{
        display: inline-block;
        height: 28px;
        line-height: 28px;
        padding: 0 10px;
        border: 1px solid #ddd;
        position: relative;
        vertical-align: top;
        cursor: pointer;
        margin-right: 10px;
        color: #333;
    }
    .tc_log--select .tc_log--ul{
        transition: all 500ms;
        background: #fff;
        position: absolute;
        top: 30px;
        left: 0;
        display: none;
        box-shadow: 0 1px 5px rgb(0 0 0 / 50%);
        border-radius: 1px;
        width: 100%;
        z-index: 999;
        background-color: #fff;
        max-height: 200px;
        overflow: auto;
    }
    .tc_log--select .tc_log--ul li{
        height: 28px;
        line-height: 28px;
        padding: 0 10px;
        white-space: nowrap;
    }
    .tc_log--select .tc_log--ul li.active{
        color: #fff;
        background-color: #20a53a;
    }
    .tc_log--select .tc_log--ul li:hover {
        background-color: #f2f2f2;
    }
    /* 操作日志 */
    #OperationLog .divtable{
        margin-top: 0px;
    }
    #OperationLog .table tr th:nth-child(2)>span,#OperationLog .table tr td:nth-child(2)>span{
        width: 493px;
        overflow: hidden;
        white-space: nowrap;
    }
    /* 表格中的开关 */
    #ProtectTable .table .btswitch+.btswitch-btn,
    #usersWhite .btswitch+.btswitch-btn,
    #groupsWhite .btswitch+.btswitch-btn,
    #GlobalConfig .tab-con .table .btswitch+.btswitch-btn,
    #advancedConfig .tab-con .table .btswitch+.btswitch-btn,
    #CommonProcessTable .table .btswitch+.btswitch-btn{
        width: 2.4em;
        height: 1.4em;
        margin-bottom: 0;
    }
    
    #blackExts .divtable,.directorysWhite .divtable,.filesWhite .divtable{
        margin: 10px 0 0 0;
    }
    /* 全局配置 */
    .basic_global_set{
        margin-bottom: 10px;
    }
    .basic_global_set .line{
        padding: 0;
    }
    .basic_global_set .line .info-r{
        margin-bottom: 0;
    }
    code {
        padding: 1px 5px;
        font-size: 90%;
        color: #2196F3;
        background-color: #EEE;
        border-radius: 4px;
        margin: 2px;
    }
</style>
<script type="text/javascript" src="/static/js/echarts.min.js?version=7.9.29"></script>
<script type="text/javascript">
    (function () {
        // noinspection JSUnresolvedVariable
        var protectTable = null,
            usersWhiteTable = null,
            groupsWhiteTable = null,
            processsWhiteTable = null,
            blackExtsTable = null,
            directorysTable = null
        var tamper_core = {
            area: [1000, 630],
            configType : [
                { title: '创建文件',     name: 'create' },
                { title: '编辑文件',     name: 'modify' },
                { title: '删除文件',     name: 'unlink' },
                { title: '新建文件夹',   name: 'mkdir' },
                { title: '删除文件夹',   name: 'rmdir' },
                { title: '文件重命名',   name: 'rename' },
                { title: '创建软链',     name: 'link' },
                { title: '修改文件权限', name: 'chmod' },
                { title: '修改所有者',   name: 'chown' },
            ],
            alertListModule:[],   //告警设置获取的消息模块列表
            dirList:[],       //告警设置获取的目录列表
            kernel_module_status:true,  // 内核状态
            glabal_status:true, // 全局状态
            /**
             * @description 初始化项目
             */
            init: function () {
                var that = this;
                /* 插件，第一步设置布局宽度大小 */
                $('.layui-layer-page').css({
                    width: this.area[0] + 'px',
                    height: this.area[1] + 'px',
                    left: (($(window).width() - this.area[0]) / 2) + 'px',
                    top: (($(window).height() - this.area[1]) / 2) + 'px'
                }).find('.bt-w-main').css({height: (this.area[1] - 42) + 'px'})
                /* tab切换功能 */
                $('.tamper-core .bt-w-menu p').on('click', function () {
                    if(!that.kernel_module_status) return false;   // 内核启动失败
                    var tab = $(this), index = tab.index(), box = $('.bt-w-con .bt-box:eq(' + index + ')')
                    tab.addClass('bgw').siblings().removeClass('bgw');
                    box.addClass('active').siblings().removeClass('active');
                    switch (index) {
                        case 0:
                            that.overViewData()
                            break;
                        case 1:
                            that.renderTamperTable()
                            break;
                        case 2:
                            $('#GlobalConfig').find('.tab-nav,.tab-con').empty()
                            tamper_core.globalConfigPublic(2)
                            break;
                        case 3:
                            that.renderCommonTable()
                            break;
                        case 4:
                            that.renderAlertCrontab()
                            bt_tools.send({url:'config?action=get_msg_configs'},function(res){
                                var resetChannelMessage = [],prevArray = []
                                Object.getOwnPropertyNames(res).forEach(function(key) { 
                                    var mod = res[key]
                                    key == 'wx_account' ? prevArray.push(mod) :resetChannelMessage.push(mod)
                                })
                                that.alertListModule = prevArray.concat(resetChannelMessage)
                            })
                            bt_tools.send({url:'/tamper_core/get_tamper_paths.json'},function(dirList){
                                that.dirList = dirList
                            })
                            break;
                        case 5:
                            that.renderOperationLog()
                            break;
                    }
                    // 全局开关判断
                    if(!that.glabal_status && (index !=0 && index != 4 && index != 5)){
                        layer.msg('未开启防篡改全局开关，当前所有保护列表目录将失去保护！请到【概览】页面中开启',{icon:0,closeBtn: 2,shade: .3, shadeClose: true,time:0})
                    }
                })
                /* 服务状态处理*/
                $('.kernel_clone__btns button').click(function () {
                    var action  = $(this).data('action')
                    var str = $(this).text(), msg = ''
                    if(action == 'reload') {
                        msg = '重载项目后，当前项目服务将重载运行，是否继续操作？'
                    }else{
                        msg = str+'项目后，当前项目服务将'+str+'运行，是否继续操作？'
                    }
                    bt.confirm({
                        title: str+'防篡改服务',
                        msg: msg
                    }, function () {
                        bt_tools.send({url:'/tamper_core/service_admin.json', data: {action: action}}, function (res) {
                            bt_tools.msg(res)
                            if (res.status) {
                                tamper_core.overViewData()
                            }
                        },str+'防篡改服务')
                    })
                })
                /* 全局开关*/
                $('#serviceStatus').on('change',function(){
                    var _status = $(this).prop('checked');
                    bt_tools.send({url:'/tamper_core/modify_global_config.json',data:{key:'status',value:_status?1:0}},function(res){
                        that.glabal_status = _status
                        bt_tools.msg(res)
                    })
                })
                that.overViewData()
            },
            /**
             * @description 打开弹窗
             * @param msg 弹窗信息
             */
            openPopup: function(msg){
                var layerT = layer.msg(msg, $.extend({},{ time: 0, shade: .3 }))
                $('.layui-layer-msg').removeClass('layui-layer-hui')
                return layerT
            },
            /**
             * @description 获取概览页数据
             * @param
             */
            overViewData:function(){
                var that = this;
                bt_tools.send({url:'/tamper_core/get_glabal_total.json'},function(res){
                    // res.glabal_status.kernel_module_status = false;
                    that.kernel_module_status = (res.glabal_status.kernel_module_status && res.glabal_status.controller_status)    //内核、服务状态
                    that.glabal_status = res.glabal_status.settings_status
                    if(!that.kernel_module_status){
                        $('.kernel_clone_masks').removeClass('hide')
                        return false;
                    }else{
                        $('.kernel_clone_masks').addClass('hide')
                    }
                    $('#serviceStatus').prop('checked',that.glabal_status)
                    //拦截次数和类型次数
                    var interceptTotal = 0
                    for(var gkey in res.glabal){
                        if (res.glabal.hasOwnProperty(gkey)) {
                            var val = res.glabal[gkey],tVal = res.glabal_today[gkey];
                            interceptTotal += val
                            if(val > 0){
                                $('[name=g_'+gkey+']').html('<span class="tc_warning--num">'+val+'</span>')
                            }
                            if(tVal > 0){
                                $('[name=t_'+gkey+']').html('<span style="transform: scale(0.9, 0.9);display: inline-block;">今日新增</span><span class="tc_warning--num--today">↑ '+tVal+'</span>')
                            }
                        }
                    }
                    if(interceptTotal > 0)$('#interceptNum').html('<span style="color:#5CB85C">'+interceptTotal+'次</span>') //拦截总数
                    $('#protectDays').html('<span style="color:#5D88B4">'+res.days+'天</span>') // 保护天数
                    $('#alarmNum').html(res.glabal.warning_msg) // 告警次数
                })
            },
            /**
             * @description 渲染防篡改保护列表
             * @param
             */
            renderTamperTable: function () {
                var _that = this;
                protectTable = bt_tools.table({
                    el: '#ProtectTable',
                    url: '/tamper_core/get_tamper_paths.json',
                    load: true,
                    default: "暂无保护目录",
                    height: 390,
                    column: [{
                        type: 'checkbox',
                        class: '',
                        width: 20
                    }, {
                        fid: 'path',
                        title: '目录',
                        tips: '打开目录',
                        type: 'link',
                        width: 170,
                        event: function (row, index, ev) {
                            openPath(row.path);
                        }
                    }, {
                        fid: 'ps',
                        title: '备注',
                        type: 'input',
                        width: 90,
                        blur: function (row, index, ev, key, that) {
                            if (row.ps == ev.target.value) return false;
                            bt_tools.send({url:'/tamper_core/modify_path_config.json',data: {path_id: row.pid,key: 'ps',value:ev.target.value}}, function (rdata) {
                                bt_tools.msg(rdata);
                                if (rdata.status) {
                                    that.$refresh_table_list()
                                }
                            }, '修改备注')
                        },
                        keyup: function (row, index, ev) {
                            if (ev.keyCode === 13) {
                                $(this).blur();
                            }
                        }
                    }, {
                        title: '总次数',
                        type: 'text',
                        width: 70,
                        template:function (row, index, ev){
                            var num = 0,_title='';
                            for (var i = 0; i < _that.configType.length; i++) {
                                var t_num = row.total.all[_that.configType[i].name]
                                _title+=_that.configType[i].title+':'+t_num+'\n'
                                num += t_num
                            }
                            return '<span title="'+_title+'" class="tHover '+ (num > 0 ? 'color-red' : '') +'">'+num+'</span>'
                        }
                    },{
                        title: '今日',
                        type: 'text',
                        width: 70,
                        template:function (row, index, ev){
                            var num = 0,_title='';
                            for (var i = 0; i < _that.configType.length; i++) {
                                var t_num = row.total.today[_that.configType[i].name]
                                _title+=_that.configType[i].title+':'+t_num+'\n'
                                num += t_num
                            }
                            return '<span title="'+_title+'" class="tHover '+ (num > 0 ? 'color-red' : '') +'">'+num+'</span>'
                        }
                    }, {
                        title: '状态',
                        type: 'switch',
                        fid: 'status',
                        width: 75,
                        event: function (row, index, ev, key, that) {
                            row['status'] = !row['status'] ? 1 : 0;
                            var params = {
                                path_id: row.pid,
                                key: 'status',
                            }
                            var status_btn = $('#ProtectTable .table tbody tr:eq('+index+') .btswitch-btn').siblings(),
                                status = status_btn.prop('checked')
                            layer.confirm(!status ? '关闭该保护目录配置后，目录将失去保护，是否继续操作？' : '启用该保护目录配置后，目录将受到保护，是否继续操作？', {icon: 3, title: status ? '启用保护目录配置【'+ row.ps +'】' : '关闭保护目录配置【'+ row.ps +'】',closeBtn: 2,cancel: function () {
                                status_btn.prop('checked',!status)
                            }}, function (index) {
                                layer.close(index);
                                params['value'] = status ? 1 : 0;
                                bt_tools.send({url:'/tamper_core/modify_path_config.json',data: params}, function (res) {
                                    bt_tools.msg(res)
                                    if (res.status) {
                                        that.$refresh_table_list();
                                    }
                                },'修改状态')
                            }, function () {
                                status_btn.prop('checked',!status)
                            });
                        }
                    },{
                        title: '操作',
                        type: 'group',
                        width: '125px',
                        align: 'right',
                        group: [{
                            title: '日志',
                            event: function (rowc, index, ev, key, rthat) {
                                rthat.reader_protective_log(rowc)
                            }
                        },{
                            title: '配置',
                            event: function (rowc, index, ev, key, rthat) {
                                rthat.reader_advanced_configuration(rowc)
                            }
                        },{
                            title: '删除',
                            event: function (rowc, index, ev, key, rthat) {
                                rthat.delete_path_config(rowc, function(rdata) {
                                    bt_tools.msg(rdata);
                                    if (rdata.status) {
                                        rthat.$refresh_table_list();
                                    }
                                })
                            }
                        }]
                    }],
                    methods: {
                        /**
                         * @description 删除
                         * @param {object} config
                         * @param {function} callback
                         */
                        delete_path_config: function (config,callback){
                            bt.confirm({ title: '删除保护目录【' + config.ps + '】', msg: '删除该保护目录配置后，目录将失去保护，是否继续操作？' }, function () {
                                bt_tools.send({url:'/tamper_core/remove_path_config.json',data: {path_id:config.pid}}, function (rdata) {
                                    if (callback) callback(rdata)
                                }, '删除保护目录')
                            })
                         },
                        /**
                         * @description 防护日志
                         * @param {object} config
                         */
                        reader_protective_log: function (config,logday,searchT){
                            var renderR = this
                            bt_tools.send({url:'/tamper_core/get_logs.json',data: {path_id:config.pid,rows:10,p:1}}, function (rdata) {
                                if (rdata.length == 0) {
                                    layer.msg('暂无防护日志！',{icon:6})
                                }else{
                                    var log_day_list = '<div clsss="tc_log--selectBox" style="line-height: 30px;position: absolute;z-index: 99;">日期：<div class="tc_log--select">\
                                        <span class="tc_log--select__title">请选择日期</span>\
                                            <span class="glyphicon glyphicon-triangle-bottom ml5"></span>\
                                            <ul class="tc_log--ul">'+(function(){
                                                var log_li = ''
                                                for (var i = 0; i < rdata.dates.length; i++) {
                                                    var itemT = rdata.dates[i]
                                                    log_li += '<li class="tc_log--li" data-time="'+itemT+'">'+itemT+'</li>'
                                                }
                                                return log_li

                                            })()+'</ul>\
                                        </div><button type="button" class="btn btn-default btn-sm cleanLog">清理日志</button></div>'
                                    layer.open({
                                        type: 1,
                                        title:'防护日志-['+ config.path +']',
                                        closeBtn: 2,
                                        shadeClose: false,
                                        area:['1000px','550px'],
                                        skin: 'protectiveLog',
                                        content: '<div class="pd15">'+log_day_list+'<div id="protectiveLogTable"></div></div>',
                                        success: function (layers, indexs) {
                                            // 选择日期下拉
                                            $('.tc_log--select').click(function(e){
                                                var _ul = $(this).find('.tc_log--ul')
                                                if(!_ul.hasClass('show')){
                                                    _ul.addClass('show')
                                                }else{
                                                    _ul.removeClass('show')
                                                }
                                                $(document).one('click',function(){
                                                    _ul.removeClass('show');
                                                })
                                                e.stopPropagation();
                                            })
                                            // 选中日期
                                            $('.tc_log--li').click(function(){
                                                var thatLi = $(this),stime = thatLi.data('time')
                                                thatLi.addClass('active').siblings().removeClass('active')
                                                thatLi.parents('.tc_log--select').find('.tc_log--select__title').text(thatLi.text())
                                                renderR.render_protective_log_table(config,stime)
                                            })
                                            // 清理日志
                                            $('.cleanLog').click(function(){
                                                if(rdata.dates.length == 0){
                                                    layer.msg('暂无可清理的日志！',{icon:6})
                                                    return false;
                                                }
                                                bt_tools.open({
                                                    type:1,
                                                    title:'清理日志',
                                                    area:['330px','220px'],
                                                    btn:['确定','取消'],
                                                    content:{
                                                        class:'pd15',
                                                        form:[{
                                                            label:'需要清理的日期',
                                                            formLabelWidth:'110px',
                                                            group:[{
                                                                type:'select',
                                                                name:'date',
                                                                list:(function(){
                                                                    var log_li = []
                                                                    for (var i = 0; i < rdata.dates.length; i++) {
                                                                        var itemT = rdata.dates[i]
                                                                        log_li.push({title:itemT,value:itemT})
                                                                    }
                                                                    return log_li
                                                                })()
                                                            }]
                                                        },{
                                                            group: {
                                                                type: 'help',
                                                                list: [
                                                                    '当前仅支持按日期清理日志',
                                                                ],
                                                            },
                                                        }]
                                                    },
                                                    yes:function(formData,ind){
                                                        console.log({path_id:config.pid},formData);
                                                        return false;
                                                        bt_tools.send({url:'/tamper_core/del_logs.json',data: {path_id:config.pid,date:formData.date}}, function (rdata) {
                                                            if(rdata.status){
                                                                layer.close(ind)
                                                                renderR.render_protective_log_table(config)
                                                            }
                                                            bt_tools.msg(rdata)
                                                        }, '清理日志')
                                                    }
                                                })
                                            })
                                            // 渲染日志
                                            renderR.render_protective_log_table(config)
                                        }
                                    })
                                }
                            }, '获取防护日志')
                        },
                        /**
                         * @description 渲染日志表格
                         * @param {object} config
                         */
                        render_protective_log_table: function(config,timeT){
                            $('#protectiveLogTable').html('')    //处理date不生效
                            bt_tools.table({
                                el: '#protectiveLogTable',
                                url: '/tamper_core/get_logs.json',
                                load: true,
                                default: "暂无防护日志",
                                param: {
                                    path_id: config.pid,
                                    date:timeT
                                },
                                beforeRequest:function(beforeData){
                                    if(typeof beforeData.target != undefined && beforeData.target != ''){
                                        delete beforeData['date']
                                        $('.tc_log--select__title').text('请选择日期')
                                        $('.tc_log--li').removeClass('active')
                                    } 
                                    return beforeData
                                },
                                column: [{
                                        fid: 'date',
                                        title: '时间',
                                        type: 'text',
                                        width: '150px'
                                    },
                                    {
                                        fid: 'content',
                                        title: '目录',
                                        type: 'text',
                                        template: function (row){
                                            return '<span title="'+ row.content +'">'+row.content+'</span>'
                                        }
                                    },
                                    {
                                        fid: 'type',
                                        title: '触发类型',
                                        type: 'text',
                                        width: '110px',
                                        template: function (row){
                                            for (var i = 0; i < tamper_core.configType.length; i++) {
                                                if (row.type == tamper_core.configType[i].name) {
                                                    return tamper_core.configType[i].title
                                                }
                                            }
                                        }
                                    },
                                    {
                                        fid: 'user',
                                        title: '用户',
                                        type: 'text',
                                        width: '100px'
                                    },
                                    {
                                        fid: 'process',
                                        title: '进程',
                                        type: 'text',
                                        width: '115px',
                                        template: function (row){
                                            return '<span title="'+ row.process +'">'+row.process+'</span>'
                                        }
                                    }
                                ],
                                tootls: [{ // 搜索内容
                                    type: 'search',
                                    placeholder: '请输入目录查询',
                                    searchParam: 'target', //搜索请求字段，默认为 search
                                },{   //分页显示
                                    type: 'page',
                                    positon: ['right', 'bottom'], // 默认在右下角
                                    pageParam: 'p', //分页请求字段,默认为 : p
                                    page: 1, //当前分页 默认：1
                                    numberParam: 'rows', //分页数量请求字段默认为 : limit
                                    number: 10, //分页数量默认 : 10条
                                }]
                            })
                        },
                        /**
                         * @description 配置
                         * @param {object} config
                         */
                        reader_advanced_configuration: function (config){
                            layer.open({
                                type: 1,
                                title:'配置-['+ config.path +']',
                                closeBtn: 2,
                                shadeClose: false,
                                area:['800px','650px'],
                                // btn: ['提交','取消'],
                                skin: 'advancedConfig',
                                content: '<div id="advancedConfig" class="pd20">\
                                    <div class="bt-form mb15">\
                                        <div class="line adStatus" style="background-color: '+ (config.status == 0 ? 'rgba(255, 0, 0,0.1)':'rgba(32, 165, 58,0.2)') +';">\
                                            <span class="tname">防篡改开关</span>\
                                            <div class="info-r">\
                                                <div class="inlineBlock mr10" style="margin-top: 5px;vertical-align: -6px;">\
                                                    <input class="btswitch btswitch-ios" id="status" type="checkbox" '+ (config.status == 1 ? 'checked' : '') +'>\
                                                    <label class="btswitch-btn" for="status"></label>\
                                                </div>\
                                                <span class="unit" style="vertical-align: super;'+(config.status == 0 ? '':'display:none;' )+'">当前目录防篡改已关闭，可能存在安全风险，建议立即开启防护</span>\
                                            </div>\
                                        </div>\
                                    </div>\
                                </div>',
                                success: function (layers, indexs) {
                                    $('#advancedConfig').append('<div id="tabTamperConfig" class="tab-nav"></div><div class="tab-con" style="padding:5px 0 0 0;"></div>');
                                    tamper_core.globalConfigPublic(1,config)
                                }
                            })
                        }
                    },
                    tootls: [{
                        type: 'group',
                        positon: ['left', 'top'],
                        list: [{
                            title: '添加保护',
                            active: true,
                            event: function (ev, that) {
                                var addProDir = null,addProSite = null;
                                bt_tools.send({url:'/tamper_core/get_sites_path.json'},function(sites){
                                    sites.forEach(function(siteL,ikey){
                                        siteL['sId'] = 'site_'+ikey
                                    })
                                    layer.open({
                                        type: 1,
                                        title:'添加保护',
                                        closeBtn: 2,
                                        shadeClose: false,
                                        area:['550px','420px'],
                                        btn: ['提交','取消'],
                                        skin: 'addDefend',
                                        content: '<div class="pd15"><div id="addDirMode" class="tab-nav"></div><div class="tab-con"></div><ul class="help-info-text c7" style="margin-left:30px; margin-top:0;position: absolute;bottom: 10px;"><li>防篡改默认支持拦截以下操作（继承当前全局配置，可单独配置）：文件和目录创建、修改、删除、重命名、创建软链，权限修改，所有者修改</li><li>单独配置优先级大于全局配置</li></ul></div>',
                                        success: function (layers, indexs) {
                                            var _tabs = [{
                                                title:'站点列表',
                                                callback:function(robj){
                                                    robj.html('<div id="addProSite"></div>')
                                                    var _group = []
                                                    sites.forEach(function(item,indexK){
                                                        _group.push({
                                                            type: 'checkbox',
                                                            disabled: !item.can_create,
                                                            name:item.sId,
                                                            class:'module-check website-status-box '+(!item.can_create?'check_disabled':''),
                                                            style:{'display': 'block','padding': '0 10px','line-height': '26px !important'},
                                                            title:item.name+(!item.can_create?'<span class="no-drop-tag">[已保护]</span>':''),
                                                            event:function(formData,element,thatE,key,rthat){
                                                                var parentNode = $(rthat.currentTarget).parents('.website-status-box');
                                                                thatE.config.form[0].group[indexK].value = !formData[item.sId]?0:1;
                                                                if(formData[item.sId]){
                                                                    parentNode.addClass('active')
                                                                }else{
                                                                    parentNode.removeClass('active')
                                                                }
                                                            }
                                                        })
                                                    })
                                                    addProSite = bt_tools.form({
                                                        el: '#addProSite',
                                                        form: [
                                                            {
                                                                label: '选择站点',
                                                                style:{
                                                                    'margin-top': '5px',
                                                                    'border': '1px solid #ccc',
                                                                    'width':'340px',
                                                                    'padding': '5px 0',
                                                                    'max-height': '142px',
                                                                    'overflow': 'auto'
                                                                },
                                                                group:_group
                                                            }
                                                        ],
                                                    })
                                                }
                                            },{
                                                title:'自定义目录',
                                                callback:function(robj){
                                                    robj.html('<div id="addProDir"></div>')
                                                    addProDir = bt_tools.form({
                                                        el: '#addProDir',
                                                        form: [
                                                            {
                                                                label: '选择目录',
                                                                group: [
                                                                    {
                                                                        name: 'path',
                                                                        width: '309px',
                                                                        type: 'text',
                                                                        placeholder: '请选择需要保护目录',
                                                                        icon: {
                                                                            type: 'glyphicon-folder-open',
                                                                            event: function () {},
                                                                            callback: function (path) {
                                                                                var pathList = path.split('/');
                                                                                var fileName = pathList[pathList.length - 1] == '' ? pathList[pathList.length - 2] : pathList[pathList.length - 1];
                                                                                this.config.form[1].group.value = fileName;
                                                                                this.$replace_render_content(1);
                                                                            }
                                                                        }
                                                                    }
                                                                ]
                                                            },
                                                            {
                                                                label: '备注',
                                                                group: {
                                                                    name: 'ps',
                                                                    width: '309px',
                                                                    type: 'text',
                                                                    placeholder: '请输入该保护目录相关描述'
                                                                }
                                                            }
                                                        ]
                                                    })
                                                }
                                            }]
                                            bt.render_tab('addDirMode', _tabs)
                                            $('#addDirMode span:eq(0)').click();
                                        },
                                        yes: function (indexs) {
                                            var tabIndex = $('#addDirMode span.on').index(),checkSite = [];
                                            if(tabIndex == 0){
                                                var formDataSite = addProSite.$get_form_value()
                                                for(var key in formDataSite){
                                                    if(formDataSite.hasOwnProperty(key)){
                                                        if(formDataSite[key]){
                                                            sites.forEach(function(siteA,ikey){
                                                                if(siteA.sId == key){
                                                                    checkSite.push({path:siteA.path,ps:siteA.name})
                                                                }
                                                            })
                                                        }
                                                    }
                                                }
                                                if(checkSite.length == 0) return layer.msg('请选择站点！',{icon:0})
                                            }else{
                                                var formDataDir = addProDir.$get_form_value()
                                                if(formDataDir.path == '') return layer.msg('目录不能为空！',{icon:0})
                                                if(formDataDir.ps == '') return layer.msg('备注不能为空！',{icon:0})
                                                checkSite = [formDataDir]
                                            }
                                            bt_tools.send({url:'/tamper_core/multi_create.json',data: {paths:JSON.stringify(checkSite)}}, function (res) {
                                                var resultHTML = ''
                                                res.forEach(function(item,skey){
                                                    resultHTML +=  '<tr><td>' +item.ps +'</td>'+
                                                        '<td><div style="float:right;"><span style="color:' +
                                                        (item.status ? '#20a53a' : 'red') +
                                                        '">' + item.msg +
                                                        '</span></div></td></tr>';
                                                })
                                                bt.open({
                                                    type: 1,
                                                    title: '添加保护结果',
                                                    area:['350px', '350px'],
                                                    shadeClose: false,
                                                    closeBtn: 2,
                                                    content: '<div class="batch_title"><span class><span class="batch_icon"></span><span class="batch_text">添加保护操作完成！</span></span></div><div class="' + (res.length > 4 ? 'fiexd_thead' : '') + ' batch_tabel divtable" style="margin: 15px 30px 15px 30px;overflow: auto;height: 200px;"><table class="table table-hover"><thead><tr><th>名称</th><th style="text-align:right;width:120px;">操作结果</th></tr></thead><tbody>' + resultHTML + '</tbody></table></div>',
                                                    success: function () {
                                                        if (res.length > 4){
                                                            $('.fiexd_thead').scroll(function () {
                                                                var scrollTop = this.scrollTop;
                                                                this.querySelector('thead').style.transform = 'translateY(' + (scrollTop-1) + 'px)';
                                                            });
                                                        }
                                                    }
                                                });

                                                layer.close(indexs)
                                                that.$refresh_table_list();
                                            })
                                        }
                                    })
                                },'获取站点列表')
                            }
                        }]
                    }, { // 批量操作
                        type: 'batch',
                        positon: ['left', 'bottom'],
                        placeholder: '请选择批量操作',
                        buttonValue: '批量操作',
                        disabledSelectValue: '请选择需要批量操作的站点!',
                        selectList: [{
                            title: "启用目录配置",
                            load: true,
                            url: '/tamper_core/modify_path_config.json',
                            param: function (crow) {
                                return {
                                    path_id: crow.pid,
                                    key: 'status',
                                    value: 1
                                }
                            },
                            callback: function (that) { // 手动执行,data参数包含所有选中的站点
                                bt.show_confirm("批量启用目录配置", "<span style='color:red'>启用选中保护目录配置后，目录将受到保护，是否继续操作？</span>", function () {
                                    var param = {};
                                    that.start_batch(param, function (list) {
                                        var html = '';
                                        for (var i = 0; i < list.length; i++) {
                                            var item = list[i];
                                            html += '<tr><td>' + item.path + '</td><td><div style="float:right;"><span style="color:' + (item.request.status ? '#20a53a' : 'red') + '">' + item.request.msg + '</span></div></td></tr>';
                                        }
                                        protectTable.$batch_success_table({
                                            title: '批量启用目录配置',
                                            th: '目录名称',
                                            html: html
                                        });
                                        protectTable.$refresh_table_list(true);
                                    });
                                });
                            }
                        },{
                            title: "关闭目录配置",
                            load: true,
                            url: '/tamper_core/modify_path_config.json',
                            param: function (crow) {
                                return {
                                    path_id: crow.pid,
                                    key: 'status',
                                    value: 0
                                }
                            },
                            callback: function (that) { // 手动执行,data参数包含所有选中的站点
                                bt.show_confirm("批量关闭目录配置", "<span style='color:red'>关闭选中保护目录配置后，目录将失去保护，是否继续操作？</span>", function () {
                                    var param = {};
                                    that.start_batch(param, function (list) {
                                        var html = '';
                                        for (var i = 0; i < list.length; i++) {
                                            var item = list[i];
                                            html += '<tr><td>' + item.path + '</td><td><div style="float:right;"><span style="color:' + (item.request.status ? '#20a53a' : 'red') + '">' + item.request.msg + '</span></div></td></tr>';
                                        }
                                        protectTable.$batch_success_table({
                                            title: '批量关闭目录配置',
                                            th: '目录名称',
                                            html: html
                                        });
                                        protectTable.$refresh_table_list(true);
                                    });
                                });
                            }
                        },{
                            title: "删除",
                            load: true,
                            url: '/tamper_core/remove_path_config.json',
                            param: function (crow) {
                                return {
                                    path_id:crow.pid
                                }
                            },
                            callback: function (that) { // 手动执行,data参数包含所有选中的站点
                                bt.show_confirm("批量删除目录配置", "<span style='color:red'>删除选中保护目录配置后，目录将失去保护，是否继续操作？</span>", function () {
                                    var param = {};
                                    that.start_batch(param, function (list) {
                                        var html = '';
                                        for (var i = 0; i < list.length; i++) {
                                            var item = list[i];
                                            html += '<tr><td>' + item.path + '</td><td><div style="float:right;"><span style="color:' + (item.request.status ? '#20a53a' : 'red') + '">' + item.request.msg + '</span></div></td></tr>';
                                        }
                                        protectTable.$batch_success_table({
                                            title: '批量删除',
                                            th: '目录名称',
                                            html: html
                                        });
                                        protectTable.$refresh_table_list(true);
                                    });
                                });
                            }
                        }]
                    }],
                    success: function (layers,indexs) {
                        if(!$('#ProtectTable .help-info-text').length){
                            $('#ProtectTable').append('<ul class="help-info-text c7" style="margin-top:5px;">\
                            <li>开启防篡改后，部分项目【无法更新，文件无法上传，无法操作等】，需要关闭防篡改或添加白名单</li>\
                            </ul>')
                        }
                    }
                })
            },
            /**
             * @description 渲染防篡改快速放行表格
             * @param
             */
            renderCommonTable: function () {
                bt_tools.table({
                    el: '#CommonProcessTable',
                    url: '/tamper_core/get_frequent_process.json',
                    height: '365',
                    load: true,
                    default: "暂无放行列表",
                    column: [
                        {
                            fid: 'name',
                            title: '进程名称',
                            type: 'text',
                            template: function (rowc) {
                                return '<span>'+rowc.name+'('+rowc['zh-cn']+')</span>'
                            }
                        },{
                            fid:'ps',
                            title:'说明',
                            type:'text',
                        },
                        {
                            title: '状态',
                            type: 'switch',
                            fid: 'status',
                            width: '35px',
                            align: 'right',
                            event: function (rowc, index, ev, key, rthat) {
                                var status_btn = $('#CommonProcessTable tbody tr:eq('+index+') .btswitch-btn').siblings(),
                                    status = status_btn.prop('checked')
                                bt_tools.send({url:status?'/tamper_core/add_process_names.json':'/tamper_core/remove_process_names.json'}, {pname:rowc.name}, function (rdata) {
                                    if(rdata.status){
                                        layer.msg('进程已'+(status?'开启':'关闭'),{icon:1})
                                    }else{
                                        bt_tools.msg(rdata);
                                    }
                                },(status?'开启':'关闭')+rowc.name+'进程防护')
                            }
                        }
                    ],
                    tootls: false
                })
            },
            /**
             * @description 渲染防篡改告警设置表格
             * @param
             */
            renderAlertCrontab: function (){
                var that = this;
                var AlertSettingTable = bt_tools.table({
                    el:'#AlertSettingTable',
                    url:'/push?action=get_push_list',
                    load:true,
                    default:'暂无告警任务',
                    dataFilter: function(res){
                        var data = res.tamper_push, data1 = []
                        for(var ckey in data){
                            data1.push($.extend(data[ckey],{alertID:ckey}))
                        }
                        return {data:data1}
                    },
                    column:[{
                        fid: 'title',
                        title: '标题',
                        type: 'text'
                    },{
                        fid: 'status',
                        title: '状态',
                        width:56,
                        config: {
                            icon: true,
                            list: [
                                [true, '正常', 'bt_success', 'glyphicon-play'],
                                [false, '停用', 'bt_danger', 'glyphicon-pause']
                            ]
                        },
                        type: 'status',
                        event: function(row){
                            bt_tools.send({url:'/push?action=set_push_status'}, {id:row.alertID,name:'tamper_push',status:row.status?0:1}, function (rdata) {
                                bt_tools.msg(rdata);
                                if (rdata.status) {
                                    AlertSettingTable.$refresh_table_list()
                                }
                            },'删除告警任务')
                        }
                    },{
                        title: '告警方式',
                        type: 'text',
                        width:235,
                        template: function(row) { 
                            var alertMode = row.module.split(','), _mode = '', _modeList = [{title:'微信公众号',name:'wx_account'},{title:'企业微信',name:'weixin'},{title:'邮箱',name:'mail'},{title:'钉钉',name:'dingding'}, {title:'飞书',name:'feishu'},{title:'短信',name:'sms'}]
                            _modeList.forEach(function(mod) {
                                if ($.inArray(mod.name, alertMode) >= 0) _mode += mod.title + ','
                            })
                            _mode = _mode.substring(0,_mode.length-1)
                            return '<span>'+_mode+'</span>'
                        }
				    },{
                        fid: 'cycle',
                        title: '告警条件',
                        template: function(row) {
                            return '<span>'+row.cycle+'分钟内连续'+row.count+'次触发篡改,每'+row.interval+'秒后再次检测(每日最高推送'+row.push_count+'次)</span>'
                        }
                    },{
                        title: '操作',
                        type: 'group',
                        width: 85,
                        align: 'right',
                        group: [{
                            title: '编辑',
                            event: function(row) {
                                that.setAlertTaskConfig(row)
                            }
                        },{
                            title: '删除',
                            event:function(row) {
                                bt.confirm({ title: '删除告警任务', msg: '删除后将不再告警此条任务，是否继续？' }, function () {
                                    bt_tools.send({url:'/push?action=del_push_config'}, {id:row.alertID,name:'tamper_push'}, function (rdata) {
                                        bt_tools.msg(rdata);
                                        if (rdata.status) {
                                            AlertSettingTable.$refresh_table_list()
                                        }
                                    },'删除告警任务')
                                })
                            }
                        }]
                    }],
                    tootls: [{
                        type: 'group',
                        positon: ['left', 'top'],
                        list: [{
                            title: '添加告警任务',
                            active: true,
                            event: function() {
                                that.setAlertTaskConfig()
                            }
                        }]
                    }]
                })
            },
            /**
             * @description 渲染操作日志
             * @param
             */
            renderOperationLog: function () {
                $('#OperationLog').html('')
                var OperationLog = bt_tools.table({
                    el: '#OperationLog',
                    url: '/tamper_core/get_action_logs.json',
                    load: true,
                    default: "暂无保护目录",
                    height: '520',
                    column: [
                        {
                            fid: 'addtime',
                            title: '时间',
                            type: 'text',
                            width: '150px'
                        }, {
                            fid: 'log',
                            title: '详情',
                            type: 'text',
                            template: function (row){
                                return '<span title="'+ row.log +'">'+row.log+'</span>'
                            }
                        }
                    ],
                    tootls: [{ //分页显示
                        type: 'page',
                        positon: ['right', 'bottom'], // 默认在右下角
                        pageParam: 'p', //分页请求字段,默认为 : p
                        page: 1, //当前分页 默认：1
                        numberParam: 'rows', //分页数量请求字段默认为 : limit
                        defaultNumber: 12, //分页数量默认 : 12条
                    }]
                })
            },
            /**
             * @description 设置告警任务
             * @param {Object} row   当前行数据
             */
            setAlertTaskConfig: function (row) {
                var _title = '编辑告警任务',_btn = ['保存', '取消'],isEdit = row ? true : false,that = this
                if(!row){
                    _title = '创建告警任务'
                    row = {}
                    _btn = ['创建', '取消']
                }
                bt_tools.open({
                    type: 1,
                    title: _title,
                    area: '520px',
                    skin:'tamper-alert-task',
                    btn: _btn,
                    content: {
                        class:'pd15',
                        data: row,
                        form: [{
                            label: '保护列表',
                            group: {
                                type: 'select',
                                name: 'pid',
                                width: '320px',
			                    class:'projectBox',
                                value: '',
                                disabled:isEdit,
                                list: (function(){
                                    var list = [{title:'全部目录',value:0}]
                                    that.dirList.forEach(function(item){
                                        list.push({title:item.path+'['+item.ps+']',value:item.pid,path:item.path})
                                    })
                                    return list
                                })()
                            }
                        },{
                            label: '触发条件',
                            group: [{
                                type: 'number',
                                name: 'cycle',
                                width: '70px',
                                value: 30,
                                unit: '分钟内,篡改',
                            }, {
                                type: 'number',
                                name: 'count',
                                width: '50px',
                                style:{'vertical-align':'initial','margin-left':'10px'},
                                value: 3,
                                unit: '次',
                            }]
                        }, {
                            label: '间隔时间',
                            group: {
                                type: 'number',
                                name: 'interval',
                                width: '70px',
                                value: 600,
                                unit: '秒后再次监控触发条件'
                            }
                        }, {
                            label: '每日推送',
                            group: {
                                type: 'number',
                                name: 'push_count',
                                width: '70px',
                                value: 1,
                                unit: '次后停止推送，次日再次监控'
                            }
                        }, {
                            label:'告警方式',
                            group: that.switchPushType(row)
                        }]
                    },
                    success: function(layers) {
                        // 点击安装
                        $('.alertInstall').click(function(ev) {
                            var type = $(ev.currentTarget).parent('span').siblings('input').attr('name'),
                                _config = that.alertListModule.find(function(item) {
                                    return item.name == type
                                })
                            switch (type) {
                                case 'mail':
                                    renderMailConfigView(_config)
                                    break;
                                case 'dingding':
                                case 'feishu':
                                case 'weixin':
                                    console.log(that.alertListModule,type,_config,'xxx')
                                    renderAlertUrlTypeChannelView(_config)
                                    break;
                                case 'wx_account':
                                case 'sms':
                                    alertOtherTypeInstall(_config)
                                    break;
                            }
                        })
                    },
                    yes:function(formData,indexs){
                        if(formData.cycle == '' || formData.cycle <= 0) return layer.msg('触发时间不能小于1',{icon:2})
                        if(formData.count == '' || formData.count <= 0) return layer.msg('触发次数不能小于1',{icon:2})
                        if(formData.interval == '' || formData.interval <= 0) return layer.msg('间隔时间不能小于1',{icon:2})
                        if(formData.push_count == '' || formData.push_count <= 0) return layer.msg('发送次数不能小于1',{icon:2})
                        var eData = $.extend(true,{},{
                            cycle:Number(formData.cycle),
                            count:Number(formData.count),
                            interval:Number(formData.interval),
                            push_count:Number(formData.push_count)
                        }),
                        isCheck = [],
                        thatPid = Number($('.tamper-alert-task [name=pid]').val())
                        checkDir = that.dirList.find(function(item){
                            return item.pid == thatPid
                        })
                        $('.tamper-alert-task .module-check').not('.check_disabled').each(function(){
                            if($(this).find('input').prop('checked')){
                                isCheck.push($(this).find('input').prop('name'))
                            }
                        })
                        eData['module'] = isCheck.join();
                        eData['type'] = ' '
                        if(!eData['module']){
                            layer.msg('请选择一种告警方式。',{icon:2})
                            return false
                        }
                        eData['title'] = ($('.tamper-alert-task .projectBox .bt_select_content').html() == '全部目录'?'【全部目录】':('【'+checkDir.path+'】'))+'篡改告警';

                        bt_tools.send({url:'/push?action=set_push_config',data:{id:thatPid,name:'tamper_push',data:JSON.stringify(eData)}},function(res){
                            bt_tools.msg(res)
                            if (res.status) {
                                layer.close(indexs)
                                that.renderAlertCrontab();
                            }
                        })
                    }
                })
            },
            /**
             * @description 告警类型展示内容
             * @param {Object} formData  表单数据
             */
            switchPushType:function(formData){
                var _checklist = [],isCheckType = [],accountConfigStatus = false;
                this.alertListModule.forEach(function(mod, i) {
                    if(formData.module){
                        isCheckType = formData.module.split(',')
                    }
                    if(mod.name === 'wx_account'){
                        if(!$.isEmptyObject(mod.data) && mod.data.res.is_subscribe && mod.data.res.is_bound){
                            accountConfigStatus = true   //安装微信公众号模块且绑定
                        }    
                    } 
                    _checklist.push({
                        type: 'checkbox',
                        name:mod.name,
                        class:'module-check '+((!mod.setup || $.isEmptyObject(mod.data))?'check_disabled':((mod.name == 'wx_account' && !accountConfigStatus)?'check_disabled':''))+'',
                        style:{'margin-right': '10px'},
                        disabled:(!mod.setup || $.isEmptyObject(mod.data))?true:((mod.name == 'wx_account' && !accountConfigStatus)?true:false),
                        value:$.inArray(mod.name,isCheckType) >= 0 ?1:0,
                        title:(mod.name == 'wx_account'?'<b style="color: #fc6d26;">[推荐]</b>':'')+mod.title+((!mod.setup || $.isEmptyObject(mod.data))?'<span style="color:red;cursor: pointer;" class="alertInstall">[点击安装]</span>':(((mod.name == 'wx_account' && !accountConfigStatus)?'[<a target="_blank" class="bterror alertInstall">未配置</a>]':''))),
                        event: function(formData, element, thatE) {
                            thatE.config.form[4].group[i].value = !formData[mod.name]?0:1;
                        }
                    })
                })
                return _checklist
            },
            /**
             * @description 高级配置全局配置公共
             * @param
             */
            globalConfigPublic: function(type,config) {
                var _that = this
                var configType = tamper_core.configType
                var basicSet = {
                    title:'基础设置',
                    on:true,
                    callback:function(robj){
                        var url = '/tamper_core/get_tamper_global_config.json',el = '#GlobalConfig .tab-con'
                        if (type == 1) url = '/tamper_core/get_tamper_paths.json',el = '#advancedConfig .tab-con'
                        bt_tools.table({
                            el: el,
                            url: url,
                            height: '520px',
                            load: true,
                            default: "空",
                            dataFilter: function (res) {
                                var data1 = [],data2 = res
                                if (type == 1) {
                                    for (var j = 0; j < res.length; j++) {
                                        if (res[j].pid == config.pid) {
                                            data2 = res[j]
                                        }
                                    }
                                }
                                for (var i = 0; i < configType.length; i++) {
                                    data1.push({name: '禁止'+configType[i].title,key: 'is_'+configType[i].name,status: data2['is_'+configType[i].name]})
                                }
                                return { data: data1 };
                            },
                            column: [{
                                fid: 'name',
                                title: '名称',
                                type: 'text',
                            },{
                                title: '状态',
                                type: 'switch',
                                fid: 'status',
                                width: '35px',
                                align: 'right',
                                event: function (rowc, index, ev, key, rthat) {
                                    if (_that.glabal_status || type == 1) {
                                        var idName = type == 1 ? 'advancedConfig' : 'GlobalConfig'
                                        var status = $('#'+idName+' .tab-con tbody tr:eq('+index+') .btswitch-btn').siblings().prop('checked')
                                        var url = 'tamper_core/modify_global_config.json', params = {
                                            key: rowc.key,
                                            value: status == true ? 1 : 0
                                        }
                                        if (type == 1) {
                                            url = '/tamper_core/modify_path_config.json'
                                            params['path_id'] = config.pid
                                        }
                                        bt_tools.send({url:url},params, function (rdata) {
                                            bt_tools.msg(rdata);
                                        },rowc.name)
                                    }
                                }
                            }]
                        })
                        if (type==2) {
                            if(!_that.glabal_status){
                                setTimeout(function(){
                                    var status = $('#GlobalConfig .tab-con tbody tr .btswitch-btn').siblings()
                                    status.prop('disabled',true)
                                    $('#GlobalConfig .tab-con tbody tr .btswitch-btn').click(function() {
                                        layer.msg('全局开关未开启，不能修改',{icon:0})
                                    })
                                },100)
                            }
                        }else{
                            var status = $('#status'),
                                parent = status.parent().parent().parent(),
                                adStatus = $('.adStatus')
                                adStatusUnit = $('.adStatus .unit')
                            status.click(function() {
                                if (status.prop('checked')) {
                                    adStatus.css('background-color','rgba(32, 165, 58,0.2)')
                                    adStatusUnit.css('display','none')
                                } else {
                                    adStatus.css('background-color','rgba(255, 0, 0,0.1)')
                                    adStatusUnit.css('display','inline-block')
                                }
                                var params = {
                                    path_id : config.pid,
                                    key: 'status',
                                    value: status.prop('checked') == true ? 1 : 0
                                }
                                upSwitch(params)
                            })
                        }
                        function upSwitch(params) {
                            var load = params.value == 0 ? '禁止' : '开启'
                            if (type == 1) {
                                url = 
                                load += '防篡改'
                            }else{
                                load += '全局'
                            }
                            bt_tools.send({url:'/tamper_core/modify_path_config.json',data: params}, function (rdata) {
                                bt_tools.msg(rdata);
                                if (rdata.status) {
                                    if (type == 1) protectTable.$refresh_table_list()
                                }
                            }, load)
                        }
                        robj.append('<ul class="help-text-info mb15 pl7"><li>提示：当前配置默认拦截以上规则，请根据当前项目需求设置和配置规则</li></ul>')
                    }
                }
                var proFileSuf = {
                    title:'受保护的文件后缀',
                    callback:function(robj){
                        robj.html('<div id="blackExts" class="mt10"></div>')
                        blackExtsTable = bt_tools.table({
                            el: '#blackExts',
                            url: '/tamper_core/get_tamper_paths.json',
                            height: '269',
                            load: true,
                            default: "暂无受保护的文件后缀",
                            dataFilter: function (res) {
                                var data1 = []
                                for (var i = 0; i < res.length; i++) {
                                    if (res[i].pid == config.pid) {
                                        var black_exts = res[i].black_exts
                                        for (var j = 0; j < black_exts.length; j++) {
                                            data1.push({exts:black_exts[j]})
                                        }
                                    }
                                }
                                return { data: data1 };
                            },
                            column: [
                                {
                                    fid: 'exts',
                                    title: '后缀名',
                                    type: 'text',
                                },{
                                    title: '操作',
                                    type: 'group',
                                    width: '200px',
                                    align: 'right',
                                    group: [{
                                        title: '删除',
                                        event: function (rowc, index, ev, key, rthat) {
                                            var params = {
                                                path_id: config.pid,
                                                path: config.path,
                                                exts: rowc.exts
                                            }
                                            bt.confirm({ title: '删除受保护的文件后缀【' + rowc.exts + '】', msg: '删除受保护的文件后缀后，文件名以该后缀结尾的文件将失去保护，是否继续操作？' }, function () {
                                                bt_tools.send({url:'/tamper_core/remove_black_exts.json'}, params, function (rdata) {
                                                    bt_tools.msg(rdata);
                                                    if (rdata.status) {
                                                        blackExtsTable.$refresh_table_list()
                                                    }
                                                },'删除受保护的文件后缀')
                                            })
                                        }
                                    }]
                                }
                            ],
                            tootls: [{ // 按钮组
                                type: 'group',
                                positon: ['left', 'top'],
                                list: [{
                                    title: '添加',
                                    active: true,
                                    event: function (ev, that) {
                                        var exts = $('input[name=exts]').val()
                                        if(exts == '') return layer.msg('请输入后缀名', {icon:2})
                                        var params = {
                                            path_id: config.pid,
                                            path: config.path,
                                            exts: exts
                                        }
                                        bt_tools.send({url:'/tamper_core/add_black_exts.json'}, params, function (rdata) {
                                            bt_tools.msg(rdata);
                                            if (rdata.status) {
                                                blackExtsTable.$refresh_table_list()
                                                $('input[name=exts]').val('')
                                            }
                                        },'添加扩展名')
                                    }
                                }]
                            }],
                            success: function () {
                                if($('input[name=exts]').length == 0){
                                    $('#blackExts .tootls_top .pull-left .btn').before('<input type="text" name="exts" placeholder="后缀名" class="bt-input-text mr10 " value="">')
                                }
                            }
                        })
                        robj.append('<ul class="help-info-text mt10 pl7">\
                            <li>所谓文件后缀是指文件名结尾的字符串，不一定是扩展名</li>\
                            <li>例如<code>.php</code>,<code>.html</code>,<code>.js</code>,<code>index.php</code>等</li>\
                            示例：\
                            <li><code>.php</code> 匹配：<code>./1.php</code> <code>./test/2.php</code> 不匹配：<code>./1.php/1.txt</code></li>\
                            <li><code>index.php</code> 匹配：<code>./index.php</code> <code>./test/index.php</code> <code>./abc_index.php</code>不匹配：<code>./index.php.tar.gz</code></li>\
                        </ul>')
                    }
                }
                var directoryWhite = {
                    title:'目录白名单',
                    callback:function(robj){
                        robj.html('<div id="directorysWhite" class="mt10"></div>')
                        directorysTable = bt_tools.table({
                            el: '#directorysWhite',
                            url: '/tamper_core/get_tamper_paths.json',
                            height: '218',
                            load: true,
                            default: "暂无目录白名单",
                            dataFilter: function (res) {
                                var white_dirs = []
                                for (var i = 0; i < res.length; i++) {
                                    if (res[i].pid == config.pid) {
                                        res[i].white_dirs.ps = res[i].white_dirs.ps || ''
                                        white_dirs = res[i].white_dirs.map(function(res){
                                            res.ps = res.ps || ''
                                            return res
                                        })
                                    }
                                }
                                return { data: white_dirs };
                            },
                            column: [
                                {
                                    fid: 'dir',
                                    title: '目录名',
                                    type: 'text',
                                },{
                                    fid: 'ps',
                                    title: '备注',
                                    type: 'input',
                                    blur: function (row, index, ev, key, that) {
                                        if (row.ps == ev.target.value) return false;
                                        bt_tools.send({url:'/tamper_core/set_white_dir_with_ps.json',data: {path_id: config.pid,dir_name:row.dir,ps:ev.target.value}}, function (rdata) {
                                            bt_tools.msg(rdata);
                                            if (rdata.status) {
                                                that.$refresh_table_list()
                                            }
                                        }, '修改备注')
                                    },
                                    keyup: function (row, index, ev) {
                                        if (ev.keyCode === 13) {
                                            $(this).blur();
                                        }
                                    }
                                },{
                                    title: '操作',
                                    type: 'group',
                                    width: '60px',
                                    align: 'right',
                                    group: [{
                                        title: '删除',
                                        event: function (rowc, index, ev, key, rthat) {
                                            var params = {
                                                path_id: config.pid,
                                                path: config.path,
                                                dirname: rowc.dir
                                            }
                                            bt.confirm({ title: '删除目录白名单', msg: typeof rowc.tip_msg != 'undefined'?rowc.tip_msg:'删除【' + rowc.dir + '】后，该目录下的所有文件将受到保护，是否继续操作？' }, function () {
                                                bt_tools.send({url:'/tamper_core/remove_white_dirs.json'}, params, function (rdata) {
                                                    bt_tools.msg(rdata);
                                                    if (rdata.status) {
                                                        directorysTable.$refresh_table_list()
                                                    }
                                                },'删除目录白名单')
                                            })
                                        }
                                    }]
                                }
                            ],
                            tootls: [{ // 按钮组
                                type: 'group',
                                positon: ['left', 'top'],
                                list: [{
                                    title: '添加',
                                    active: true,
                                    event: function (ev, that) {
                                        var dirname = $('input[name=dirname]').val()
                                        if(dirname == '') return layer.msg('请输入目录名', {icon:2})
                                        var params = {
                                            path_id: config.pid,
                                            path: config.path,
                                            dirname: dirname
                                        }
                                        bt_tools.send({url:'/tamper_core/add_white_dirs.json'}, params, function (rdata) {
                                            bt_tools.msg(rdata);
                                            if (rdata.status) {
                                                directorysTable.$refresh_table_list()
                                                $('input[name=dirname]').val('')
                                            }
                                        },'添加目录白名单')
                                    }
                                }]
                            }],
                            success: function () {
                                if($('input[name=dirname]').length == 0){
                                    $('#directorysWhite .tootls_top .pull-left .btn').before('<input type="text" name="dirname" placeholder="目录名" class="bt-input-text mr10 " value="">')
                                }
                            }
                        })
                        robj.append('<ul class="help-info-text mt10 pl7">\
                            <li>此处允许使用全路径或目录名或路径的一部分如：<code>/www/abc/cache/test/,test,cache/test/</code></li>\
                            <li>全路径首位必需为<code>/</code>，如：<code>/www/abc/cache/test/</code></li>\
                            <li>录名或路径的一部分首位不能是<code>/</code>，如：<code>cache/test/</code> 或 <code>test</code></li>\
                            示例：\
                            <li><code>/www/abc/</code> 匹配:<code>/www/abc/*</code>  不匹配：<code>/www/abc</code> <code>/www/abc123</code></li>\
                            <li><code>test</code> 匹配：<code>/www/test/1.txt</code> <code>/www/test_abc</code> 不匹配：<code>/www/1.php</code></li>\
                            <li><code>cache/test/</code> 匹配：<code>/www/cache/test/1.txt</code> <code>/cache/test/</code>不匹配：<code>/www/cache/test</code> <code>/cache/</code></li>\
                        </ul>')
                    }
                }
                var fileWhite = {
                    title:'文件白名单',
                    callback:function(robj){
                        robj.html('<div id="filesWhite" class="mt10"></div>')
                        directorysTable = bt_tools.table({
                            el: '#filesWhite',
                            url: '/tamper_core/get_tamper_paths.json',
                            height: '268.5',
                            load: true,
                            default: "暂无文件白名单",
                            dataFilter: function (res) {
                                var data1 = []
                                for (var i = 0; i < res.length; i++) {
                                    if (res[i].pid == config.pid) {
                                        var white_files = res[i].white_files
                                        for (var j = 0; j < white_files.length; j++) {
                                            data1.push({filename:white_files[j]})
                                        }
                                    }
                                }
                                return { data: data1 };
                            },
                            column: [
                                {
                                    fid: 'filename',
                                    title: '文件名',
                                    type: 'text',
                                },{
                                    title: '操作',
                                    type: 'group',
                                    width: '200px',
                                    align: 'right',
                                    group: [{
                                        title: '删除',
                                        event: function (rowc, index, ev, key, rthat) {
                                            var params = {
                                                path_id: config.pid,
                                                path: config.path,
                                                filename: rowc.filename
                                            }
                                            bt.confirm({ title: '删除文件白名单【' + rowc.filename + '】', msg: '删除该文件白名单后，该文件将受到保护，是否继续操作？' }, function () {
                                                bt_tools.send({url:'/tamper_core/remove_white_files.json'}, params, function (rdata) {
                                                    bt_tools.msg(rdata);
                                                    if (rdata.status) {
                                                        directorysTable.$refresh_table_list()
                                                    }
                                                },'删除文件白名单')
                                            })
                                        }
                                    }]
                                }
                            ],
                            tootls: [{ // 按钮组
                                type: 'group',
                                positon: ['left', 'top'],
                                list: [{
                                    title: '添加',
                                    active: true,
                                    event: function (ev, that) {
                                        var filename = $('input[name=filename]').val()
                                        if(filename == '') return layer.msg('请输入文件名', {icon:2})
                                        var params = {
                                            path_id: config.pid,
                                            path: config.path,
                                            filename: filename
                                        }
                                        bt_tools.send({url:'/tamper_core/add_white_files.json'}, params, function (rdata) {
                                            bt_tools.msg(rdata);
                                            if (rdata.status) {
                                                directorysTable.$refresh_table_list()
                                                $('input[name=filename]').val('')
                                            }
                                        },'添加文件白名单')
                                    }
                                }]
                            }],
                            success: function () {
                                if($('input[name=filename]').length == 0){
                                    $('#filesWhite .tootls_top .pull-left .btn').before('<input type="text" name="filename" placeholder="文件名" class="bt-input-text mr10 " value="">')
                                }
                            }
                        })
                        robj.append('<ul class="help-info-text mt10 pl7">\
                            <li>此处允许使用全路径或单一文件名如：<code>/test/index.php</code>,<code>index.php</code></li>\
                            <li>注意，只能是绝对路径或文件名不支持相对路径</li>\
                            示例：\
                            <li><code>index.php</code> 匹配：<code>./index.php</code> <code>./test/index.php</code>不匹配：<code>./abc_index.php</code> <code>./index.php/1.txt</code></li>\
                            <li><code>/test/index.php</code> 只匹配：<code>/test/index.php</code></li>\
                        </ul>')
                    }
                }
                var processWhite = {
                    title:'进程白名单',
                    callback:function(robj){
                        robj.html('<div id="processsWhite" class="mtb10"></div>')
                        processsWhiteTable = bt_tools.table({
                            el: '#processsWhite',
                            url: '/tamper_core/get_tamper_global_config.json',
                            height: '365',
                            load: true,
                            default: "暂无进程白名单",
                            dataFilter: function (res) {
                                var pnames = res.process_names,data1 = []
                                for (var i = 0; i < pnames.length; i++) {
                                    data1.push({name:pnames[i]})
                                }
                                return { data: data1 };
                            },
                            column: [
                                {
                                    fid: 'name',
                                    title: '进程名称',
                                    type: 'text',
                                },{
                                    title: '操作',
                                    type: 'group',
                                    width: '200px',
                                    align: 'right',
                                    group: [{
                                        title: '删除',
                                        event: function (rowc, index, ev, key, rthat) {
                                            bt.confirm({ title: '删除进程白名单', msg: '删除白名单进程【' + rowc.name + '】后，该进程将无法对保护目录文件进行操作，是否继续操作？' }, function () {
                                                bt_tools.send({url:'/tamper_core/remove_process_names.json'}, {pname:rowc.name}, function (rdata) {
                                                    bt_tools.msg(rdata);
                                                    if (rdata.status) {
                                                        processsWhiteTable.$refresh_table_list()
                                                    }
                                                },'删除进程白名单')
                                            })

                                        }
                                    }]
                                }
                            ],
                            tootls: [{ // 按钮组
                                type: 'group',
                                positon: ['left', 'top'],
                                list: [{
                                    title: '添加',
                                    active: true,
                                    event: function (ev, that) {
                                        var pname = $('input[name=pname]').val()
                                        if(pname == '') return layer.msg('请输入进程名称', {icon:2})
                                        bt_tools.send({url:'/tamper_core/add_process_names.json'}, {pname:pname}, function (rdata) {
                                            bt_tools.msg(rdata);
                                            if (rdata.status) {
                                                processsWhiteTable.$refresh_table_list()
                                                $('input[name=pname]').val('')
                                            }
                                        },'添加进程白名单')
                                    }
                                }]
                            }],
                            success: function () {
                                if($('input[name=pname]').length == 0){
                                    $('#processsWhite .tootls_top .pull-left .btn').before('<input type="text" name="pname" placeholder="进程名称" class="bt-input-text mr10 " value="">')
                                }
                            }
                        })
                        robj.append('<ul class="help-info-text mt10 pl7">\
                            <li>使用绝对进程名称，如<code>mysqld</code>、<code>php-fpm</code>、<code>nginx</code>、<code>pure-ftpd</code></li>\
                            <li>在白名单内的进程修改文件时不会被拦截</li>\
                        </ul>')
                    }
                }
                var userWhite = { 
                    title:'用户白名单',
                    callback:function(robj){
                        bt_tools.send({url:'/tamper_core/get_tamper_global_config.json'}, function (config) {
                            var uids = config.uids
                            robj.html('<div id="usersWhite"></div>')
                            usersWhiteTable = bt_tools.table({
                                el: '#usersWhite',
                                url: '/tamper_core/get_linux_uids.json',
                                height: '430px',
                                load: true,
                                default: "暂无用户白名单",
                                dataFilter: function (res) {
                                    for (var j = 0; j < res.length; j++) {
                                        if(config.uids.indexOf(parseInt(res[j].uid)) > -1 ){
                                            res[j]['sw'] = 1
                                        }else{
                                            res[j]['sw'] = undefined
                                        }
                                    }
                                    return { data: res };
                                },
                                column: [{
                                        fid: 'user',
                                        title: '用户',
                                        type: 'text',
                                    },{
                                        fid: 'ps',
                                        title: '描述',
                                        type: 'text',
                                    },{
                                        title: '状态',
                                        type: 'switch',
                                        fid: 'sw',
                                        width: '35px',
                                        align: 'right',
                                        event: function (rowc, index, ev, key, rthat) {
                                            var status_btn = $('#usersWhite tbody tr:eq('+index+') .btswitch-btn').siblings(),
                                                status = status_btn.prop('checked')
                                            var url = '', load = '', params = {
                                                uid: rowc.uid
                                            }
                                            if (status) {
                                                url = '/tamper_core/add_uids.json'
                                                load = '添加用户白名单'
                                            } else {
                                                url = '/tamper_core/remove_uids.json'
                                                load = '删除用户白名单'
                                            }
                                            layer.confirm(!status ? '关闭该用户白名单后，指定用户启动的所有进程修改文件时会被拦截，是否继续操作？' : '启用该用户白名单后，指定用户启动的所有进程修改文件时不会被拦截，是否继续操作？', {icon: 3, title: status ? '启用用户白名单【'+ rowc.user +'】' : '关闭用户白名单【'+ rowc.user +'】',closeBtn: 2,cancel: function () {
                                                status_btn.prop('checked',!status)
                                            }}, function (index) {
                                                layer.close(index);
                                                bt_tools.send({url:url},params, function (rdata) {
                                                    bt_tools.msg(rdata);
                                                },load)
                                            }, function () {
                                                status_btn.prop('checked',!status)
                                            });
                                        }
                                    }
                                ]
                            })
                            robj.append('<ul class="help-info-text mt10 pl7">\
                                <li>启用后，指定用户启动的所有进程修改文件时不会被拦截</li>\
                            </ul>')
                        })
                    }
                }
                var groupWhite = {
                    title:'用户组白名单',
                    callback:function(robj){
                        bt_tools.send({url:'/tamper_core/get_tamper_global_config.json'}, function (config) {
                            robj.html('<div id="groupsWhite"></div>')
                            groupsWhiteTable = bt_tools.table({
                                el: '#groupsWhite',
                                url: '/tamper_core/get_linux_gids.json',
                                height: '430px',
                                load: true,
                                default: "暂无用户组白名单",
                                dataFilter: function (res) {
                                    for (var j = 0; j < res.length; j++) {
                                        if(config.gids.indexOf(parseInt(res[j].gid)) > -1 ){
                                            res[j]['sw'] = 1
                                        }else{
                                            res[j]['sw'] = undefined
                                        }
                                    }
                                    return { data: res };
                                },
                                column: [{
                                        fid: 'group',
                                        title: '用户组',
                                        type: 'text',
                                    },{
                                        fid: 'ps',
                                        title: '描述',
                                        type: 'text',
                                    },{
                                        title: '状态',
                                        type: 'switch',
                                        fid: 'sw',
                                        width: '35px',
                                        align: 'right',
                                        event: function (rowc, index, ev, key, rthat) {
                                            var status_btn = $('#groupsWhite tbody tr:eq('+index+') .btswitch-btn').siblings(),
                                                status = status_btn.prop('checked')
                                            var url = '', load = '', params = {
                                                gid: rowc.gid
                                            }
                                            if (status) {
                                                url = '/tamper_core/add_gids.json'
                                                load = '添加用户组白名单'
                                            } else {
                                                url = '/tamper_core/remove_gids.json'
                                                load = '删除用户组白名单'
                                            }
                                            layer.confirm(!status ? '关闭该用户组白名单后，指定用户组下面的所有用户启动的进程修改文件时会被拦截，是否继续操作？' : '启用该用户组白名单后，指定用户组下面的所有用户启动的进程修改文件时不会被拦截，是否继续操作？', {icon: 3, title: status ? '启用用户组白名单【'+ rowc.group +'】' : '关闭用户组白名单【'+ rowc.group +'】',closeBtn: 2,cancel: function () {
                                                status_btn.prop('checked',!status)
                                            }}, function (index) {
                                                layer.close(index);
                                                bt_tools.send({url:url},params, function (rdata) {
                                                    bt_tools.msg(rdata);
                                                },load)
                                            }, function () {
                                                status_btn.prop('checked',!status)
                                            });
                                        }
                                    }
                                ]
                            })
                            robj.append('<ul class="help-info-text mt10 pl7">\
                                <li>启用后，指定用户组下面的所有用户启动的进程修改文件时不会被拦截</li>\
                            </ul>')
                        })
                    }
                }
                var _tab = [],
                    name = ''
                if (type == 2) {
                    _tab = [basicSet,processWhite,userWhite,groupWhite]
                    name = 'tabGlobalConfig'
                }else{
                    _tab = [basicSet,proFileSuf,directoryWhite,fileWhite],
                    name = 'tabTamperConfig'
                }
                bt.render_tab(name, _tab)
                $('#'+name+' span:eq(0)').click();
             },
        }
        tamper_core.init()
    })()
</script>